IDENTIFICATION DIVISION.
PROGRAM-ID. TYPE-UTIL.

ENVIRONMENT DIVISION.
REPOSITORY.
    COPY "TYPES".
    COPY "SCHEMA".
    COPY "NESTED-FIELD".
    COPY "IMMUTABLE-LIST".
    COPY "IMMUTABLE-MAP".
    COPY "IMMUTABLE-SET".
    COPY "ATOMIC-INTEGER".

DATA DIVISION.
WORKING-STORAGE SECTION.
01 HEADER-SIZE PIC 9(9) VALUE 12.
01 HIGHEST-FIELD-ID PIC 9(9) INITIAL 0.
01 MAX-PRECISION OCCURS 24 TIMES PIC 9(9).
01 REQUIRED-LENGTH OCCURS 40 TIMES PIC 9(9).

PROCEDURE DIVISION.

PROJECTING-FIELDS.
    PERFORM PROJECT-FIELDS.
    PERFORM SELECT-FIELDS.
    PERFORM GET-PROJECTED-IDS.
    PERFORM SELECT-NOT.
    PERFORM JOIN-SCHEMAS.

INDEXING-FIELDS.
    PERFORM INDEX-BY-NAME.
    PERFORM INDEX-NAME-BY-ID.
    PERFORM INDEX-QUOTED-NAME-BY-ID.
    PERFORM INDEX-BY-LOWER-CASE-NAME.
    PERFORM INDEX-BY-ID.
    PERFORM INDEX-PARENTS.

ASSIGNING-IDS.
    PERFORM ASSIGN-FRESH-IDS.
    PERFORM ASSIGN-IDS.

VALIDATING-SCHEMAS.
    PERFORM VALIDATE-WRITE-SCHEMA.
    PERFORM VALIDATE-SCHEMA.

ESTIMATING-SIZE.
    PERFORM ESTIMATE-SIZE.

OTHER-PROCEDURES.
    PERFORM REASSIGN-IDS.
    PERFORM REASSIGN-DOC.
    PERFORM REASSIGN-OR-REFRESH-IDS.
    PERFORM CHECK-PROMOTION-ALLOWED.

PROGRAM-EXIT.
    STOP RUN.

PROJECT-FIELDS.
    PROCEDURE DIVISION USING SCHEMA, FIELD-IDS
        RETURNING RESULT-SCHEMA.
    ...

SELECT-FIELDS.
    PROCEDURE DIVISION USING STRUCT, FIELD-IDS
        RETURNING RESULT-STRUCT.
    ...

GET-PROJECTED-IDS.
    PROCEDURE DIVISION USING TYPE, INCLUDE-STRUCT-IDS
        RETURNING PROJECTED-IDS.
    ...

SELECT-NOT.
    PROCEDURE DIVISION USING STRUCT, FIELD-IDS
        RETURNING RESULT-STRUCT.
    ...

JOIN-SCHEMAS.
    PROCEDURE DIVISION USING LEFT-SCHEMA, RIGHT-SCHEMA
        RETURNING JOINED-SCHEMA.
    ...

INDEX-BY-NAME.
    PROCEDURE DIVISION USING STRUCT
        RETURNING INDEX-BY-NAME, INDEX-BY-ID.
    ...

INDEX-NAME-BY-ID.
    PROCEDURE DIVISION USING STRUCT
        RETURNING INDEX-BY-ID.
    ...

INDEX-QUOTED-NAME-BY-ID.
    PROCEDURE DIVISION USING STRUCT, QUOTING-FUNC
        RETURNING INDEX-BY-ID.
    ...

INDEX-BY-LOWER-CASE-NAME.
    PROCEDURE DIVISION USING STRUCT
        RETURNING INDEX-BY-LOWER-CASE-NAME.
    ...

INDEX-BY-ID.
    PROCEDURE DIVISION USING STRUCT
        RETURNING INDEX-BY-ID.
    ...

INDEX-PARENTS.
    PROCEDURE DIVISION USING STRUCT
        RETURNING INDEX-PARENTS.
    ...

ASSIGN-FRESH-IDS.
    PROCEDURE DIVISION USING TYPE, NEXT-ID
        RETURNING RESULT-TYPE.
    ...

ASSIGN-FRESH-IDS.
    PROCEDURE DIVISION USING SCHEMA, NEXT-ID
        RETURNING RESULT-SCHEMA.
    ...

ASSIGN-FRESH-IDS.
    PROCEDURE DIVISION USING SCHEMA-ID, SCHEMA, NEXT-ID
        RETURNING RESULT-SCHEMA.
    ...

ASSIGN-FRESH-IDS.
    PROCEDURE DIVISION USING SCHEMA, BASE-SCHEMA, NEXT-ID
        RETURNING RESULT-SCHEMA.
    ...

ASSIGN-IDS.
    PROCEDURE DIVISION USING TYPE, GET-ID
        RETURNING RESULT-TYPE.
    ...

VALIDATE-WRITE-SCHEMA.
    PROCEDURE DIVISION USING TABLE-SCHEMA, WRITE-SCHEMA, CHECK-NULLABILITY, CHECK-ORDERING.
    ...

VALIDATE-SCHEMA.
    PROCEDURE DIVISION USING CONTEXT, EXPECTED-SCHEMA, PROVIDED-SCHEMA, CHECK-NULLABILITY, CHECK-ORDERING.
    ...

ESTIMATE-SIZE.
    PROCEDURE DIVISION USING FIELD
        RETURNING ESTIMATED-SIZE.
    ...

REASSIGN-IDS.
    PROCEDURE DIVISION USING SCHEMA, ID-SOURCE-SCHEMA, CASE-SENSITIVE
        RETURNING RESULT-SCHEMA.
    ...

REASSIGN-DOC.
    PROCEDURE DIVISION USING SCHEMA, DOC-SOURCE-SCHEMA
        RETURNING RESULT-SCHEMA.
    ...

REASSIGN-OR-REFRESH-IDS.
    PROCEDURE DIVISION USING SCHEMA, ID-SOURCE-SCHEMA, CASE-SENSITIVE
        RETURNING RESULT-SCHEMA.
    ...

CHECK-PROMOTION-ALLOWED.
    PROCEDURE DIVISION USING FROM-TYPE, TO-TYPE
        RETURNING PROMOTION-ALLOWED.
    ...

COPY "TYPES".
COPY "SCHEMA".
COPY "NESTED-FIELD".
COPY "IMMUTABLE-LIST".
COPY "IMMUTABLE-MAP".
COPY "IMMUTABLE-SET".
COPY "ATOMIC-INTEGER".
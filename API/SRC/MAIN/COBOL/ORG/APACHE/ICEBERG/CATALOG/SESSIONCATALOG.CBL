IDENTIFICATION DIVISION.
PROGRAM-ID. SESSION-CATALOG.

ENVIRONMENT DIVISION.
REPOSITORY.
    COPY "ICEBERG-SCHEMAS.cpy".

DATA DIVISION.
WORKING-STORAGE SECTION.
01 WS-SESSION-CONTEXT.
   03 WS-SESSION-ID PIC X(36).
   03 WS-IDENTITY PIC X(50).
   03 WS-CREDENTIALS.
      05 WS-CREDENTIAL-COUNT PIC 9(3) COMP.
      05 WS-CREDENTIAL-ITEM OCCURS 0 TO 999 TIMES
         DEPENDING ON WS-CREDENTIAL-COUNT.
         07 WS-CREDENTIAL-KEY PIC X(50).
         07 WS-CREDENTIAL-VALUE PIC X(100).
   03 WS-PROPERTIES.
      05 WS-PROPERTY-COUNT PIC 9(3) COMP.
      05 WS-PROPERTY-ITEM OCCURS 0 TO 999 TIMES
         DEPENDING ON WS-PROPERTY-COUNT.
         07 WS-PROPERTY-KEY PIC X(50).
         07 WS-PROPERTY-VALUE PIC X(100).
   03 WS-WRAPPED-IDENTITY PIC X(50).

PROCEDURE DIVISION.

    INITIALIZE-CATALOG.
        MOVE FUNCTION RANDOM-UUID TO WS-SESSION-ID.
        MOVE SPACES TO WS-IDENTITY, WS-WRAPPED-IDENTITY.
        INITIALIZE WS-CREDENTIALS, WS-PROPERTIES.

    INITIALIZE.
        MOVE FUNCTION RANDOM-UUID TO WS-SESSION-ID.
        MOVE FUNCTION UPPER-CASE(FUNCTION TRIM(FUNCTION SUBSTITUTE(FUNCTION TRIM(name), ' ', ''))) TO WS-CATALOG-NAME.
        MOVE FUNCTION TRIM(properties) TO WS-CATALOG-PROPERTIES.

    NAME.
        RETURN WS-CATALOG-NAME.

    PROPERTIES.
        RETURN WS-CATALOG-PROPERTIES.

    LIST-TABLES.
        PERFORM VARYING IDENT-INDEX FROM 1 BY 1 UNTIL IDENT-INDEX > WS-TABLE-COUNT
            MOVE WS-TABLE-IDENT(IDENT-INDEX) TO RETURN-TABLE-IDENT
        END-PERFORM.

    BUILD-TABLE.
        MOVE FUNCTION TRIM(schema) TO WS-TABLE-SCHEMA.
        MOVE FUNCTION TRIM(context.sessionId) TO WS-TABLE-SESSION-ID.
        MOVE FUNCTION TRIM(ident) TO WS-TABLE-IDENT.
        PERFORM CREATE-TABLE.

    REGISTER-TABLE.
        MOVE FUNCTION TRIM(metadataFileLocation) TO WS-TABLE-METADATA-LOCATION.
        MOVE FUNCTION TRIM(context.sessionId) TO WS-TABLE-SESSION-ID.
        MOVE FUNCTION TRIM(ident) TO WS-TABLE-IDENT.
        PERFORM REGISTER-TABLE.

    TABLE-EXISTS.
        PERFORM LOAD-TABLE
        IF RETURN-TABLE IS NOT NULL
            RETURN TRUE
        ELSE
            RETURN FALSE.

    LOAD-TABLE.
        MOVE FUNCTION TRIM(context.sessionId) TO WS-TABLE-SESSION-ID.
        MOVE FUNCTION TRIM(ident) TO WS-TABLE-IDENT.
        PERFORM LOAD-TABLE.

    DROP-TABLE.
        MOVE FUNCTION TRIM(context.sessionId) TO WS-TABLE-SESSION-ID.
        MOVE FUNCTION TRIM(ident) TO WS-TABLE-IDENT.
        PERFORM DROP-TABLE.

    PURGE-TABLE.
        MOVE FUNCTION TRIM(context.sessionId) TO WS-TABLE-SESSION-ID.
        MOVE FUNCTION TRIM(ident) TO WS-TABLE-IDENT.
        PERFORM PURGE-TABLE.

    RENAME-TABLE.
        MOVE FUNCTION TRIM(context.sessionId) TO WS-TABLE-SESSION-ID.
        MOVE FUNCTION TRIM(from) TO WS-TABLE-IDENT-FROM.
        MOVE FUNCTION TRIM(to) TO WS-TABLE-IDENT-TO.
        PERFORM RENAME-TABLE.

    INVALIDATE-TABLE.
        MOVE FUNCTION TRIM(context.sessionId) TO WS-TABLE-SESSION-ID.
        MOVE FUNCTION TRIM(ident) TO WS-TABLE-IDENT.
        PERFORM INVALIDATE-TABLE.

    CREATE-NAMESPACE.
        MOVE FUNCTION TRIM(context.sessionId) TO WS-NAMESPACE-SESSION-ID.
        MOVE FUNCTION TRIM(namespace) TO WS-NAMESPACE.
        MOVE FUNCTION TRIM(metadata) TO WS-NAMESPACE-METADATA.
        PERFORM CREATE-NAMESPACE.

    LIST-NAMESPACES.
        MOVE FUNCTION TRIM(context.sessionId) TO WS-NAMESPACE-SESSION-ID.
        MOVE FUNCTION TRIM(namespace) TO WS-NAMESPACE.
        PERFORM LIST-NAMESPACES.

    LOAD-NAMESPACE-METADATA.
        MOVE FUNCTION TRIM(context.sessionId) TO WS-NAMESPACE-SESSION-ID.
        MOVE FUNCTION TRIM(namespace) TO WS-NAMESPACE.
        PERFORM LOAD-NAMESPACE-METADATA.

    DROP-NAMESPACE.
        MOVE FUNCTION TRIM(context.sessionId) TO WS-NAMESPACE-SESSION-ID.
        MOVE FUNCTION TRIM(namespace) TO WS-NAMESPACE.
        PERFORM DROP-NAMESPACE.

    UPDATE-NAMESPACE-METADATA.
        MOVE FUNCTION TRIM(context.sessionId) TO WS-NAMESPACE-SESSION-ID.
        MOVE FUNCTION TRIM(namespace) TO WS-NAMESPACE.
        MOVE FUNCTION TRIM(updates) TO WS-NAMESPACE-UPDATES.
        MOVE FUNCTION TRIM(removals) TO WS-NAMESPACE-REMOVALS.
        PERFORM UPDATE-NAMESPACE-METADATA.

    NAMESPACE-EXISTS.
        MOVE FUNCTION TRIM(context.sessionId) TO WS-NAMESPACE-SESSION-ID.
        MOVE FUNCTION TRIM(namespace) TO WS-NAMESPACE.
        PERFORM LOAD-NAMESPACE-METADATA
        IF RETURN-NAMESPACE-METADATA IS NOT NULL
            RETURN TRUE
        ELSE
            RETURN FALSE.

COPY "ICEBERG-CATALOG-PROCEDURES.cpy".
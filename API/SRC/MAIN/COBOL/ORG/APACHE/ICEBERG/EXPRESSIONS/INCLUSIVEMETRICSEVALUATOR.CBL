IDENTIFICATION DIVISION.
PROGRAM-ID. INCLUSIVE-METRICS-EVALUATOR.

ENVIRONMENT DIVISION.
SPECIAL-NAMES.
    DECIMAL-POINT IS COMMA.

DATA DIVISION.
WORKING-STORAGE SECTION.
01 WS-ROWS-MIGHT-MATCH      PIC X     VALUE 'T'.
01 WS-ROWS-CANNOT-MATCH     PIC X     VALUE 'F'.

01 WS-VALUE-COUNTS          PIC X(10).
01 WS-NULL-COUNTS           PIC X(10).
01 WS-NAN-COUNTS            PIC X(10).
01 WS-LOWER-BOUNDS          PIC X(10).
01 WS-UPPER-BOUNDS          PIC X(10).

01 WS-IN-PREDICATE-LIMIT    PIC 9(3)  VALUE 200.

PROCEDURE DIVISION.

    MOVE FUNCTION TRIM(FUNCTION REPLACE(SOURCE-CHAR: 'org.apache.iceberg.expressions.InclusiveMetricsEvaluator', 'org.apache.iceberg.expressions.', '')) TO PROGRAM-ID.

    PERFORM EVALUATE-EXPRESSION.

    STOP RUN.

EVALUATE-EXPRESSION SECTION.
    PERFORM INITIALIZE-VISITOR.
    PERFORM EVALUATE-FILE.

INITIALIZE-VISITOR SECTION.
    MOVE SPACES TO WS-VALUE-COUNTS.
    MOVE SPACES TO WS-NULL-COUNTS.
    MOVE SPACES TO WS-NAN-COUNTS.
    MOVE SPACES TO WS-LOWER-BOUNDS.
    MOVE SPACES TO WS-UPPER-BOUNDS.

EVALUATE-FILE SECTION.
    IF RECORD-COUNT OF CONTENT-FILE = 0
        MOVE WS-ROWS-CANNOT-MATCH TO RETURN-CODE
        EXIT SECTION
    END-IF.

    IF RECORD-COUNT OF CONTENT-FILE < 0
        MOVE WS-ROWS-MIGHT-MATCH TO RETURN-CODE
        EXIT SECTION
    END-IF.

    MOVE VALUE-COUNTS OF CONTENT-FILE TO WS-VALUE-COUNTS.
    MOVE NULL-VALUE-COUNTS OF CONTENT-FILE TO WS-NULL-COUNTS.
    MOVE NAN-VALUE-COUNTS OF CONTENT-FILE TO WS-NAN-COUNTS.
    MOVE LOWER-BOUNDS OF CONTENT-FILE TO WS-LOWER-BOUNDS.
    MOVE UPPER-BOUNDS OF CONTENT-FILE TO WS-UPPER-BOUNDS.

    PERFORM EVALUATE-TERM THRU EVALUATE-TERM-EXIT.

EVALUATE-TERM SECTION.
    EVALUATE EXPRESSION-TYPE
        WHEN 'ALWAYS-TRUE'
            MOVE WS-ROWS-MIGHT-MATCH TO RETURN-CODE
            GO TO EVALUATE-TERM-EXIT
        WHEN 'ALWAYS-FALSE'
            MOVE WS-ROWS-CANNOT-MATCH TO RETURN-CODE
            GO TO EVALUATE-TERM-EXIT
        WHEN 'NOT'
            PERFORM NEGATE-RESULT
            GO TO EVALUATE-TERM-EXIT
        WHEN 'AND'
            PERFORM EVALUATE-TERM
            PERFORM EVALUATE-TERM
            PERFORM COMBINE-RESULTS
            GO TO EVALUATE-TERM-EXIT
        WHEN 'OR'
            PERFORM EVALUATE-TERM
            PERFORM EVALUATE-TERM
            PERFORM COMBINE-RESULTS-OR
            GO TO EVALUATE-TERM-EXIT
        WHEN 'IS-NULL'
            PERFORM EVALUATE-IS-NULL
            GO TO EVALUATE-TERM-EXIT
        WHEN 'NOT-NULL'
            PERFORM EVALUATE-NOT-NULL
            GO TO EVALUATE-TERM-EXIT
        WHEN 'IS-NAN'
            PERFORM EVALUATE-IS-NAN
            GO TO EVALUATE-TERM-EXIT
        WHEN 'NOT-NAN'
            PERFORM EVALUATE-NOT-NAN
            GO TO EVALUATE-TERM-EXIT
        WHEN 'LT'
            PERFORM EVALUATE-LT
            GO TO EVALUATE-TERM-EXIT
        WHEN 'LE'
            PERFORM EVALUATE-LE
            GO TO EVALUATE-TERM-EXIT
        WHEN 'GT'
            PERFORM EVALUATE-GT
            GO TO EVALUATE-TERM-EXIT
        WHEN 'GE'
            PERFORM EVALUATE-GE
            GO TO EVALUATE-TERM-EXIT
        WHEN 'EQ'
            PERFORM EVALUATE-EQ
            GO TO EVALUATE-TERM-EXIT
        WHEN 'NEQ'
            PERFORM EVALUATE-NEQ
            GO TO EVALUATE-TERM-EXIT
        WHEN 'IN'
            PERFORM EVALUATE-IN
            GO TO EVALUATE-TERM-EXIT
        WHEN 'NOT-IN'
            PERFORM EVALUATE-NOT-IN
            GO TO EVALUATE-TERM-EXIT
        WHEN 'STARTS-WITH'
            PERFORM EVALUATE-STARTS-WITH
            GO TO EVALUATE-TERM-EXIT
        WHEN 'NOT-STARTS-WITH'
            PERFORM EVALUATE-NOT-STARTS-WITH
            GO TO EVALUATE-TERM-EXIT
    END-EVALUATE.

EVALUATE-TERM-EXIT.
    EXIT.

NEGATE-RESULT SECTION.
    IF RETURN-CODE = WS-ROWS-MIGHT-MATCH
        MOVE WS-ROWS-CANNOT-MATCH TO RETURN-CODE
    ELSE
        MOVE WS-ROWS-MIGHT-MATCH TO RETURN-CODE
    END-IF.
    EXIT.

COMBINE-RESULTS SECTION.
    IF RETURN-CODE = WS-ROWS-CANNOT-MATCH OR SECOND-RETURN-CODE = WS-ROWS-CANNOT-MATCH
        MOVE WS-ROWS-CANNOT-MATCH TO RETURN-CODE
    ELSE
        MOVE WS-ROWS-MIGHT-MATCH TO RETURN-CODE
    END-IF.
    EXIT.

COMBINE-RESULTS-OR SECTION.
    IF RETURN-CODE = WS-ROWS-MIGHT-MATCH OR SECOND-RETURN-CODE = WS-ROWS-MIGHT-MATCH
        MOVE WS-ROWS-MIGHT-MATCH TO RETURN-CODE
    ELSE
        MOVE WS-ROWS-CANNOT-MATCH TO RETURN-CODE
    END-IF.
    EXIT.

EVALUATE-IS-NULL SECTION.
    IF IS-NON-NULL-PRESERVING(TERM)
        IF NOT MAY-CONTAIN-NULL(FIELD-ID)
            MOVE WS-ROWS-CANNOT-MATCH TO RETURN-CODE
            EXIT SECTION
        END-IF
    END-IF.
    MOVE WS-ROWS-MIGHT-MATCH TO RETURN-CODE.
    EXIT.

EVALUATE-NOT-NULL SECTION.
    IF CONTAINS-NULLS-ONLY(FIELD-ID)
        MOVE WS-ROWS-CANNOT-MATCH TO RETURN-CODE
    ELSE
        MOVE WS-ROWS-MIGHT-MATCH TO RETURN-CODE
    END-IF.
    EXIT.

EVALUATE-IS-NAN SECTION.
    IF CONTAINS-NULLS-ONLY(FIELD-ID)
        MOVE WS-ROWS-CANNOT-MATCH TO RETURN-CODE
        EXIT SECTION
    END-IF.

    IF TERM-TYPE = 'BOUND-REFERENCE'
        IF WS-NAN-COUNTS NOT NUMERIC OR WS-NAN-COUNTS = '0'
            MOVE WS-ROWS-CANNOT-MATCH TO RETURN-CODE
            EXIT SECTION
        END-IF
    ELSE
        MOVE WS-ROWS-MIGHT-MATCH TO RETURN-CODE
        EXIT SECTION
    END-IF.

    MOVE WS-ROWS-MIGHT-MATCH TO RETURN-CODE.
    EXIT.

EVALUATE-NOT-NAN SECTION.
    IF CONTAINS-NANS-ONLY(FIELD-ID)
        MOVE WS-ROWS-CANNOT-MATCH TO RETURN-CODE
    ELSE
        MOVE WS-ROWS-MIGHT-MATCH TO RETURN-CODE
    END-IF.
    EXIT.

EVALUATE-LT SECTION.
    IF CONTAINS-NULLS-ONLY(FIELD-ID) OR CONTAINS-NANS-ONLY(FIELD-ID)
        MOVE WS-ROWS-CANNOT-MATCH TO RETURN-CODE
        EXIT SECTION
    END-IF.

    MOVE LOWER-BOUND(TERM) TO TEMP-VALUE.
    IF TEMP-VALUE IS NULL OR FUNCTION NAN(TEMP-VALUE)
        MOVE WS-ROWS-MIGHT-MATCH TO RETURN-CODE
        EXIT SECTION
    END-IF.

    IF FUNCTION COMPARE(TEMP-VALUE, LITERAL-VALUE) >= 0
        MOVE WS-ROWS-CANNOT-MATCH TO RETURN-CODE
    ELSE
        MOVE WS-ROWS-MIGHT-MATCH TO RETURN-CODE
    END-IF.
    EXIT.

EVALUATE-LE SECTION.
    IF CONTAINS-NULLS-ONLY(FIELD-ID) OR CONTAINS-NANS-ONLY(FIELD-ID)
        MOVE WS-ROWS-CANNOT-MATCH TO RETURN-CODE
        EXIT SECTION
    END-IF.

    MOVE LOWER-BOUND(TERM) TO TEMP-VALUE.
    IF TEMP-VALUE IS NULL OR FUNCTION NAN(TEMP-VALUE)
        MOVE WS-ROWS-MIGHT-MATCH TO RETURN-CODE
        EXIT SECTION
    END-IF.

    IF FUNCTION COMPARE(TEMP-VALUE, LITERAL-VALUE) > 0
        MOVE WS-ROWS-CANNOT-MATCH TO RETURN-CODE
    ELSE
        MOVE WS-ROWS-MIGHT-MATCH TO RETURN-CODE
    END-IF.
    EXIT.

EVALUATE-GT SECTION.
    IF CONTAINS-NULLS-ONLY(FIELD-ID) OR CONTAINS-NANS-ONLY(FIELD-ID)
        MOVE WS-ROWS-CANNOT-MATCH TO RETURN-CODE
        EXIT SECTION
    END-IF.

    MOVE UPPER-BOUND(TERM) TO TEMP-VALUE.
    IF TEMP-VALUE IS NULL
        MOVE WS-ROWS-MIGHT-MATCH TO RETURN-CODE
        EXIT SECTION
    END-IF.

    IF FUNCTION COMPARE(TEMP-VALUE, LITERAL-VALUE) <= 0
        MOVE WS-ROWS-CANNOT-MATCH TO RETURN-CODE
    ELSE
        MOVE WS-ROWS-MIGHT-MATCH TO RETURN-CODE
    END-IF.
    EXIT.

EVALUATE-GE SECTION.
    IF CONTAINS-NULLS-ONLY(FIELD-ID) OR CONTAINS-NANS-ONLY(FIELD-ID)
        MOVE WS-ROWS-CANNOT-MATCH TO RETURN-CODE
        EXIT SECTION
    END-IF.

    MOVE UPPER-BOUND(TERM) TO TEMP-VALUE.
    IF TEMP-VALUE IS NULL
        MOVE WS-ROWS-MIGHT-MATCH TO RETURN-CODE
        EXIT SECTION
    END-IF.

    IF FUNCTION COMPARE(TEMP-VALUE, LITERAL-VALUE) < 0
        MOVE WS-ROWS-CANNOT-MATCH TO RETURN-CODE
    ELSE
        MOVE WS-ROWS-MIGHT-MATCH TO RETURN-CODE
    END-IF.
    EXIT.

EVALUATE-EQ SECTION.
    IF CONTAINS-NULLS-ONLY(FIELD-ID) OR CONTAINS-NANS-ONLY(FIELD-ID)
        MOVE WS-ROWS-CANNOT-MATCH TO RETURN-CODE
        EXIT SECTION
    END-IF.

    MOVE LOWER-BOUND(TERM) TO TEMP-VALUE.
    IF TEMP-VALUE NOT NULL AND NOT FUNCTION NAN(TEMP-VALUE)
        IF FUNCTION COMPARE(TEMP-VALUE, LITERAL-VALUE) > 0
            MOVE WS-ROWS-CANNOT-MATCH TO RETURN-CODE
            EXIT SECTION
        END-IF
    END-IF.

    MOVE UPPER-BOUND(TERM) TO TEMP-VALUE.
    IF TEMP-VALUE IS NULL
        MOVE WS-ROWS-MIGHT-MATCH TO RETURN-CODE
    ELSE
        IF FUNCTION COMPARE(TEMP-VALUE, LITERAL-VALUE) < 0
            MOVE WS-ROWS-CANNOT-MATCH TO RETURN-CODE
        ELSE
            MOVE WS-ROWS-MIGHT-MATCH TO RETURN-CODE
        END-IF
    END-IF.
    EXIT.

EVALUATE-NEQ SECTION.
    MOVE WS-ROWS-MIGHT-MATCH TO RETURN-CODE.
    EXIT.

EVALUATE-IN SECTION.
    IF CONTAINS-NULLS-ONLY(FIELD-ID) OR CONTAINS-NANS-ONLY(FIELD-ID)
        MOVE WS-ROWS-CANNOT-MATCH TO RETURN-CODE
        EXIT SECTION
    END-IF.

    IF LENGTH OF LITERAL-SET > WS-IN-PREDICATE-LIMIT
        MOVE WS-ROWS-MIGHT-MATCH TO RETURN-CODE
        EXIT SECTION
    END-IF.

    MOVE LOWER-BOUND(TERM) TO TEMP-VALUE.
    IF TEMP-VALUE IS NULL OR FUNCTION NAN(TEMP-VALUE)
        MOVE WS-ROWS-MIGHT-MATCH TO RETURN-CODE
        EXIT SECTION
    END-IF.

    PERFORM VARYING LITERAL-VALUE IN LITERAL-SET
        UNTIL LITERAL-VALUE NOT LESS THAN TEMP-VALUE
    END-PERFORM.
    IF LITERAL-VALUE = SPACE
        MOVE WS-ROWS-CANNOT-MATCH TO RETURN-CODE
        EXIT SECTION
    END-IF.

    MOVE UPPER-BOUND(TERM) TO TEMP-VALUE.
    IF TEMP-VALUE IS NULL
        MOVE WS-ROWS-MIGHT-MATCH TO RETURN-CODE
        EXIT SECTION
    END-IF.

    PERFORM VARYING LITERAL-VALUE IN LITERAL-SET
        UNTIL LITERAL-VALUE NOT GREATER THAN TEMP-VALUE
    END-PERFORM.
    IF LITERAL-VALUE = SPACE
        MOVE WS-ROWS-CANNOT-MATCH TO RETURN-CODE
    ELSE
        MOVE WS-ROWS-MIGHT-MATCH TO RETURN-CODE
    END-IF.
    EXIT.

EVALUATE-NOT-IN SECTION.
    MOVE WS-ROWS-MIGHT-MATCH TO RETURN-CODE.
    EXIT.

EVALUATE-STARTS-WITH SECTION.
    IF CONTAINS-NULLS-ONLY(FIELD-ID)
        MOVE WS-ROWS-CANNOT-MATCH TO RETURN-CODE
        EXIT SECTION
    END-IF.

    MOVE LOWER-BOUND(TERM) TO TEMP-VALUE.
    IF TEMP-VALUE IS NULL
        MOVE WS-ROWS-MIGHT-MATCH TO RETURN-CODE
        EXIT SECTION
    END-IF.

    MOVE LITERAL-VALUE TO LITERAL-PREFIX.
    IF FUNCTION LENGTH(TEMP-VALUE) < FUNCTION LENGTH(LITERAL-PREFIX)
        OR FUNCTION COMPARE(TEMP-VALUE(1:FUNCTION LENGTH(LITERAL-PREFIX)), LITERAL-PREFIX) > 0
        MOVE WS-ROWS-CANNOT-MATCH TO RETURN-CODE
        EXIT SECTION
    END-IF.

    MOVE UPPER-BOUND(TERM) TO TEMP-VALUE.
    IF TEMP-VALUE IS NULL
        MOVE WS-ROWS-MIGHT-MATCH TO RETURN-CODE
        EXIT SECTION
    END-IF.

    IF FUNCTION LENGTH(TEMP-VALUE) < FUNCTION LENGTH(LITERAL-PREFIX)
        OR FUNCTION COMPARE(TEMP-VALUE(1:FUNCTION LENGTH(LITERAL-PREFIX)), LITERAL-PREFIX) < 0
        MOVE WS-ROWS-
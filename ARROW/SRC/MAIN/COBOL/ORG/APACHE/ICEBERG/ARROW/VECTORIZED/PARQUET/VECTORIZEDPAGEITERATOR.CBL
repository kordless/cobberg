IDENTIFICATION DIVISION.
PROGRAM-ID. VECTORIZED-PAGE-ITERATOR.

ENVIRONMENT DIVISION.
REPOSITORY.
    COPY PARQUET-UTIL.

DATA DIVISION.
WORKING-STORAGE SECTION.
01 SET-ARROW-VALIDITY-VECTOR PIC X.
01 PLAIN-VALUES-READER PIC X.
01 DICTIONARY-ENCODED-VALUES-READER PIC X.
01 ALL-PAGES-DICT-ENCODED PIC X.
01 VECTORIZED-DEFINITION-LEVEL-READER PIC X.

01 DICTIONARY-DECODE-MODE.
   88 NONE VALUE 0.
   88 LAZY VALUE 1.
   88 EAGER VALUE 2.

PROCEDURE DIVISION.
MAIN-PROCEDURE.
    PERFORM RESET-PROCEDURE.
    PERFORM INIT-DATA-READER-PROCEDURE.
    PERFORM INIT-DEFINITION-LEVELS-READER-PROCEDURE.
    PERFORM NEXT-BATCH-DICTIONARY-IDS-PROCEDURE.
    PERFORM GET-ACTUAL-BATCH-SIZE-PROCEDURE.
    PERFORM INT-PAGE-READER-PROCEDURE.
    PERFORM LONG-PAGE-READER-PROCEDURE.
    PERFORM TIMESTAMP-MILLIS-PAGE-READER-PROCEDURE.
    PERFORM TIMESTAMP-INT96-PAGE-READER-PROCEDURE.
    PERFORM FLOAT-PAGE-READER-PROCEDURE.
    PERFORM DOUBLE-PAGE-READER-PROCEDURE.
    PERFORM FIXED-SIZE-BINARY-PAGE-READER-PROCEDURE.
    PERFORM VAR-WIDTH-TYPE-PAGE-READER-PROCEDURE.
    PERFORM BOOLEAN-PAGE-READER-PROCEDURE.

RESET-PROCEDURE.
    PERFORM SUPER-RESET.
    MOVE NULL TO PLAIN-VALUES-READER.
    MOVE NULL TO VECTORIZED-DEFINITION-LEVEL-READER.

INIT-DATA-READER-PROCEDURE.
    MOVE NULL TO DICTIONARY-ENCODED-VALUES-READER.
    IF DICTIONARY-ENCODING
        IF DICTIONARY IS NULL
            RAISE PARQUET-DECODING-EXCEPTION
        END-IF
        INITIALIZE DICTIONARY-ENCODED-VALUES-READER
        DEPENDING ON PARQUET-UTIL-IS-INT-TYPE(PRIMITIVE-TYPE)
        OR NOT ALL-PAGES-DICT-ENCODED
    ELSE
        IF DATA-ENCODING NOT = PLAIN-ENCODING
            RAISE UNSUPPORTED-OPERATION-EXCEPTION
        END-IF
        INITIALIZE PLAIN-VALUES-READER
    END-IF.
    MOVE DICTIONARY-DECODE-MODE TO DEPENDING ON DATA-ENCODING.

INIT-DEFINITION-LEVELS-READER-PROCEDURE.
    COMPUTE BIT-WIDTH FROM MAX-DEFINITION-LEVEL.
    INITIALIZE VECTORIZED-DEFINITION-LEVEL-READER
        USING BIT-WIDTH, MAX-DEFINITION-LEVEL, SET-ARROW-VALIDITY-VECTOR.

NEXT-BATCH-DICTIONARY-IDS-PROCEDURE.
    MOVE VECTORIZED-DEFINITION-LEVEL-READER-DICTIONARY-ID-READER TO DICTIONARY-ID-READER.
    CALL DICTIONARY-ID-READER USING DICTIONARY-VECTOR,
                                   NUM-VALS-IN-VECTOR,
                                   -1,
                                   ACTUAL-BATCH-SIZE,
                                   NULLABILITY-HOLDER,
                                   DICTIONARY-ENCODED-VALUES-READER,
                                   NULL.
    ADD ACTUAL-BATCH-SIZE TO TUPLES-READ.
    MOVE LESS-THAN-TUPLES-COUNT TO HAS-NEXT.

INT-PAGE-READER-PROCEDURE.
    MOVE VECTORIZED-DEFINITION-LEVEL-READER-INTEGER-READER TO INTEGER-READER.
    PERFORM NEXT-BATCH-PROCEDURE USING INTEGER-READER,
                                      VECTOR,
                                      NUM-VALS-IN-VECTOR,
                                      TYPE-WIDTH,
                                      NULLABILITY-HOLDER.

LONG-PAGE-READER-PROCEDURE.
    MOVE VECTORIZED-DEFINITION-LEVEL-READER-LONG-READER TO LONG-READER.
    PERFORM NEXT-BATCH-PROCEDURE USING LONG-READER,
                                      VECTOR,
                                      NUM-VALS-IN-VECTOR,
                                      TYPE-WIDTH,
                                      NULLABILITY-HOLDER.

TIMESTAMP-MILLIS-PAGE-READER-PROCEDURE.
    MOVE VECTORIZED-DEFINITION-LEVEL-READER-TIMESTAMP-MILLIS-READER TO TIMESTAMP-MILLIS-READER.
    PERFORM NEXT-BATCH-PROCEDURE USING TIMESTAMP-MILLIS-READER,
                                      VECTOR,
                                      NUM-VALS-IN-VECTOR,
                                      TYPE-WIDTH,
                                      NULLABILITY-HOLDER.

TIMESTAMP-INT96-PAGE-READER-PROCEDURE.
    MOVE VECTORIZED-DEFINITION-LEVEL-READER-TIMESTAMP-INT96-READER TO TIMESTAMP-INT96-READER.
    PERFORM NEXT-BATCH-PROCEDURE USING TIMESTAMP-INT96-READER,
                                      VECTOR,
                                      NUM-VALS-IN-VECTOR,
                                      TYPE-WIDTH,
                                      NULLABILITY-HOLDER.

FLOAT-PAGE-READER-PROCEDURE.
    MOVE VECTORIZED-DEFINITION-LEVEL-READER-FLOAT-READER TO FLOAT-READER.
    PERFORM NEXT-BATCH-PROCEDURE USING FLOAT-READER,
                                      VECTOR,
                                      NUM-VALS-IN-VECTOR,
                                      TYPE-WIDTH,
                                      NULLABILITY-HOLDER.

DOUBLE-PAGE-READER-PROCEDURE.
    MOVE VECTORIZED-DEFINITION-LEVEL-READER-DOUBLE-READER TO DOUBLE-READER.
    PERFORM NEXT-BATCH-PROCEDURE USING DOUBLE-READER,
                                      VECTOR,
                                      NUM-VALS-IN-VECTOR,
                                      TYPE-WIDTH,
                                      NULLABILITY-HOLDER.

FIXED-SIZE-BINARY-PAGE-READER-PROCEDURE.
    MOVE VECTORIZED-DEFINITION-LEVEL-READER-FIXED-SIZE-BINARY-READER TO FIXED-SIZE-BINARY-READER.
    PERFORM NEXT-BATCH-PROCEDURE USING FIXED-SIZE-BINARY-READER,
                                      VECTOR,
                                      NUM-VALS-IN-VECTOR,
                                      TYPE-WIDTH,
                                      NULLABILITY-HOLDER.

VAR-WIDTH-TYPE-PAGE-READER-PROCEDURE.
    MOVE VECTORIZED-DEFINITION-LEVEL-READER-VAR-WIDTH-READER TO VAR-WIDTH-READER.
    PERFORM NEXT-BATCH-PROCEDURE USING VAR-WIDTH-READER,
                                      VECTOR,
                                      NUM-VALS-IN-VECTOR,
                                      TYPE-WIDTH,
                                      NULLABILITY-HOLDER.

BOOLEAN-PAGE-READER-PROCEDURE.
    MOVE VECTORIZED-DEFINITION-LEVEL-READER-BOOLEAN-READER TO BOOLEAN-READER.
    PERFORM NEXT-BATCH-PROCEDURE USING BOOLEAN-READER,
                                      VECTOR,
                                      NUM-VALS-IN-VECTOR,
                                      TYPE-WIDTH,
                                      NULLABILITY-HOLDER.

GET-ACTUAL-BATCH-SIZE-PROCEDURE.
    COMPUTE ACTUAL-BATCH-SIZE = MIN(EXPECTED-BATCH-SIZE, TUPLES-COUNT - TUPLES-READ).

NEXT-BATCH-PROCEDURE.
    PERFORM NEXT-VAL-PROCEDURE.
    IF DICTIONARY-DECODE-MODE = EAGER
        PERFORM NEXT-DICT-ENCODED-VAL-PROCEDURE
    ELSE
        PERFORM NEXT-VAL-PROCEDURE
    END-IF.
    ADD ACTUAL-BATCH-SIZE TO TUPLES-READ.
    MOVE LESS-THAN-TUPLES-COUNT TO HAS-NEXT.

NEXT-VAL-PROCEDURE.
    CALL READER USING VECTOR,
                     NUM-VALS,
                     TYPE-WIDTH,
                     ACTUAL-BATCH-SIZE,
                     NULLABILITY-HOLDER,
                     PLAIN-VALUES-READER.

NEXT-DICT-ENCODED-VAL-PROCEDURE.
    CALL READER USING VECTOR,
                     NUM-VALS,
                     TYPE-WIDTH,
                     ACTUAL-BATCH-SIZE,
                     NULLABILITY-HOLDER,
                     DICTIONARY-ENCODED-VALUES-READER,
                     DICTIONARY.

SUPER-RESET.
    PERFORM RESET.

STOP RUN.
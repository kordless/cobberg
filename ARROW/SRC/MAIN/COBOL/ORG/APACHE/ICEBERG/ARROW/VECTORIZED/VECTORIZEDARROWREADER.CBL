IDENTIFICATION DIVISION.
PROGRAM-ID. VECTORIZED-ARROW-READER.

ENVIRONMENT DIVISION.
SPECIAL-NAMES.
    DECIMAL-POINT IS COMMA.

DATA DIVISION.
WORKING-STORAGE SECTION.

01  DEFAULT-BATCH-SIZE PIC 9(5) VALUE 5000.
01  UNKNOWN-WIDTH PIC S9(9) COMP VALUE NULL.
01  AVERAGE-VARIABLE-WIDTH-RECORD-SIZE PIC 9(2) VALUE 10.

01  COLUMN-DESCRIPTOR PIC X(256).
01  VECTORIZED-COLUMN-ITERATOR PIC X(256).
01  ICEBERG-FIELD PIC X(256).
01  ROOT-ALLOC PIC X(256).

01  BATCH-SIZE PIC 9(5).
01  VECTOR PIC X(256).
01  TYPE-WIDTH PIC 9(9) COMP.
01  READ-TYPE PIC X(20).
01  NULLABILITY-HOLDER PIC X(256).

01  DICTIONARY PIC X(256).

01  FIELD PIC X(256).
01  FIELD-TYPE PIC X(256).
01  ARROW-TYPE PIC X(256).

01  ARROW-FIELD PIC X(256).
01  ARROW-VECTOR PIC X(256).

01  PRIMITIVE-TYPE PIC X(256).
01  LOGICAL-TYPE PIC X(256).
01  PHYSICAL-TYPE PIC X(256).

01  DECIMAL-LOGICAL-TYPE PIC X(256).
01  DECIMAL-TYPE PIC X(256).

PROCEDURE DIVISION.

MAIN-PARAGRAPH.
    PERFORM ALLOCATE-FIELD-VECTOR.
    PERFORM READ-DATA.
    PERFORM CLOSE-RESOURCES.
    STOP RUN.

ALLOCATE-FIELD-VECTOR.
    IF DICTIONARY-ENCODED-VECTOR
        PERFORM ALLOCATE-DICT-ENCODED-VECTOR
    ELSE
        PERFORM ALLOCATE-VECTOR-BASED-ON-ORIGINAL-TYPE
        PERFORM ALLOCATE-VECTOR-BASED-ON-TYPE-NAME.

ALLOCATE-DICT-ENCODED-VECTOR.
    MOVE ICEBERG-FIELD-NAME TO FIELD-NAME.
    MOVE ICEBERG-FIELD-IS-OPTIONAL TO FIELD-IS-OPTIONAL.
    MOVE INTEGER-SIZE TO ARROW-TYPE-INT-BIT-WIDTH.
    MOVE TRUE TO ARROW-TYPE-INT-SIGNED.
    MOVE FIELD-NAME TO ARROW-FIELD-NAME.
    MOVE FIELD-IS-OPTIONAL TO ARROW-FIELD-IS-OPTIONAL.
    MOVE ARROW-TYPE-INT TO ARROW-FIELD-TYPE.
    MOVE NULL TO ARROW-FIELD-DICTIONARY.
    MOVE NULL TO ARROW-FIELD-METADATA.
    CREATE ARROW-FIELD FROM ARROW-FIELD-NAME, ARROW-FIELD-TYPE, ARROW-FIELD-DICTIONARY, ARROW-FIELD-METADATA.
    CREATE ARROW-VECTOR FROM ARROW-FIELD, ROOT-ALLOC.
    MOVE INTEGER-TYPE-WIDTH TO TYPE-WIDTH.
    MOVE DICTIONARY-READTYPE TO READ-TYPE.

ALLOCATE-VECTOR-BASED-ON-ORIGINAL-TYPE.
    EVALUATE PRIMITIVE-ORIGINAL-TYPE
        WHEN ENUM THRU UUID
            PERFORM ALLOCATE-VECTOR-BASED-ON-ARROW-FIELD
        WHEN OTHER
            THROW UNSUPPORTED-ORIGINAL-TYPE-EXCEPTION.

ALLOCATE-VECTOR-BASED-ON-TYPE-NAME.
    EVALUATE PRIMITIVE-TYPE-NAME
        WHEN FIXED-LEN-BYTE-ARRAY
            PERFORM ALLOCATE-FIXED-WIDTH-BINARY-VECTOR
        WHEN BINARY
            PERFORM ALLOCATE-VARBINARY-VECTOR
        WHEN INT32
            PERFORM ALLOCATE-INT-VECTOR
        WHEN INT96
            PERFORM ALLOCATE-TIMESTAMP-INT96-VECTOR
        WHEN FLOAT
            PERFORM ALLOCATE-FLOAT-VECTOR
        WHEN BOOLEAN
            PERFORM ALLOCATE-BOOLEAN-VECTOR
        WHEN INT64
            PERFORM ALLOCATE-LONG-VECTOR
        WHEN DOUBLE
            PERFORM ALLOCATE-DOUBLE-VECTOR
        WHEN OTHER
            THROW UNSUPPORTED-TYPE-NAME-EXCEPTION.

READ-DATA.
    IF DICTIONARY-ENCODED-VECTOR
        PERFORM READ-DICTIONARY-ENCODED-VECTOR
    ELSE
        EVALUATE READ-TYPE
            WHEN VARBINARY THRU UUID
                PERFORM READ-NON-DICTIONARY-ENCODED-VECTOR.

READ-DICTIONARY-ENCODED-VECTOR.
    CALL VECTORIZED-COLUMN-ITERATOR "dictionaryBatchReader.nextBatch"
        USING VECTOR, -1, NULLABILITY-HOLDER.

READ-NON-DICTIONARY-ENCODED-VECTOR.
    EVALUATE READ-TYPE
        WHEN VARBINARY THRU VARCHAR
            CALL VECTORIZED-COLUMN-ITERATOR "varWidthTypeBatchReader.nextBatch"
                USING VECTOR, -1, NULLABILITY-HOLDER
        WHEN BOOLEAN
            CALL VECTORIZED-COLUMN-ITERATOR "booleanBatchReader.nextBatch"
                USING VECTOR, -1, NULLABILITY-HOLDER
        WHEN INT THRU INT-BACKED-DECIMAL
            CALL VECTORIZED-COLUMN-ITERATOR "integerBatchReader.nextBatch"
                USING VECTOR, TYPE-WIDTH, NULLABILITY-HOLDER
        WHEN LONG THRU LONG-BACKED-DECIMAL
            CALL VECTORIZED-COLUMN-ITERATOR "longBatchReader.nextBatch"
                USING VECTOR, TYPE-WIDTH, NULLABILITY-HOLDER
        WHEN FLOAT
            CALL VECTORIZED-COLUMN-ITERATOR "floatBatchReader.nextBatch"
                USING VECTOR, TYPE-WIDTH, NULLABILITY-HOLDER
        WHEN DOUBLE
            CALL VECTORIZED-COLUMN-ITERATOR "doubleBatchReader.nextBatch"
                USING VECTOR, TYPE-WIDTH, NULLABILITY-HOLDER
        WHEN TIMESTAMP-MILLIS
            CALL VECTORIZED-COLUMN-ITERATOR "timestampMillisBatchReader.nextBatch"
                USING VECTOR, TYPE-WIDTH, NULLABILITY-HOLDER
        WHEN TIMESTAMP-INT96
            CALL VECTORIZED-COLUMN-ITERATOR "timestampInt96BatchReader.nextBatch"
                USING VECTOR, TYPE-WIDTH, NULLABILITY-HOLDER
        WHEN UUID THRU FIXED-LENGTH-DECIMAL
            CALL VECTORIZED-COLUMN-ITERATOR "fixedSizeBinaryBatchReader.nextBatch"
                USING VECTOR, TYPE-WIDTH, NULLABILITY-HOLDER
        WHEN OTHER
            THROW UNSUPPORTED-READ-TYPE-EXCEPTION.

CLOSE-RESOURCES.
    IF VECTOR NOT NULL
        CALL VECTOR "close".

IDENTIFICATION DIVISION.
PROGRAM-ID. CONSTANT-VECTOR-READER.

DATA DIVISION.
WORKING-STORAGE SECTION.

01  ICEBERG-FIELD PIC X(256).
01  CONSTANT-VALUE PIC X(256).

PROCEDURE DIVISION.

MAIN-PARAGRAPH.
    PERFORM READ-DATA.
    STOP RUN.

READ-DATA.
    RETURN VECTOR-HOLDER-WITH-CONSTANT-VALUE.

IDENTIFICATION DIVISION.
PROGRAM-ID. DELETED-VECTOR-READER.

PROCEDURE DIVISION.

MAIN-PARAGRAPH.
    PERFORM READ-DATA.
    STOP RUN.

READ-DATA.
    RETURN DELETED-VECTOR-HOLDER.
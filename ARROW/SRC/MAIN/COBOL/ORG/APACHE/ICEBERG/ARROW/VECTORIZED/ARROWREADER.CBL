IDENTIFICATION DIVISION.
PROGRAM-ID. ARROW-READER.

ENVIRONMENT DIVISION.
INPUT-OUTPUT SECTION.
FILE-CONTROL.
    SELECT INPUT-FILE ASSIGN TO DISK.

DATA DIVISION.
FILE SECTION.
FD  INPUT-FILE.
    01  INPUT-RECORD.
        05  DATA-FIELD          PIC X(256).

WORKING-STORAGE SECTION.
01  WS-SCHEMA                USAGE POINTER.
01  WS-IO                    USAGE POINTER.
01  WS-ENCRYPTION            USAGE POINTER.
01  WS-BATCH-SIZE            PIC 9(9) COMP.
01  WS-REUSE-CONTAINERS      PIC X.
01  WS-FILE-ITERATOR         USAGE POINTER.
01  WS-CURRENT-ITERATOR      USAGE POINTER.
01  WS-CURRENT-TASK          USAGE POINTER.
01  WS-INPUT-FILES           USAGE POINTER.
01  WS-EXPECTED-SCHEMA       USAGE POINTER.
01  WS-NAME-MAPPING          PIC X(256).
01  WS-CASE-SENSITIVE        PIC X.

PROCEDURE DIVISION.
    PERFORM OPEN-READER.
    PERFORM READ-BATCHES UNTIL NO MORE-BATCHES.
    PERFORM CLOSE-READER.
    STOP RUN.

OPEN-READER.
    MOVE FUNCTION POINTER(SCHEMA) TO WS-SCHEMA.
    MOVE FUNCTION POINTER(IO) TO WS-IO.
    MOVE FUNCTION POINTER(ENCRYPTION) TO WS-ENCRYPTION.
    MOVE BATCH-SIZE TO WS-BATCH-SIZE.
    MOVE REUSE-CONTAINERS TO WS-REUSE-CONTAINERS.
    PERFORM OPEN-ITERATOR.

OPEN-ITERATOR.
    MOVE FUNCTION POINTER(FILEITR) TO WS-FILE-ITERATOR.
    MOVE FUNCTION POINTER(CURRENT-ITERATOR) TO WS-CURRENT-ITERATOR.
    MOVE FUNCTION POINTER(CURRENT-TASK) TO WS-CURRENT-TASK.
    MOVE FUNCTION POINTER(INPUT-FILES) TO WS-INPUT-FILES.
    MOVE FUNCTION POINTER(EXPECTED-SCHEMA) TO WS-EXPECTED-SCHEMA.
    MOVE NAME-MAPPING TO WS-NAME-MAPPING.
    MOVE CASE-SENSITIVE TO WS-CASE-SENSITIVE.

READ-BATCHES.
    PERFORM READ-BATCH.
    PERFORM HAS-NEXT-BATCH.

READ-BATCH.
    MOVE FUNCTION POINTER(NEXT) TO CURRENT-BATCH.

HAS-NEXT-BATCH.
    MOVE FUNCTION POINTER(HASNEXT) TO WS-HAS-NEXT.
    IF WS-HAS-NEXT
        CONTINUE
    ELSE
        PERFORM CLOSE-ITERATOR.

CLOSE-ITERATOR.
    MOVE FUNCTION POINTER(CLOSE) TO WS-CLOSE.
    PERFORM WS-CLOSE.

CLOSE-READER.
    MOVE FUNCTION POINTER(CLOSE) TO WS-CLOSE.
    PERFORM WS-CLOSE.
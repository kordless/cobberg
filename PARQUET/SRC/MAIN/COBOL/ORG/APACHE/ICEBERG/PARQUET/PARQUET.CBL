IDENTIFICATION DIVISION.
PROGRAM-ID. PARQUET.

ENVIRONMENT DIVISION.
INPUT-OUTPUT SECTION.
FILE-CONTROL.
    SELECT PARQUET-FILE
        ASSIGN TO EXTERNAL-FILE
        ORGANIZATION IS PARQUET.

DATA DIVISION.
FILE SECTION.
FD PARQUET-FILE.
   01 PARQUET-RECORD PIC X(1024).

WORKING-STORAGE SECTION.
01 WS-SCHEMA                       PIC X(1024).
01 WS-TABLE-NAME                   PIC X(50).
01 WS-METADATA                     PIC X(1024).
01 WS-ROW-GROUP-SIZE               PIC 9(9) COMP.
01 WS-WRITE-SUPPORT                PIC X(50).
01 WS-CREATE-WRITER-FUNC           PIC X(50).
01 WS-METRICS-CONFIG               PIC X(50).
01 WS-WRITE-MODE                   PIC X(10).
01 WS-WRITER-VERSION               PIC X(10).
01 WS-CREATE-CONTEXT-FUNC          PIC X(50).
01 WS-FILE-ENCRYPTION-KEY          PIC X(256).
01 WS-FILE-AAD-PREFIX              PIC X(256).

01 WS-CONTEXT.
   05 WS-ROW-GROUP-SIZE            PIC 9(9) COMP.
   05 WS-PAGE-SIZE                 PIC 9(9) COMP.
   05 WS-PAGE-ROW-LIMIT            PIC 9(9) COMP.
   05 WS-DICTIONARY-PAGE-SIZE      PIC 9(9) COMP.
   05 WS-COMPRESSION-CODEC         PIC X(20).
   05 WS-COMPRESSION-LEVEL         PIC X(20).
   05 WS-ROW-GROUP-CHECK-MIN-COUNT PIC 9(9) COMP.
   05 WS-ROW-GROUP-CHECK-MAX-COUNT PIC 9(9) COMP.
   05 WS-BLOOM-FILTER-MAX-BYTES    PIC 9(9) COMP.
   05 WS-COLUMN-BLOOM-FILTER-FPP   PIC X(1024).
   05 WS-COLUMN-BLOOM-FILTER-ENABLED PIC X(1024).
   05 WS-DICTIONARY-ENABLED        PIC 9 COMP-1.

PROCEDURE DIVISION.

    PERFORM WRITE-PARQUET-FILE.
    STOP RUN.

WRITE-PARQUET-FILE.
    OPEN OUTPUT PARQUET-FILE.

    MOVE "my_table" TO WS-TABLE-NAME.
    MOVE "{ \"type\": \"record\", \"name\": \"my_table\", \"fields\": [] }" TO WS-SCHEMA.
    MOVE 134217728 TO WS-ROW-GROUP-SIZE.
    MOVE "org.apache.iceberg.parquet.AvroWriteSupport" TO WS-WRITE-SUPPORT.
    MOVE "org.apache.iceberg.parquet.ParquetValueWriters$StructWriter" TO WS-CREATE-WRITER-FUNC.
    MOVE "org.apache.iceberg.MetricsConfig" TO WS-METRICS-CONFIG.
    MOVE "CREATE" TO WS-WRITE-MODE.
    MOVE "PARQUET_1_0" TO WS-WRITER-VERSION.
    MOVE "org.apache.iceberg.parquet.WriteBuilder$Context::dataContext" TO WS-CREATE-CONTEXT-FUNC.
    MOVE X"01020304050607080910111213141516" TO WS-FILE-ENCRYPTION-KEY.
    MOVE X"17181920212223242526272829303132" TO WS-FILE-AAD-PREFIX.

    PERFORM BUILD-CONTEXT.

    PERFORM BUILD-PARQUET-WRITER.

    WRITE PARQUET-RECORD FROM WS-SCHEMA.
    CLOSE PARQUET-FILE.

BUILD-CONTEXT.
    MOVE WS-ROW-GROUP-SIZE TO WS-CONTEXT-ROW-GROUP-SIZE.
    MOVE 1048576 TO WS-CONTEXT-PAGE-SIZE.
    MOVE 10000 TO WS-CONTEXT-PAGE-ROW-LIMIT.
    MOVE 1048576 TO WS-CONTEXT-DICTIONARY-PAGE-SIZE.
    MOVE "SNAPPY" TO WS-CONTEXT-COMPRESSION-CODEC.
    MOVE "9" TO WS-CONTEXT-COMPRESSION-LEVEL.
    MOVE 100 TO WS-CONTEXT-ROW-GROUP-CHECK-MIN-COUNT.
    MOVE 1000 TO WS-CONTEXT-ROW-GROUP-CHECK-MAX-COUNT.
    MOVE 67108864 TO WS-CONTEXT-BLOOM-FILTER-MAX-BYTES.
    MOVE "column1=0.01,column2=0.05" TO WS-CONTEXT-COLUMN-BLOOM-FILTER-FPP.
    MOVE "column1=true,column2=true" TO WS-CONTEXT-COLUMN-BLOOM-FILTER-ENABLED.
    MOVE 1 TO WS-CONTEXT-DICTIONARY-ENABLED.

BUILD-PARQUET-WRITER.
    PERFORM WRITE-PARQUET-METADATA.
    PERFORM WRITE-PARQUET-DATA.

WRITE-PARQUET-METADATA.
    MOVE WS-SCHEMA TO PARQUET-RECORD.
    WRITE PARQUET-RECORD.
    MOVE WS-TABLE-NAME TO PARQUET-RECORD.
    WRITE PARQUET-RECORD.
    MOVE WS-METADATA TO PARQUET-RECORD.
    WRITE PARQUET-RECORD.

WRITE-PARQUET-DATA.
    PERFORM VARYING IDX FROM 1 BY 1 UNTIL IDX > 100
        MOVE SOME-DATA-RECORD TO PARQUET-RECORD
        WRITE PARQUET-RECORD
    END-PERFORM.

SOME-DATA-RECORD.
    MOVE "John Doe" TO CUSTOMER-NAME.
    MOVE 123.45 TO CUSTOMER-BALANCE.
    MOVE "2023-04-25" TO CUSTOMER-LAST-UPDATED.
    * Other data fields...
    MOVE CORRESPONDING CUSTOMER-RECORD TO PARQUET-RECORD.
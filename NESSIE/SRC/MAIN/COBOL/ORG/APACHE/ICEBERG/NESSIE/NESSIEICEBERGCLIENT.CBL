IDENTIFICATION DIVISION.
PROGRAM-ID. NESSIE-ICEBERG-CLIENT.

ENVIRONMENT DIVISION.
SPECIAL-NAMES.
    LOCALE IS BASIC-LOCALE.

DATA DIVISION.
WORKING-STORAGE SECTION.
01 WS-API.
   05 WS-NESSIE-API-V1 PIC X(30).
01 WS-REFERENCE.
   05 WS-UPDATEABLE-REFERENCE.
      10 WS-REFERENCE-OBJ PIC X(30).
      10 WS-HASH PIC X(50).
01 WS-CATALOG-OPTIONS.
   05 WS-CATALOG-OPTION-MAP.
      10 WS-CATALOG-OPTION-KEY PIC X(50).
      10 WS-CATALOG-OPTION-VALUE PIC X(100).
01 WS-TABLES.
   05 WS-TABLE-IDENTIFIER.
      10 WS-TABLE-LEVELS PIC X(50) OCCURS 10 TIMES.
01 WS-VIEWS.
   05 WS-VIEW-IDENTIFIER.
      10 WS-VIEW-LEVELS PIC X(50) OCCURS 10 TIMES.
01 WS-NAMESPACES.
   05 WS-NAMESPACE.
      10 WS-NAMESPACE-LEVELS PIC X(50) OCCURS 10 TIMES.
01 WS-CONTENT.
   05 WS-ICEBERG-CONTENT.
      10 WS-CONTENT-TYPE PIC X(30).
      10 WS-CONTENT-DATA PIC X(500).
01 WS-EXCEPTIONS.
   05 WS-ALREADY-EXISTS-EXCEPTION.
      10 WS-ALREADY-EXISTS-MESSAGE PIC X(100).
   05 WS-NO-SUCH-NAMESPACE-EXCEPTION.
      10 WS-NO-SUCH-NAMESPACE-MESSAGE PIC X(100).
   05 WS-NAMESPACE-NOT-EMPTY-EXCEPTION.
      10 WS-NAMESPACE-NOT-EMPTY-MESSAGE PIC X(100).
   05 WS-NO-SUCH-TABLE-EXCEPTION.
      10 WS-NO-SUCH-TABLE-MESSAGE PIC X(100).
   05 WS-NO-SUCH-VIEW-EXCEPTION.
      10 WS-NO-SUCH-VIEW-MESSAGE PIC X(100).
   05 WS-COMMIT-FAILED-EXCEPTION.
      10 WS-COMMIT-FAILED-MESSAGE PIC X(100).
   05 WS-COMMIT-STATE-UNKNOWN-EXCEPTION.
      10 WS-COMMIT-STATE-UNKNOWN-MESSAGE PIC X(100).

PROCEDURE DIVISION.

    INITIALIZE-CLIENT.
        MOVE API TO WS-NESSIE-API-V1.
        MOVE UPDATEABLE-REFERENCE TO WS-UPDATEABLE-REFERENCE.
        MOVE CATALOG-OPTIONS TO WS-CATALOG-OPTION-MAP.

    LIST-TABLES.
        PERFORM GET-TABLES IN WS-NAMESPACE.
        RETURN WS-TABLE-IDENTIFIER.

    LIST-VIEWS.
        PERFORM GET-VIEWS IN WS-NAMESPACE.
        RETURN WS-VIEW-IDENTIFIER.

    GET-TABLE.
        PERFORM FETCH-CONTENT IN WS-TABLE-IDENTIFIER.
        RETURN WS-ICEBERG-CONTENT.

    GET-VIEW.
        PERFORM FETCH-CONTENT IN WS-VIEW-IDENTIFIER.
        RETURN WS-ICEBERG-CONTENT.

    CREATE-NAMESPACE.
        PERFORM CHECK-NAMESPACE-VALID IN WS-NAMESPACE.
        PERFORM CHECK-REFERENCE-MUTABLE.
        PERFORM COMMIT-RETRY IN WS-NAMESPACE, WS-CATALOG-OPTION-MAP.

    LIST-NAMESPACES.
        PERFORM GET-NAMESPACES IN WS-NAMESPACE.
        RETURN WS-NAMESPACE.

    DROP-NAMESPACE.
        PERFORM CHECK-NAMESPACE-VALID IN WS-NAMESPACE.
        PERFORM CHECK-REFERENCE-MUTABLE.
        PERFORM COMMIT-RETRY IN WS-NAMESPACE.

    LOAD-NAMESPACE-METADATA.
        PERFORM CHECK-NAMESPACE-VALID IN WS-NAMESPACE.
        PERFORM FETCH-NAMESPACE-CONTENT IN WS-NAMESPACE.
        RETURN WS-CATALOG-OPTION-MAP.

    SET-NAMESPACE-PROPERTIES.
        PERFORM CHECK-NAMESPACE-VALID IN WS-NAMESPACE.
        PERFORM CHECK-REFERENCE-MUTABLE.
        PERFORM COMMIT-RETRY IN WS-NAMESPACE, WS-CATALOG-OPTION-MAP.

    REMOVE-NAMESPACE-PROPERTIES.
        PERFORM CHECK-NAMESPACE-VALID IN WS-NAMESPACE.
        PERFORM CHECK-REFERENCE-MUTABLE.
        PERFORM COMMIT-RETRY IN WS-NAMESPACE, WS-CATALOG-OPTION-MAP.

    RENAME-TABLE.
        PERFORM RENAME-CONTENT IN WS-TABLE-IDENTIFIER, WS-TABLE-IDENTIFIER, CONTENT-TYPE-ICEBERG-TABLE.

    RENAME-VIEW.
        PERFORM RENAME-CONTENT IN WS-VIEW-IDENTIFIER, WS-VIEW-IDENTIFIER, CONTENT-TYPE-ICEBERG-VIEW.

    DROP-TABLE.
        PERFORM DROP-CONTENT IN WS-TABLE-IDENTIFIER, TRUE, CONTENT-TYPE-ICEBERG-TABLE.

    DROP-VIEW.
        PERFORM DROP-CONTENT IN WS-VIEW-IDENTIFIER, TRUE, CONTENT-TYPE-ICEBERG-VIEW.

    COMMIT-TABLE.
        PERFORM COMMIT-CONTENT IN WS-TABLE-IDENTIFIER, WS-TABLE-METADATA, WS-NEW-METADATA-LOCATION, WS-CONTENT-ID, WS-CATALOG-OPTION-MAP.

    COMMIT-VIEW.
        PERFORM COMMIT-CONTENT IN WS-VIEW-IDENTIFIER, WS-VIEW-METADATA, WS-NEW-METADATA-LOCATION, WS-CONTENT-ID, WS-CATALOG-OPTION-MAP.

    CHECK-NAMESPACE-VALID.
        IF WS-NAMESPACE-LEVELS IS EMPTY
            RAISE WS-NO-SUCH-NAMESPACE-EXCEPTION.

    CHECK-REFERENCE-MUTABLE.
        IF WS-UPDATEABLE-REFERENCE IS NOT MUTABLE
            RAISE EXCEPTION.

    FETCH-CONTENT.
        PERFORM GET-CONTENT IN WS-TABLE-IDENTIFIER OR WS-VIEW-IDENTIFIER.
        RETURN WS-ICEBERG-CONTENT.

    FETCH-NAMESPACE-CONTENT.
        PERFORM GET-NAMESPACE-CONTENT IN WS-NAMESPACE.
        RETURN WS-CATALOG-OPTION-MAP.

    COMMIT-RETRY.
        PERFORM RETRY-COMMIT IN WS-NAMESPACE, WS-CATALOG-OPTION-MAP.

    GET-TABLES.
        PERFORM GET-CONTENT-LIST IN WS-NAMESPACE, CONTENT-TYPE-ICEBERG-TABLE.
        RETURN WS-TABLE-IDENTIFIER.

    GET-VIEWS.
        PERFORM GET-CONTENT-LIST IN WS-NAMESPACE, CONTENT-TYPE-ICEBERG-VIEW.
        RETURN WS-VIEW-IDENTIFIER.

    GET-NAMESPACES.
        PERFORM GET-NAMESPACE-LIST IN WS-NAMESPACE.
        RETURN WS-NAMESPACE.

    GET-CONTENT-LIST.
        PERFORM FETCH-CONTENT-LIST IN WS-NAMESPACE, WS-CONTENT-TYPE.
        RETURN WS-TABLE-IDENTIFIER OR WS-VIEW-IDENTIFIER.

    GET-NAMESPACE-LIST.
        PERFORM FETCH-NAMESPACE-LIST IN WS-NAMESPACE.
        RETURN WS-NAMESPACE.

    RENAME-CONTENT.
        PERFORM VALIDATE-FROM-CONTENT IN WS-TABLE-IDENTIFIER OR WS-VIEW-IDENTIFIER, WS-CONTENT-TYPE.
        PERFORM VALIDATE-TO-CONTENT IN WS-TABLE-IDENTIFIER, WS-TABLE-IDENTIFIER, WS-CONTENT-TYPE.
        PERFORM COMMIT-RETRY IN WS-TABLE-IDENTIFIER, WS-TABLE-IDENTIFIER, WS-CONTENT-TYPE.

    DROP-CONTENT.
        PERFORM FETCH-CONTENT IN WS-TABLE-IDENTIFIER OR WS-VIEW-IDENTIFIER.
        IF WS-ICEBERG-CONTENT-TYPE IS NOT WS-CONTENT-TYPE
            RAISE EXCEPTION.
        PERFORM COMMIT-RETRY IN WS-TABLE-IDENTIFIER OR WS-VIEW-IDENTIFIER, WS-CONTENT-TYPE.

    COMMIT-CONTENT.
        PERFORM UPDATE-REFERENCE IN WS-UPDATEABLE-REFERENCE.
        PERFORM COMMIT-MULTIPLE-OPERATIONS IN WS-TABLE-IDENTIFIER OR WS-VIEW-IDENTIFIER, WS-METADATA, WS-NEW-METADATA-LOCATION, WS-CONTENT-ID, WS-CATALOG-OPTION-MAP.

    VALIDATE-FROM-CONTENT.
        IF WS-ICEBERG-CONTENT IS NULL
            IF WS-CONTENT-TYPE IS CONTENT-TYPE-ICEBERG-VIEW
                RAISE WS-NO-SUCH-VIEW-EXCEPTION.
            ELSE IF WS-CONTENT-TYPE IS CONTENT-TYPE-ICEBERG-TABLE
                RAISE WS-NO-SUCH-TABLE-EXCEPTION.
            ELSE
                RAISE EXCEPTION.
        ELSE IF WS-ICEBERG-CONTENT-TYPE IS NOT WS-CONTENT-TYPE
            RAISE EXCEPTION.

    VALIDATE-TO-CONTENT.
        IF WS-ICEBERG-CONTENT IS NOT NULL
            IF WS-ICEBERG-CONTENT-TYPE IS CONTENT-TYPE-ICEBERG-VIEW
                RAISE WS-ALREADY-EXISTS-EXCEPTION.
            ELSE IF WS-ICEBERG-CONTENT-TYPE IS CONTENT-TYPE-ICEBERG-TABLE
                RAISE WS-ALREADY-EXISTS-EXCEPTION.
            ELSE
                RAISE WS-ALREADY-EXISTS-EXCEPTION.

    RETRY-COMMIT.
        PERFORM RETRY-OPERATION IN WS-NAMESPACE, WS-CATALOG-OPTION-MAP.
        IF EXCEPTION IS WS-COMMIT-FAILED-EXCEPTION OR WS-COMMIT-STATE-UNKNOWN-EXCEPTION
            PERFORM REFRESH-REFERENCE IN WS-UPDATEABLE-REFERENCE.
        RAISE EXCEPTION.

    REFRESH-REFERENCE.
        PERFORM UPDATE-REFERENCE IN WS-UPDATEABLE-REFERENCE.

    UPDATE-REFERENCE.
        IF WS-UPDATEABLE-REFERENCE IS NOT MUTABLE
            MOVE REFERENCE TO WS-REFERENCE-OBJ.
        ELSE
            MOVE REFERENCE-NAME TO WS-REFERENCE-OBJ.
            MOVE HASH TO WS-HASH.

    COMMIT-MULTIPLE-OPERATIONS.
        PERFORM BUILD-COMMIT-MESSAGE IN WS-TABLE-IDENTIFIER OR WS-VIEW-IDENTIFIER, WS-METADATA.
        PERFORM COMMIT-OPERATION IN WS-TABLE-IDENTIFIER OR WS-VIEW-IDENTIFIER, WS-NEW-METADATA-LOCATION, WS-CONTENT-ID, WS-COMMIT-MESSAGE, WS-CATALOG-OPTION-MAP.

    BUILD-COMMIT-MESSAGE.
        IF IS-SNAPSHOT-OPERATION IN WS-METADATA
            MOVE "Iceberg " CONCAT WS-METADATA-SNAPSHOT-OPERATION CONCAT " against " CONCAT WS-TABLE-IDENTIFIER TO WS-COMMIT-MESSAGE.
        ELSE IF WS-METADATA-SCHEMA-ID IS NOT WS-BASE-SCHEMA-ID
            MOVE "Iceberg schema change against table " CONCAT WS-TABLE-IDENTIFIER TO WS-COMMIT-MESSAGE.
        ELSE IF WS-BASE-METADATA IS NULL
            MOVE "Iceberg table created/registered with name " CONCAT WS-TABLE-IDENTIFIER TO WS-COMMIT-MESSAGE.
        ELSE
            MOVE "Iceberg commit against table " CONCAT WS-TABLE-IDENTIFIER TO WS-COMMIT-MESSAGE.

    COMMIT-OPERATION.
        PERFORM UPDATE-REFERENCE IN WS-UPDATEABLE-REFERENCE.
        PERFORM COMMIT-MULTIPLE-OPERATIONS-API IN WS-TABLE-IDENTIFIER OR WS-VIEW-IDENTIFIER, WS-NEW-METADATA-LOCATION, WS-CONTENT-ID, WS-COMMIT-MESSAGE, WS-CATALOG-OPTION-MAP.
        PERFORM UPDATE-REFERENCE IN WS-UPDATEABLE-REFERENCE.

    COMMIT-MULTIPLE-OPERATIONS-API.
        MOVE BRANCH TO WS-BRANCH.
        MOVE HASH OF BRANCH TO WS-EXPECTED-HEAD-HASH.
        PERFORM COMMIT-MULTIPLE-OPERATIONS-WITH-RETRY IN WS-TABLE-IDENTIFIER OR WS-VIEW-IDENTIFIER, WS-NEW-METADATA-LOCATION, WS-CONTENT-ID, WS-COMMIT-MESSAGE, WS-CATALOG-OPTION-MAP, WS-BRANCH, WS-EXPECTED-HEAD-HASH.

    COMMIT-MULTIPLE-OPERATIONS-WITH-RETRY.
        RETRY-OPERATION 5 TIMES
            ON EXCEPTION WS-COMMIT-FAILED-EXCEPTION OR WS-COMMIT-STATE-UNKNOWN-EXCEPTION
                PERFORM REFRESH-REFERENCE IN WS-UPDATEABLE-REFERENCE
            USING
                COMMIT-MULTIPLE-OPERATIONS-API IN WS-TABLE-IDENTIFIER OR WS-VIEW-IDENTIFIER, WS-NEW-METADATA-LOCATION, WS-CONTENT-ID, WS-COMMIT-MESSAGE, WS-CATALOG-OPTION-MAP, WS-BRANCH, WS-EXPECTED-HEAD-HASH.

    IS-SNAPSHOT-OPERATION.
        IF WS-METADATA-SNAPSHOT IS NOT NULL AND (WS-BASE-METADATA IS NULL OR WS-BASE-METADATA-SNAPSHOT IS NULL OR WS-METADATA-SNAPSHOT-ID IS NOT WS-BASE-METADATA-SNAPSHOT-ID)
            RETURN TRUE.
        ELSE
            RETURN FALSE.

    COPY 'NESSIE-UTIL.cpy'.
    COPY 'NESSIE-CONSTANTS.cpy'.

END PROGRAM NESSIE-ICEBERG-CLIENT.
IDENTIFICATION DIVISION.
PROGRAM-ID. NESSIE-UTIL.

ENVIRONMENT DIVISION.
SPECIAL-NAMES.
    CALL "SYSTEM-GETPROPERTY" USING "user.name" INTO WS-USER-NAME.

DATA DIVISION.
COPY "NESSIE-MODEL".

WORKING-STORAGE SECTION.
01 WS-USER-NAME PIC X(50).
01 WS-PROPERTIES MAP.
   03 FILLER PIC X(15) VALUE "nessie.".
   03 WS-PROPERTY-NAME PIC X(20) OCCURS 20.
   03 WS-PROPERTY-VALUE PIC X(50) OCCURS 20.
01 WS-CONFLICT-TYPES.
   03 FILLER PIC 9 VALUE 1.
   03 FILLER PIC 9 VALUE 2.
   03 FILLER PIC 9 VALUE 3.
   03 FILLER PIC 9 VALUE 4.
01 WS-CONFLICT-TYPE PIC 9 OCCURS 4.
01 WS-CONFLICT-ENUM.
   03 FILLER PIC X(20) VALUE "NAMESPACE_ABSENT".
   03 FILLER PIC X(20) VALUE "NAMESPACE_NOT_EMPTY".
   03 FILLER PIC X(20) VALUE "KEY_DOES_NOT_EXIST".
   03 FILLER PIC X(20) VALUE "KEY_EXISTS".

PROCEDURE DIVISION.

    PERFORM REMOVE-CATALOG-NAME.
    PERFORM TO-KEY.
    PERFORM BUILD-COMMIT-METADATA.
    PERFORM CATALOG-OPTIONS.
    PERFORM COMMIT-AUTHOR.
    PERFORM CHECK-AND-UPDATE-GC-PROPERTIES.
    PERFORM UPDATE-TABLE-METADATA-WITH-NESSIE-PROPERTIES.
    PERFORM EXTRACT-SINGLE-CONFLICT.
    PERFORM LOAD-VIEW-METADATA.
    PERFORM HANDLE-EXCEPTIONS-FOR-COMMITS.
    PERFORM HANDLE-BAD-REQUEST-FOR-COMMIT.
    PERFORM SPECIALIZE-EXCEPTION.
    PERFORM CONTENT-TYPE-STRING.

    STOP RUN.

REMOVE-CATALOG-NAME SECTION.
    PERFORM VARYING I FROM 1 BY 1 UNTIL I > LENGTH OF WS-LEVEL
        IF WS-LEVEL(I) = WS-CATALOG-NAME
            MOVE 1 TO WS-TRIMMED-LENGTH
            MOVE WS-LEVEL(I + 1) TO WS-TRIMMED-NAME
        END-IF
    END-PERFORM.

TO-KEY SECTION.
    MOVE SPACES TO WS-KEY.
    PERFORM VARYING I FROM 1 BY 1 UNTIL I > LENGTH OF WS-LEVEL
        STRING WS-LEVEL(I) INTO WS-KEY DELIMITED BY SPACE
    END-PERFORM.

BUILD-COMMIT-METADATA SECTION.
    MOVE WS-COMMIT-MSG TO WS-COMMIT-METADATA-MSG.
    PERFORM VARYING I FROM 1 BY 1 UNTIL I > LENGTH OF WS-PROPERTY-NAME
        MOVE WS-PROPERTY-NAME(I) TO WS-COMMIT-METADATA-PROPERTY-NAME
        MOVE WS-PROPERTY-VALUE(I) TO WS-COMMIT-METADATA-PROPERTY-VALUE
        PERFORM CATALOG-OPTIONS
    END-PERFORM.

CATALOG-OPTIONS SECTION.
    MOVE WS-USER-NAME TO WS-COMMIT-METADATA-AUTHOR.
    MOVE "iceberg" TO WS-COMMIT-METADATA-APP-TYPE.
    IF WS-PROPERTY-NAME(I) = "app.id"
        MOVE WS-PROPERTY-VALUE(I) TO WS-COMMIT-METADATA-APP-ID
    END-IF.

COMMIT-AUTHOR SECTION.
    IF WS-PROPERTY-NAME(I) = "user"
        MOVE WS-PROPERTY-VALUE(I) TO WS-COMMIT-METADATA-AUTHOR
    ELSE
        MOVE WS-USER-NAME TO WS-COMMIT-METADATA-AUTHOR
    END-IF.

CHECK-AND-UPDATE-GC-PROPERTIES SECTION.
    IF WS-GC-NO-WARNING = "TRUE"
        CONTINUE
    END-IF.
    IF WS-GC-ENABLED = "TRUE" OR WS-METADATA-DELETE-AFTER-COMMIT-ENABLED = "TRUE"
        MOVE "TRUE" TO WS-GC-NO-WARNING
        DISPLAY "Warning message for GC properties"
    END-IF.

UPDATE-TABLE-METADATA-WITH-NESSIE-PROPERTIES SECTION.
    MOVE WS-COMMIT-ID TO WS-METADATA-NESSIE-COMMIT-ID.
    PERFORM CHECK-AND-UPDATE-GC-PROPERTIES.
    MOVE WS-METADATA-LOCATION TO WS-NEW-METADATA-LOCATION.
    MOVE WS-SCHEMA-ID TO WS-NEW-SCHEMA-ID.
    MOVE WS-SORT-ORDER-ID TO WS-NEW-SORT-ORDER-ID.
    MOVE WS-SPEC-ID TO WS-NEW-SPEC-ID.
    IF WS-SNAPSHOT-ID <> -1
        MOVE WS-SNAPSHOT-ID TO WS-NEW-BRANCH-SNAPSHOT
    END-IF.

EXTRACT-SINGLE-CONFLICT SECTION.
    PERFORM VARYING I FROM 1 BY 1 UNTIL I > 4
        IF WS-CONFLICT-TYPE(I) IN WS-CONFLICT-TYPES
            IF WS-CONFLICT-ENUM(I) = WS-CONFLICT-TYPE
                MOVE WS-CONFLICT TO WS-SINGLE-CONFLICT
            END-IF
        END-IF
    END-PERFORM.

LOAD-VIEW-METADATA SECTION.
    MOVE WS-COMMIT-ID TO WS-VIEW-METADATA-NESSIE-COMMIT-ID.
    MOVE WS-VIEW-METADATA-LOCATION TO WS-NEW-VIEW-METADATA-LOCATION.

HANDLE-EXCEPTIONS-FOR-COMMITS SECTION.
    EVALUATE WS-EXCEPTION-TYPE
        WHEN "NESSIE-CONFLICT-EXCEPTION"
            IF WS-EXCEPTION-TYPE = "NESSIE-REFERENCE-CONFLICT-EXCEPTION"
                PERFORM SPECIALIZE-EXCEPTION
            ELSE
                MOVE "Cannot commit: Reference hash is out of date. Update the reference and try again." 
                    TO WS-COMMIT-FAIL-EXCEPTION-MSG
            END-IF
        WHEN "NESSIE-NOT-FOUND-EXCEPTION"
            MOVE "Cannot commit: Reference no longer exists" TO WS-COMMIT-FAIL-EXCEPTION-MSG
        WHEN "HTTP-CLIENT-EXCEPTION"
            MOVE "Commit state unknown" TO WS-COMMIT-FAIL-EXCEPTION-MSG
    END-EVALUATE.

HANDLE-BAD-REQUEST-FOR-COMMIT SECTION.
    IF WS-CONTENT-TYPE = ICEBERG-TABLE
        MOVE ICEBERG-VIEW TO WS-OTHER-CONTENT-TYPE
    ELSE
        MOVE ICEBERG-TABLE TO WS-OTHER-CONTENT-TYPE
    END-IF.
    PERFORM GET-CONTENT
    IF WS-CONTENT-TYPE = WS-OTHER-CONTENT-TYPE
        MOVE "Another content with same name already exists" TO WS-ALREADY-EXISTS-EXCEPTION-MSG
    ELSE IF WS-CONTENT-TYPE <> WS-TYPE
        MOVE "Another content with same name already exists" TO WS-ALREADY-EXISTS-EXCEPTION-MSG
    END-IF.

SPECIALIZE-EXCEPTION SECTION.
    EVALUATE WS-CONFLICT-ENUM(I)
        WHEN "NAMESPACE_ABSENT"
            MOVE "Namespace does not exist" TO WS-EXCEPTION-MSG
        WHEN "NAMESPACE_NOT_EMPTY" 
            MOVE "Namespace not empty" TO WS-EXCEPTION-MSG
        WHEN "KEY_DOES_NOT_EXIST"
            IF WS-TYPE = ICEBERG-VIEW
                MOVE "View does not exist" TO WS-EXCEPTION-MSG
            ELSE
                MOVE "Table does not exist" TO WS-EXCEPTION-MSG
            END-IF
        WHEN "KEY_EXISTS"
            MOVE "Already exists" TO WS-EXCEPTION-MSG
    END-EVALUATE.

CONTENT-TYPE-STRING SECTION.
    EVALUATE WS-TYPE
        WHEN ICEBERG-VIEW
            MOVE "View" TO WS-CONTENT-TYPE-STRING
        WHEN ICEBERG-TABLE
            MOVE "Table" TO WS-CONTENT-TYPE-STRING
        WHEN NAMESPACE
            MOVE "Namespace" TO WS-CONTENT-TYPE-STRING
        WHEN OTHER
            MOVE "Unknown" TO WS-CONTENT-TYPE-STRING
    END-EVALUATE.
IDENTIFICATION DIVISION.
PROGRAM-ID. MANIFESTGROUP.

ENVIRONMENT DIVISION.
REPOSITORY.
    COPY "ICEBERGUTIL.cpy".

DATA DIVISION.
WORKING-STORAGE SECTION.
01 EMPTY-STRUCT.
    05 FILLER PIC X(1).

01 CACHED-EVALUATORS.
    05 RESIDUAL-CACHE.
        10 RESIDUAL-EVALUATOR OCCURS 1 TO 999 DEPENDING ON SPEC-COUNT.
    05 MANIFEST-EVALUATOR-CACHE.
        10 MANIFEST-EVALUATOR OCCURS 1 TO 999 DEPENDING ON SPEC-COUNT.
    05 SPEC-COUNT PIC 9(4) COMP.

01 TASK-CONTEXT.
    05 SCHEMA-AS-STRING PIC X(1000).
    05 SPEC-AS-STRING PIC X(1000).
    05 DELETES PIC 9(9) COMP.
    05 RESIDUALS PIC 9(9) COMP.
    05 DROP-STATS PIC X.
    05 COLUMNS-TO-KEEP-STATS OCCURS 1 TO 999 DEPENDING ON COLUMN-COUNT PIC 9(4) COMP.
    05 COLUMN-COUNT PIC 9(4) COMP.
    05 SCAN-METRICS PIC 9(9) COMP.

01 MANIFEST-ENTRY.
    05 ENTRY-FILE PIC X(1000).
    05 ENTRY-STATUS PIC 9.

PROCEDURE DIVISION.

PLAN-FILES.
    PERFORM INITIALIZE-CACHED-EVALUATORS.
    PERFORM INITIALIZE-DELETE-INDEX.
    PERFORM CREATE-FILE-SCAN-TASKS.

INITIALIZE-CACHED-EVALUATORS.
    INITIALIZE RESIDUAL-CACHE.
    INITIALIZE MANIFEST-EVALUATOR-CACHE.
    MOVE 0 TO SPEC-COUNT.

INITIALIZE-DELETE-INDEX.
    PERFORM DELETE-INDEX-BUILDER.

CREATE-FILE-SCAN-TASKS.
    PERFORM VARYING MANIFEST-IDX FROM 1 BY 1 UNTIL MANIFEST-IDX > MANIFEST-COUNT
        PERFORM READ-MANIFEST
        PERFORM FILTER-MANIFEST-ENTRIES
        PERFORM CREATE-TASKS USING MANIFEST-ENTRY
    END-PERFORM.

READ-MANIFEST.
    PERFORM MANIFEST-READER.
    IF IGNORE-DELETED
        MOVE LIVE-ENTRIES TO MANIFEST-ENTRIES
    ELSE
        MOVE ENTRIES TO MANIFEST-ENTRIES
    END-IF.
    IF IGNORE-EXISTING
        PERFORM FILTER-EXISTING-ENTRIES
    END-IF.
    IF FILE-FILTER NOT = ALWAYS-TRUE
        PERFORM FILTER-FILES
    END-IF.
    PERFORM FILTER-MANIFEST-ENTRY-PREDICATE.

FILTER-EXISTING-ENTRIES.
    PERFORM VARYING ENTRY-IDX FROM 1 BY 1 UNTIL ENTRY-IDX > ENTRY-COUNT
        IF ENTRY-STATUS NOT = EXISTING
            MOVE ENTRY-FILE(ENTRY-IDX) TO FILTERED-ENTRIES(FILTERED-COUNT)
            ADD 1 TO FILTERED-COUNT
        END-IF
    END-PERFORM.

FILTER-FILES.
    PERFORM VARYING ENTRY-IDX FROM 1 BY 1 UNTIL ENTRY-IDX > ENTRY-COUNT
        IF EVALUATOR-EVAL(ENTRY-FILE(ENTRY-IDX))
            MOVE ENTRY-FILE(ENTRY-IDX) TO FILTERED-ENTRIES(FILTERED-COUNT)
            ADD 1 TO FILTERED-COUNT
        END-IF
    END-PERFORM.

FILTER-MANIFEST-ENTRY-PREDICATE.
    PERFORM VARYING ENTRY-IDX FROM 1 BY 1 UNTIL ENTRY-IDX > ENTRY-COUNT
        IF MANIFEST-ENTRY-PREDICATE(ENTRY-FILE(ENTRY-IDX), ENTRY-STATUS(ENTRY-IDX))
            MOVE ENTRY-FILE(ENTRY-IDX) TO FILTERED-ENTRIES(FILTERED-COUNT)
            MOVE ENTRY-STATUS(ENTRY-IDX) TO FILTERED-STATUS(FILTERED-COUNT)
            ADD 1 TO FILTERED-COUNT
        END-IF
    END-PERFORM.

CREATE-TASKS.
    PERFORM VARYING ENTRY-IDX FROM 1 BY 1 UNTIL ENTRY-IDX > FILTERED-COUNT
        PERFORM COPY-DATA-FILE USING FILTERED-ENTRIES(ENTRY-IDX), TASK-CONTEXT
        PERFORM CREATE-FILE-SCAN-TASK USING COPIED-FILE, TASK-CONTEXT
    END-PERFORM.

COPY-DATA-FILE.
    PERFORM CONTENT-FILE-COPY USING WS-PARAM-1, TASK-CONTEXT-KEEP-STATS, TASK-CONTEXT-COLUMNS-TO-KEEP.
    MOVE COPIED-FILE TO WS-PARAM-2.

CREATE-FILE-SCAN-TASK.
    MOVE SCHEMA-AS-STRING TO TASK-SCHEMA.
    MOVE SPEC-AS-STRING TO TASK-SPEC.
    MOVE RESIDUALS TO TASK-RESIDUALS.
    PERFORM CREATE-BASE-FILE-SCAN-TASK USING WS-PARAM-1, WS-PARAM-2, TASK-SCHEMA, TASK-SPEC, TASK-RESIDUALS.

IDENTIFICATION DIVISION.
PROGRAM-ID. CONTENTFILEUTIL.

ENVIRONMENT DIVISION.
REPOSITORY.
    COPY "ICEBERGUTIL.cpy".

DATA DIVISION.
WORKING-STORAGE SECTION.
01 COPIED-FILE PIC X(1000).

PROCEDURE DIVISION USING PARAM-FILE, PARAM-KEEP-STATS, PARAM-COLUMNS-TO-KEEP.
    PERFORM COPY-FILE USING PARAM-FILE, COPIED-FILE.
    IF PARAM-KEEP-STATS
        PERFORM KEEP-STATS USING COPIED-FILE, PARAM-COLUMNS-TO-KEEP
    ELSE
        PERFORM DROP-STATS USING COPIED-FILE
    END-IF.

COPY-FILE.
    MOVE PARAM-FILE TO COPIED-FILE.

KEEP-STATS.
    PERFORM VARYING COLUMN-IDX FROM 1 BY 1 UNTIL COLUMN-IDX > PARAM-COLUMN-COUNT
        IF PARAM-COLUMNS-TO-KEEP(COLUMN-IDX) = COLUMN-ID
            MOVE COLUMN-STATS TO COPIED-FILE-STATS(COLUMN-IDX)
        END-IF
    END-PERFORM.

DROP-STATS.
    INITIALIZE COPIED-FILE-STATS.

IDENTIFICATION DIVISION.
PROGRAM-ID. BASEFLESCSANTASK.

DATA DIVISION.
WORKING-STORAGE SECTION.
01 DATA-FILE PIC X(1000).
01 DELETE-FILES OCCURS 1 TO 999 DEPENDING ON DELETE-FILE-COUNT PIC X(1000).
01 DELETE-FILE-COUNT PIC 9(4) COMP.
01 TASK-SCHEMA PIC X(1000).
01 TASK-SPEC PIC X(1000).
01 TASK-RESIDUALS PIC 9(9) COMP.

PROCEDURE DIVISION USING PARAM-DATA-FILE, PARAM-DELETE-FILES, PARAM-SCHEMA, PARAM-SPEC, PARAM-RESIDUALS.
    MOVE PARAM-DATA-FILE TO DATA-FILE.
    MOVE PARAM-DELETE-FILES TO DELETE-FILES.
    MOVE PARAM-SCHEMA TO TASK-SCHEMA.
    MOVE PARAM-SPEC TO TASK-SPEC.
    MOVE PARAM-RESIDUALS TO TASK-RESIDUALS.
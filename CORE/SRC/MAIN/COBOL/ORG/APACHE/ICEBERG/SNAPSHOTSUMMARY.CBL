IDENTIFICATION DIVISION.
PROGRAM-ID. SNAPSHOTSUMMARY.

ENVIRONMENT DIVISION.
SPECIAL-NAMES.
    SYMBOLIC CHARACTERS ADDED-DATA-FILES DELETED-DATA-FILES TOTAL-DATA-FILES ADDED-DELETE-FILES ADD-EQ-DELETE-FILES REMOVED-EQ-DELETE-FILES ADD-POS-DELETE-FILES REMOVED-POS-DELETE-FILES ADDED-DVS REMOVED-DVS REMOVED-DELETE-FILES TOTAL-DELETE-FILES ADDED-RECORDS DELETED-RECORDS TOTAL-RECORDS ADDED-FILES-SIZE REMOVED-FILES-SIZE TOTAL-FILES-SIZE ADDED-POS-DELETES REMOVED-POS-DELETES TOTAL-POS-DELETES ADDED-EQ-DELETES REMOVED-EQ-DELETES TOTAL-EQ-DELETES DELETED-DUPLICATE-FILES CHANGED-PARTITION-COUNT PARTITION-SUMMARIES-INCLUDED WAP-ID PUBLISHED-WAP-ID SOURCE-SNAPSHOT-ID REPLACE-PARTITIONS IS EXTERNAL.

DATA DIVISION.
WORKING-STORAGE SECTION.
01 MAP-JOINER PIC X(80) VALUE ",,".

01 PROPERTIES-MAP.
   05 PROPERTIES-TABLE OCCURS 100 TIMES.
      10 PROPERTY-NAME PIC X(20).
      10 PROPERTY-VALUE PIC X(40).
   
01 PARTITION-METRICS-MAP.
   05 PARTITION-METRICS-TABLE OCCURS 100 TIMES.
      10 PARTITION-PATH PIC X(20).
      10 PARTITION-METRICS-RECORD.
         15 ADDED-SIZE PIC 9(18).
         15 REMOVED-SIZE PIC 9(18).
         15 ADDED-FILES PIC 9(9).
         15 REMOVED-FILES PIC 9(9).
         15 ADDED-EQ-DELETE-FILES PIC 9(9).
         15 REMOVED-EQ-DELETE-FILES PIC 9(9).
         15 ADDED-POS-DELETE-FILES PIC 9(9).
         15 REMOVED-POS-DELETE-FILES PIC 9(9).
         15 ADDED-DVS PIC 9(9).
         15 REMOVED-DVS PIC 9(9).
         15 ADDED-DELETE-FILES PIC 9(9).
         15 REMOVED-DELETE-FILES PIC 9(9).
         15 ADDED-RECORDS PIC 9(18).
         15 DELETED-RECORDS PIC 9(18).
         15 ADDED-POS-DELETES PIC 9(18).
         15 REMOVED-POS-DELETES PIC 9(18).
         15 ADDED-EQ-DELETES PIC 9(18).
         15 REMOVED-EQ-DELETES PIC 9(18).
         15 TRUST-SIZE-AND-DELETE-COUNTS PIC X.

01 METRICS-RECORD.
   15 ADDED-SIZE PIC 9(18).
   15 REMOVED-SIZE PIC 9(18).
   15 ADDED-FILES PIC 9(9).
   15 REMOVED-FILES PIC 9(9).
   15 ADDED-EQ-DELETE-FILES PIC 9(9).
   15 REMOVED-EQ-DELETE-FILES PIC 9(9).
   15 ADDED-POS-DELETE-FILES PIC 9(9).
   15 REMOVED-POS-DELETE-FILES PIC 9(9).
   15 ADDED-DVS PIC 9(9).
   15 REMOVED-DVS PIC 9(9).
   15 ADDED-DELETE-FILES PIC 9(9).
   15 REMOVED-DELETE-FILES PIC 9(9).
   15 ADDED-RECORDS PIC 9(18).
   15 DELETED-RECORDS PIC 9(18).
   15 ADDED-POS-DELETES PIC 9(18).
   15 REMOVED-POS-DELETES PIC 9(18).
   15 ADDED-EQ-DELETES PIC 9(18).
   15 REMOVED-EQ-DELETES PIC 9(18).
   15 TRUST-SIZE-AND-DELETE-COUNTS PIC X.

01 MAX-CHANGED-PARTITIONS PIC 9(9) VALUE 0.
01 DELETED-DUPLICATE-FILES PIC 9(18) VALUE 0.
01 TRUST-PARTITION-METRICS PIC X VALUE "Y".

PROCEDURE DIVISION.
    PERFORM BUILDER-INIT.
    PERFORM BUILDER-CLEAR.
    PERFORM BUILDER-SET-PARTITION-SUMMARY-LIMIT.
    PERFORM BUILDER-INCREMENT-DUPLICATE-DELETES.
    PERFORM BUILDER-ADD-ADDED-FILE.
    PERFORM BUILDER-ADD-DELETED-FILE.
    PERFORM BUILDER-ADD-MANIFEST.
    PERFORM BUILDER-SET-PROPERTY.
    PERFORM BUILDER-UPDATE-PARTITIONS.
    PERFORM BUILDER-MERGE.
    PERFORM BUILDER-BUILD.

BUILDER-INIT.
    INITIALIZE PROPERTIES-MAP.
    INITIALIZE PARTITION-METRICS-MAP.
    INITIALIZE METRICS-RECORD.

BUILDER-CLEAR.
    MOVE ZEROS TO PARTITION-METRICS-RECORD.
    MOVE "Y" TO TRUST-PARTITION-METRICS.
    MOVE 0 TO DELETED-DUPLICATE-FILES.

BUILDER-SET-PARTITION-SUMMARY-LIMIT.
    MOVE 0 TO MAX-CHANGED-PARTITIONS.

BUILDER-INCREMENT-DUPLICATE-DELETES.
    ADD 1 TO DELETED-DUPLICATE-FILES.

BUILDER-ADD-ADDED-FILE.
    PERFORM BUILDER-UPDATE-PARTITIONS VARYING PARTITION-PATH FROM 1 BY 1 UNTIL PARTITION-PATH > 100.
    ADD 1 TO ADDED-FILES OF METRICS-RECORD.
    ADD 1 TO ADDED-RECORDS OF METRICS-RECORD.

BUILDER-ADD-DELETED-FILE.
    PERFORM BUILDER-UPDATE-PARTITIONS VARYING PARTITION-PATH FROM 1 BY 1 UNTIL PARTITION-PATH > 100.
    ADD 1 TO REMOVED-FILES OF METRICS-RECORD.
    ADD 1 TO DELETED-RECORDS OF METRICS-RECORD.

BUILDER-ADD-MANIFEST.
    MOVE "N" TO TRUST-PARTITION-METRICS.
    INITIALIZE PARTITION-METRICS-MAP.
    ADD 1 TO ADDED-FILES OF METRICS-RECORD.
    ADD 1 TO REMOVED-FILES OF METRICS-RECORD.

BUILDER-SET-PROPERTY.
    PERFORM VARYING PROPERTY-NAME FROM 1 BY 1 UNTIL PROPERTY-NAME > 100
        MOVE PROPERTY-NAME TO PROPERTY-VALUE
    END-PERFORM.

BUILDER-UPDATE-PARTITIONS.
    IF TRUST-PARTITION-METRICS = "Y"
        PERFORM VARYING PARTITION-PATH FROM 1 BY 1 UNTIL PARTITION-PATH > 100
            IF PARTITION-PATH = PARTITION-PATH
                ADD 1 TO ADDED-FILES OF PARTITION-METRICS-RECORD
            ELSE
                ADD 1 TO REMOVED-FILES OF PARTITION-METRICS-RECORD
            END-IF
        END-PERFORM
    END-IF.

BUILDER-MERGE.
    PERFORM VARYING PROPERTY-NAME FROM 1 BY 1 UNTIL PROPERTY-NAME > 100
        MOVE PROPERTY-VALUE TO PROPERTIES-TABLE(PROPERTY-NAME)
    END-PERFORM.
    PERFORM VARYING PARTITION-PATH FROM 1 BY 1 UNTIL PARTITION-PATH > 100
        MOVE PARTITION-METRICS-RECORD TO PARTITION-METRICS-TABLE(PARTITION-PATH)
    END-PERFORM.
    MOVE METRICS-RECORD TO METRICS-RECORD.
    ADD DELETED-DUPLICATE-FILES TO DELETED-DUPLICATE-FILES.

BUILDER-BUILD.
    MOVE SPACE TO MAP-JOINER.
    PERFORM VARYING PROPERTY-NAME FROM 1 BY 1 UNTIL PROPERTY-NAME > 100
        IF PROPERTIES-TABLE(PROPERTY-NAME) IS NOT EQUAL TO SPACE
            STRING PROPERTY-NAME "=" PROPERTIES-TABLE(PROPERTY-NAME) DELIMITED BY "," INTO MAP-JOINER
        END-IF
    END-PERFORM.
    PERFORM VARYING PARTITION-PATH FROM 1 BY 1 UNTIL PARTITION-PATH > 100
        IF PARTITION-METRICS-TABLE(PARTITION-PATH) IS NOT EQUAL TO SPACE
            STRING CHANGED-PARTITION-PREFIX PARTITION-PATH "=" PARTITION-METRICS-TABLE(PARTITION-PATH) DELIMITED BY "," INTO MAP-JOINER
        END-IF
    END-PERFORM.
    SET ADDED-DATA-FILES TO ADDED-FILES OF METRICS-RECORD.
    SET DELETED-DATA-FILES TO REMOVED-FILES OF METRICS-RECORD.
    SET TOTAL-DATA-FILES TO ADDED-FILES OF METRICS-RECORD PLUS REMOVED-FILES OF METRICS-RECORD.
    SET ADDED-DELETE-FILES TO ADDED-DELETE-FILES OF METRICS-RECORD.
    SET ADD-EQ-DELETE-FILES TO ADDED-EQ-DELETE-FILES OF METRICS-RECORD.
    SET REMOVED-EQ-DELETE-FILES TO REMOVED-EQ-DELETE-FILES OF METRICS-RECORD.
    SET ADD-POS-DELETE-FILES TO ADDED-POS-DELETE-FILES OF METRICS-RECORD.
    SET REMOVED-POS-DELETE-FILES TO REMOVED-POS-DELETE-FILES OF METRICS-RECORD.
    SET ADDED-DVS TO ADDED-DVS OF METRICS-RECORD.
    SET REMOVED-DVS TO REMOVED-DVS OF METRICS-RECORD.
    SET REMOVED-DELETE-FILES TO REMOVED-DELETE-FILES OF METRICS-RECORD.
    SET TOTAL-DELETE-FILES TO ADDED-DELETE-FILES OF METRICS-RECORD PLUS REMOVED-DELETE-FILES OF METRICS-RECORD.
    SET ADDED-RECORDS TO ADDED-RECORDS OF METRICS-RECORD.
    SET DELETED-RECORDS TO DELETED-RECORDS OF METRICS-RECORD.
    SET TOTAL-RECORDS TO ADDED-RECORDS OF METRICS-RECORD PLUS DELETED-RECORDS OF METRICS-RECORD.
    SET ADDED-FILES-SIZE TO ADDED-SIZE OF METRICS-RECORD.
    SET REMOVED-FILES-SIZE TO REMOVED-SIZE OF METRICS-RECORD.
    SET TOTAL-FILES-SIZE TO ADDED-SIZE OF METRICS-RECORD PLUS REMOVED-SIZE OF METRICS-RECORD.
    SET ADDED-POS-DELETES TO ADDED-POS-DELETES OF METRICS-RECORD.
    SET REMOVED-POS-DELETES TO REMOVED-POS-DELETES OF METRICS-RECORD.
    SET TOTAL-POS-DELETES TO ADDED-POS-DELETES OF METRICS-RECORD PLUS REMOVED-POS-DELETES OF METRICS-RECORD.
    SET ADDED-EQ-DELETES TO ADDED-EQ-DELETES OF METRICS-RECORD.
    SET REMOVED-EQ-DELETES TO REMOVED-EQ-DELETES OF METRICS-RECORD.
    SET TOTAL-EQ-DELETES TO ADDED-EQ-DELETES OF METRICS-RECORD PLUS REMOVED-EQ-DELETES OF METRICS-RECORD.
    SET DELETED-DUPLICATE-FILES TO DELETED-DUPLICATE-FILES.
    SET CHANGED-PARTITION-COUNT TO 100.
    IF TRUST-PARTITION-METRICS = "Y" AND CHANGED-PARTITION-COUNT <= MAX-CHANGED-PARTITIONS
        SET PARTITION-SUMMARIES-INCLUDED TO "TRUE"
    ELSE
        SET PARTITION-SUMMARIES-INCLUDED TO "FALSE"
    END-IF.
    DISPLAY MAP-JOINER.

STOP RUN.
IDENTIFICATION DIVISION.
PROGRAM-ID. TABLEMETADATAPARSER.

ENVIRONMENT DIVISION.
INPUT-OUTPUT SECTION.
FILE-CONTROL.
    SELECT OUTPUTFILE ASSIGN TO DYNAMIC OUTPUTFILE.
    SELECT INPUTFILE ASSIGN TO DYNAMIC INPUTFILE.

DATA DIVISION.
FILE SECTION.
    FD OUTPUTFILE.
    01 OUTPUTRECORD PIC X(32500).
    FD INPUTFILE.
    01 INPUTRECORD PIC X(32500).

WORKING-STORAGE SECTION.
    01 WS-FORMAT-VERSION PIC 9(9) COMP.
    01 WS-TABLE-UUID PIC X(36).
    01 WS-LOCATION PIC X(256).
    01 WS-LAST-SEQUENCE-NUMBER PIC 9(18) COMP.
    01 WS-LAST-UPDATED-MILLIS PIC 9(18) COMP.
    01 WS-LAST-COLUMN-ID PIC 9(9) COMP.
    01 WS-CURRENT-SCHEMA-ID PIC 9(9) COMP.
    01 WS-SCHEMAS-COUNT PIC 9(9) COMP.
    01 WS-SCHEMA-TABLE.
        05 WS-SCHEMA-ENTRY OCCURS 32 TIMES.
            10 WS-SCHEMA-ID PIC 9(9) COMP.
            10 WS-SCHEMA-DATA PIC X(32500).
    01 WS-DEFAULT-SPEC-ID PIC 9(9) COMP.
    01 WS-PARTITION-SPECS-COUNT PIC 9(9) COMP.
    01 WS-PARTITION-SPEC-TABLE.
        05 WS-PARTITION-SPEC-ENTRY OCCURS 32 TIMES.
            10 WS-PARTITION-SPEC-ID PIC 9(9) COMP.
            10 WS-PARTITION-SPEC-DATA PIC X(32500).
    01 WS-LAST-PARTITION-ID PIC 9(9) COMP.
    01 WS-DEFAULT-SORT-ORDER-ID PIC 9(9) COMP.
    01 WS-SORT-ORDERS-COUNT PIC 9(9) COMP.
    01 WS-SORT-ORDER-TABLE.
        05 WS-SORT-ORDER-ENTRY OCCURS 32 TIMES.
            10 WS-SORT-ORDER-ID PIC 9(9) COMP.
            10 WS-SORT-ORDER-DATA PIC X(32500).
    01 WS-PROPERTIES-COUNT PIC 9(9) COMP.
    01 WS-PROPERTIES-TABLE.
        05 WS-PROPERTY-ENTRY OCCURS 1024 TIMES.
            10 WS-PROPERTY-NAME PIC X(128).
            10 WS-PROPERTY-VALUE PIC X(128).
    01 WS-CURRENT-SNAPSHOT-ID PIC 9(18) COMP.
    01 WS-ROW-LINEAGE PIC 9(1) COMP-X.
    01 WS-NEXT-ROW-ID PIC 9(18) COMP.
    01 WS-REFS-COUNT PIC 9(9) COMP.
    01 WS-REFS-TABLE.
        05 WS-REF-ENTRY OCCURS 32 TIMES.
            10 WS-REF-NAME PIC X(128).
            10 WS-REF-DATA PIC X(32500).
    01 WS-SNAPSHOTS-COUNT PIC 9(9) COMP.
    01 WS-SNAPSHOTS-TABLE.
        05 WS-SNAPSHOT-ENTRY OCCURS 32 TIMES.
            10 WS-SNAPSHOT-DATA PIC X(32500).
    01 WS-STATISTICS-FILES-COUNT PIC 9(9) COMP.
    01 WS-STATISTICS-FILES-TABLE.
        05 WS-STATISTICS-FILE-ENTRY OCCURS 32 TIMES.
            10 WS-STATISTICS-FILE-DATA PIC X(32500).
    01 WS-PARTITION-STATISTICS-FILES-COUNT PIC 9(9) COMP.
    01 WS-PARTITION-STATISTICS-FILES-TABLE.
        05 WS-PARTITION-STATISTICS-FILE-ENTRY OCCURS 32 TIMES.
            10 WS-PARTITION-STATISTICS-FILE-DATA PIC X(32500).
    01 WS-SNAPSHOT-LOG-COUNT PIC 9(9) COMP.
    01 WS-SNAPSHOT-LOG-TABLE.
        05 WS-SNAPSHOT-LOG-ENTRY OCCURS 32 TIMES.
            10 WS-SNAPSHOT-LOG-TIMESTAMP PIC 9(18) COMP.
            10 WS-SNAPSHOT-LOG-ID PIC 9(18) COMP.
    01 WS-METADATA-LOG-COUNT PIC 9(9) COMP.
    01 WS-METADATA-LOG-TABLE.
        05 WS-METADATA-LOG-ENTRY OCCURS 32 TIMES.
            10 WS-METADATA-LOG-TIMESTAMP PIC 9(18) COMP.
            10 WS-METADATA-LOG-FILE PIC X(256).

PROCEDURE DIVISION.
    MAIN-PROCEDURE.
        PERFORM HANDLE-OVERWRITE.
        PERFORM HANDLE-WRITE.
        PERFORM HANDLE-FILE-EXTENSION.
        PERFORM HANDLE-TO-JSON.
        PERFORM HANDLE-READ.
        PERFORM HANDLE-FROM-JSON.

    HANDLE-OVERWRITE.
        CALL "internalWrite" USING OUTPUTFILE, WS-TABLE-METADATA, TRUE.

    HANDLE-WRITE.
        CALL "internalWrite" USING OUTPUTFILE, WS-TABLE-METADATA, FALSE.

    HANDLE-FILE-EXTENSION.
        CALL "getFileExtension" USING WS-CODEC-NAME GIVING WS-FILE-EXTENSION.
        CALL "getFileExtension" USING WS-CODEC GIVING WS-FILE-EXTENSION.
        CALL "getOldFileExtension" USING WS-CODEC GIVING WS-FILE-EXTENSION.

    HANDLE-TO-JSON.
        CALL "toJson" USING WS-TABLE-METADATA GIVING WS-JSON-STRING.
        CALL "toJson" USING WS-TABLE-METADATA, WS-JSON-GENERATOR.

    HANDLE-READ.
        CALL "read" USING WS-FILE-IO, WS-INPUT-FILE GIVING WS-TABLE-METADATA.
        CALL "read" USING WS-FILE-IO, WS-PATH GIVING WS-TABLE-METADATA.

    HANDLE-FROM-JSON.
        CALL "fromJson" USING WS-METADATA-LOCATION, WS-JSON-STRING GIVING WS-TABLE-METADATA.
        CALL "fromJson" USING WS-METADATA-LOCATION, WS-JSON-NODE GIVING WS-TABLE-METADATA.
        CALL "fromJson" USING WS-INPUT-FILE, WS-JSON-NODE GIVING WS-TABLE-METADATA.
        CALL "fromJson" USING WS-JSON-NODE GIVING WS-TABLE-METADATA.

    STOP RUN.
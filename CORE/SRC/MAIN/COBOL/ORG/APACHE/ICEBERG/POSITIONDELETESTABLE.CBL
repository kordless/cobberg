IDENTIFICATION DIVISION.
PROGRAM-ID. POSITION-DELETES-TABLE.

ENVIRONMENT DIVISION.
REPOSITORY.
    COPY ID-NAMES FROM ICEBERG.

DATA DIVISION.
WORKING-STORAGE SECTION.
01 SCHEMA-OBJECT.
   02 SCHEMA-STRING PIC X(1024).
01 TRANSFORMED-SPECS.
   02 SPEC-ID PIC 9(9) BINARY.
   02 SPEC-JSON PIC X(1024).
01 CACHES.
   02 DELETES-TABLE-EVAL-CACHE.
      03 SPEC-ID PIC 9(9) BINARY.
      03 EVAL-OBJECT PIC X(1024).
   02 BASE-TABLE-EVAL-CACHE.
      03 SPEC-ID PIC 9(9) BINARY.
      03 EVAL-OBJECT PIC X(1024).
   02 RESIDUAL-CACHE.
      03 SPEC-ID PIC 9(9) BINARY.
      03 EVAL-OBJECT PIC X(1024).
   02 SPEC-STRING-CACHE.
      03 SPEC-ID PIC 9(9) BINARY.
      03 SPEC-JSON PIC X(1024).

PROCEDURE DIVISION.
MAIN-PROCEDURE.
    PERFORM CALCULATE-SCHEMA.
    PERFORM TRANSFORM-SPECS.
    PERFORM PLAN-FILES.

CALCULATE-SCHEMA.
    MOVE TABLE-NAME(1) TO SCHEMA-STRING.
    PERFORM VARYING I FROM 1 BY 1 UNTIL I > LENGTH OF SCHEMA-STRING
        IF SCHEMA-STRING(I:1) = '.'
            MOVE SCHEMA-STRING(1:I-1) TO SCHEMA-NAME
            MOVE SCHEMA-STRING(I+1) TO SCHEMA-OBJECT-NAME
            EXIT PARAGRAPH
        END-IF
    END-PERFORM.
    PERFORM REASSIGN-PARTITION-IDS.
    MOVE NEW-SCHEMA TO SCHEMA-OBJECT.

TRANSFORM-SPECS.
    PERFORM VARYING SPEC-ID FROM 1 BY 1 UNTIL SPEC-ID > COUNT OF TABLE-SPECS
        MOVE SPEC-ID TO SPEC-ID OF TRANSFORMED-SPECS
        MOVE PARTITION-SPEC-JSON(SPEC-ID) TO SPEC-JSON OF TRANSFORMED-SPECS
        MOVE TRANSFORMED-SPECS TO SPEC-CACHE
    END-PERFORM.

PLAN-FILES.
    PERFORM VARYING MANIFEST-ID FROM 1 BY 1 UNTIL MANIFEST-ID > COUNT OF DELETE-MANIFESTS
        MOVE MANIFEST-ID TO MANIFEST-FILE-ID
        PERFORM FILTER-MANIFESTS
        PERFORM PLAN-TASKS
    END-PERFORM.

FILTER-MANIFESTS.
    MOVE MANIFEST-PARTITION-SPEC-ID(MANIFEST-FILE-ID) TO SPEC-ID OF BASE-TABLE-EVAL-CACHE
    MOVE MANIFEST-PARTITION-SPEC-ID(MANIFEST-FILE-ID) TO SPEC-ID OF DELETES-TABLE-EVAL-CACHE
    PERFORM EVALUATE-BASE-TABLE-FILTER
    PERFORM EVALUATE-DELETES-TABLE-FILTER
    IF BASE-TABLE-FILTER-PASSED AND DELETES-TABLE-FILTER-PASSED
        MOVE MANIFEST-FILE-ID TO MATCHING-MANIFESTS
    END-IF.

EVALUATE-BASE-TABLE-FILTER.
    MOVE BASE-TABLE-EVAL-CACHE(SPEC-ID) TO EVAL-OBJECT
    PERFORM EVALUATE-FILTER.

EVALUATE-DELETES-TABLE-FILTER.
    MOVE DELETES-TABLE-EVAL-CACHE(SPEC-ID) TO EVAL-OBJECT
    PERFORM EVALUATE-FILTER.

EVALUATE-FILTER.
    CALL "MANIFEST-EVALUATOR-EVAL" USING EVAL-OBJECT, MANIFEST-FILE
    IF RETURN-CODE = 0
        MOVE TRUE TO FILTER-PASSED
    ELSE
        MOVE FALSE TO FILTER-PASSED
    END-IF.

PLAN-TASKS.
    MOVE MANIFEST-PARTITION-SPEC-ID(MANIFEST-FILE-ID) TO SPEC-ID OF SPEC-STRING-CACHE
    MOVE MANIFEST-PARTITION-SPEC-ID(MANIFEST-FILE-ID) TO SPEC-ID OF RESIDUAL-CACHE
    PERFORM CREATE-POSITION-DELETES-SCAN-TASKS.

CREATE-POSITION-DELETES-SCAN-TASKS.
    MOVE SCHEMA-STRING TO SCHEMA-OBJECT
    MOVE SPEC-STRING-CACHE(SPEC-ID) TO SPEC-JSON
    MOVE RESIDUAL-CACHE(SPEC-ID) TO RESIDUAL-EVALUATOR
    PERFORM VARYING ENTRY-ID FROM 1 BY 1 UNTIL ENTRY-ID > COUNT OF MANIFEST-ENTRIES
        IF MANIFEST-ENTRY-FILE-CONTENT(ENTRY-ID) = POSITION-DELETES
            PERFORM CREATE-SCAN-TASK
        END-IF
    END-PERFORM.

CREATE-SCAN-TASK.
    MOVE MANIFEST-ENTRY-FILE(ENTRY-ID) TO SCAN-TASK-FILE
    MOVE SCHEMA-OBJECT TO SCAN-TASK-SCHEMA
    MOVE SPEC-JSON TO SCAN-TASK-SPEC-JSON
    MOVE RESIDUAL-EVALUATOR TO SCAN-TASK-RESIDUAL-EVALUATOR
    ADD SCAN-TASK TO TASKS-LIST.

REASSIGN-PARTITION-IDS.
    PERFORM VARYING FIELD-ID FROM 1 BY 1 UNTIL FIELD-ID > COUNT OF SCHEMA-FIELDS
        IF SCHEMA-FIELD-ID(FIELD-ID) IN PARTITION-IDS
            PERFORM FIND-AVAILABLE-ID
            MOVE NEW-ID TO SCHEMA-FIELD-ID(FIELD-ID)
        END-IF
    END-PERFORM.

FIND-AVAILABLE-ID.
    MOVE 1 TO CANDIDATE-ID
    PERFORM UNTIL CANDIDATE-ID NOT IN USED-IDS
        ADD 1 TO CANDIDATE-ID
    END-PERFORM.
    MOVE CANDIDATE-ID TO NEW-ID.

END PROGRAM POSITION-DELETES-TABLE.
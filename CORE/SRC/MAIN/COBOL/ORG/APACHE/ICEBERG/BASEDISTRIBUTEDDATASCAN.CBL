IDENTIFICATION DIVISION.
PROGRAM-ID. BASE-DISTRIBUTED-DATA-SCAN.

ENVIRONMENT DIVISION.
INPUT-OUTPUT SECTION.
FILE-CONTROL.
    SELECT MANIFEST-FILE ASSIGN TO EXTERNAL ORGANIZATION IS LINE SEQUENTIAL.
    SELECT DATA-FILE ASSIGN TO EXTERNAL ORGANIZATION IS LINE SEQUENTIAL.

DATA DIVISION.
WORKING-STORAGE SECTION.
01 LOCAL-PARALLELISM PIC 9(5) VALUE 1.
01 LOCAL-PLANNING-SIZE-THRESHOLD PIC 9(10) VALUE 128000000.
01 MONITOR-POOL-SIZE PIC 9(5) VALUE 2.

01 WS-SNAPSHOT.
   05 WS-DATA-MANIFESTS PIC X(30) OCCURS 50 TIMES.
   05 WS-DELETE-MANIFESTS PIC X(30) OCCURS 50 TIMES.
   05 WS-TOTAL-DATA-MANIFESTS PIC 9(5).
   05 WS-TOTAL-DELETE-MANIFESTS PIC 9(5).
   05 WS-SKIPPED-DATA-MANIFESTS PIC 9(5).
   05 WS-SKIPPED-DELETE-MANIFESTS PIC 9(5).

01 WS-MANIFEST-EVALUATOR-CACHE.
   05 SPEC-ID PIC 9(5) OCCURS 50 TIMES.
   05 MANIFEST-EVALUATOR PIC X(30) OCCURS 50 TIMES.

01 WS-RESIDUAL-EVALUATOR-CACHE.
   05 SPEC-ID PIC 9(5) OCCURS 50 TIMES.
   05 RESIDUAL-EVALUATOR PIC X(30) OCCURS 50 TIMES.

01 WS-SCHEMA-JSON PIC X(1000).
01 WS-SPEC-JSON-CACHE.
   05 SPEC-ID PIC 9(5) OCCURS 50 TIMES.
   05 SPEC-JSON PIC X(1000) OCCURS 50 TIMES.

PROCEDURE DIVISION.
    PERFORM DO-PLAN-FILES.
    PERFORM DO-PLAN-TASKS.

DO-PLAN-FILES.
    PERFORM FIND-MATCHING-DATA-MANIFESTS.
    PERFORM FIND-MATCHING-DELETE-MANIFESTS.
    PERFORM PLAN-FILE-TASKS-LOCALLY.

FIND-MATCHING-DATA-MANIFESTS.
    MOVE 0 TO WS-TOTAL-DATA-MANIFESTS.
    MOVE 0 TO WS-SKIPPED-DATA-MANIFESTS.
    PERFORM VARYING I FROM 1 BY 1 UNTIL I > WS-TOTAL-DATA-MANIFESTS
        IF WS-DATA-MANIFESTS(I) HAS ADDED-FILES OR HAS EXISTING-FILES
            PERFORM FILTER-MANIFEST
        ELSE
            ADD 1 TO WS-SKIPPED-DATA-MANIFESTS
        END-IF
    END-PERFORM.

FIND-MATCHING-DELETE-MANIFESTS.
    MOVE 0 TO WS-TOTAL-DELETE-MANIFESTS. 
    MOVE 0 TO WS-SKIPPED-DELETE-MANIFESTS.
    PERFORM VARYING I FROM 1 BY 1 UNTIL I > WS-TOTAL-DELETE-MANIFESTS
        IF WS-DELETE-MANIFESTS(I) HAS ADDED-FILES OR HAS EXISTING-FILES
            PERFORM FILTER-MANIFEST
        ELSE
            ADD 1 TO WS-SKIPPED-DELETE-MANIFESTS
        END-IF
    END-PERFORM.

FILTER-MANIFEST.
    PERFORM LOOKUP-MANIFEST-EVALUATOR.
    IF MANIFEST-EVALUATOR EVALUATES WS-MANIFEST(I)
        CONTINUE
    ELSE
        MOVE I TO SPEC-ID
        MOVE NULL TO MANIFEST-EVALUATOR
    END-IF.

LOOKUP-MANIFEST-EVALUATOR.
    PERFORM VARYING J FROM 1 BY 1 UNTIL J > 50 OR SPEC-ID(J) = MANIFEST-SPEC-ID
        IF SPEC-ID(J) = MANIFEST-SPEC-ID
            MOVE MANIFEST-EVALUATOR(J) TO MANIFEST-EVALUATOR
            EXIT PARAGRAPH
        END-IF
    END-PERFORM.
    IF J > 50
        MOVE NEW-MANIFEST-EVALUATOR TO MANIFEST-EVALUATOR
        MOVE MANIFEST-SPEC-ID TO SPEC-ID(J)
        MOVE MANIFEST-EVALUATOR TO MANIFEST-EVALUATOR(J)
    END-IF.

NEW-MANIFEST-EVALUATOR.
    PERFORM GET-PROJECTION.
    MOVE NEW-MANIFEST-EVALUATOR(PROJECTION, MANIFEST-SPEC, CASE-SENSITIVE) TO MANIFEST-EVALUATOR.

PLAN-FILE-TASKS-LOCALLY.
    PERFORM NEW-MANIFEST-GROUP.
    MOVE MANIFEST-GROUP-PLAN-FILES TO RETURN-VALUE.

DO-PLAN-TASKS.
    MOVE NEW-TASK-GROUPS(RETURN-VALUE, TARGET-SPLIT-SIZE, SPLIT-LOOKBACK, SPLIT-OPEN-FILE-COST) TO RETURN-VALUE.

STOP RUN.
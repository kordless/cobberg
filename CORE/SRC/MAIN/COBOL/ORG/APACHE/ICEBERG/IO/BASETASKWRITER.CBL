IDENTIFICATION DIVISION.
PROGRAM-ID. BASE-TASK-WRITER.

ENVIRONMENT DIVISION.
REPOSITORY.
    COPY "ICEBERG-SCHEMAS.CBL".

DATA DIVISION.
WORKING-STORAGE SECTION.
01 COMPLETED-DATA-FILES PIC X(1024) VALUE SPACES.
01 COMPLETED-DELETE-FILES PIC X(1024) VALUE SPACES.
01 REFERENCED-DATA-FILES PIC X(1024) VALUE SPACES.

01 SPEC PIC X(32) VALUE SPACES.
01 FORMAT PIC X(16) VALUE SPACES.
01 APPENDER-FACTORY PIC X(32) VALUE SPACES.
01 FILE-FACTORY PIC X(32) VALUE SPACES.
01 IO PIC X(16) VALUE SPACES.
01 TARGET-FILE-SIZE PIC 9(18) COMP-3 VALUE 0.

01 FAILURE PIC X(256) VALUE SPACES.

PROCEDURE DIVISION.
BASE-TASK-WRITER-PARAGRAPH.
    INITIALIZE COMPLETED-DATA-FILES
    INITIALIZE COMPLETED-DELETE-FILES 
    INITIALIZE REFERENCED-DATA-FILES

    MOVE PARTITION-SPEC TO SPEC
    MOVE FILE-FORMAT TO FORMAT
    MOVE FILE-APPENDER-FACTORY TO APPENDER-FACTORY
    MOVE OUTPUT-FILE-FACTORY TO FILE-FACTORY
    MOVE FILE-IO TO IO
    MOVE TARGET-FILE-SIZE-BYTES TO TARGET-FILE-SIZE

    PERFORM ABORT-PARAGRAPH
    PERFORM COMPLETE-PARAGRAPH

ABORT-PARAGRAPH.
    PERFORM CLOSE-PARAGRAPH
    PERFORM CLEANUP-FILES

COMPLETE-PARAGRAPH.
    PERFORM CLOSE-PARAGRAPH
    IF FAILURE IS EQUAL TO SPACES
        RETURN WRITE-RESULT
    ELSE
        RAISE EXCEPTION FAILURE

CLOSE-PARAGRAPH.
    IF FAILURE IS EQUAL TO SPACES
        PERFORM CLOSE-EQUALITY-DELTA-WRITER
    ELSE 
        RAISE EXCEPTION FAILURE

CLEANUP-FILES.
    PERFORM VARYING ITEM FROM 1 BY 1 UNTIL ITEM > COUNT(COMPLETED-DATA-FILES)
        DELETE FILE COMPLETED-DATA-FILES(ITEM)
    END-PERFORM
    PERFORM VARYING ITEM FROM 1 BY 1 UNTIL ITEM > COUNT(COMPLETED-DELETE-FILES) 
        DELETE FILE COMPLETED-DELETE-FILES(ITEM)
    END-PERFORM

CLOSE-EQUALITY-DELTA-WRITER.
    PERFORM CLOSE DATA-WRITER
    PERFORM CLOSE EQ-DELETE-WRITER
    PERFORM CLOSE POS-DELETE-WRITER

CLOSE-DATA-WRITER.
    IF DATA-WRITER NOT EQUAL TO SPACES
        CLOSE DATA-WRITER
        IF DATA-WRITER-ROWS EQUAL TO 0
            DELETE DATA-WRITER-FILE
        ELSE
            MOVE DATA-WRITER-FILE TO COMPLETED-DATA-FILES
        END-IF
        MOVE SPACES TO DATA-WRITER
        MOVE 0 TO DATA-WRITER-ROWS
    END-IF

CLOSE-EQ-DELETE-WRITER.
    IF EQ-DELETE-WRITER NOT EQUAL TO SPACES
        CLOSE EQ-DELETE-WRITER
        MOVE EQ-DELETE-WRITER-FILE TO COMPLETED-DELETE-FILES
        MOVE SPACES TO EQ-DELETE-WRITER
        MOVE 0 TO EQ-DELETE-WRITER-ROWS
    END-IF

CLOSE-POS-DELETE-WRITER.
    IF POS-DELETE-WRITER NOT EQUAL TO SPACES
        CLOSE POS-DELETE-WRITER
        PERFORM DELETE-RESULT-PARAGRAPH
        MOVE SPACES TO POS-DELETE-WRITER
    END-IF

DELETE-RESULT-PARAGRAPH.
    MOVE POS-DELETE-WRITER-DELETE-FILES TO COMPLETED-DELETE-FILES
    MOVE POS-DELETE-WRITER-REFERENCED-FILES TO REFERENCED-DATA-FILES

WRITE-RESULT.
    RETURN
        ADDITING COMPLETED-DATA-FILES
        ADDITING COMPLETED-DELETE-FILES
        ADDITING REFERENCED-DATA-FILES.
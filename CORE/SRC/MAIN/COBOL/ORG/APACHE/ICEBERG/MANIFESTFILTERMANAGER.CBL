IDENTIFICATION DIVISION.
PROGRAM-ID. MANIFEST-FILTER-MANAGER.

ENVIRONMENT DIVISION.
REPOSITORY.
    COPY "ICEBERG-EXCEPTIONS".
    COPY "ICEBERG-EXPRESSIONS".
    COPY "ICEBERG-UTIL".

DATA DIVISION.
WORKING-STORAGE SECTION.
01 SPECS-BY-ID PIC X(10) OCCURS 9999 TIMES.
01 DELETE-FILE-PARTITIONS PIC X(50) OCCURS 9999 TIMES.
01 DELETE-FILES PIC X(50) OCCURS 9999 TIMES.
01 MANIFESTS-WITH-DELETES PIC X(50) OCCURS 9999 TIMES.
01 DROP-PARTITIONS PIC X(50) OCCURS 9999 TIMES.
01 DELETE-PATHS PIC X(50) OCCURS 9999 TIMES.
01 DELETE-EXPRESSION PIC X(100).
01 MIN-SEQUENCE-NUMBER PIC 9(18).
01 FAIL-ANY-DELETE PIC X(1) VALUE "N".
01 FAIL-MISSING-DELETE-PATHS PIC X(1) VALUE "N".
01 DUPLICATE-DELETE-COUNT PIC 9(9).
01 CASE-SENSITIVE PIC X(1) VALUE "Y".
01 ALL-DELETES-REFERENCE-MANIFESTS PIC X(1) VALUE "Y".
01 FILTERED-MANIFESTS PIC X(50) OCCURS 9999 TIMES.
01 FILTERED-MANIFEST-TO-DELETED-FILES PIC X(50) OCCURS 9999 TIMES.
01 WORKER-POOL-SUPPLIER PIC X(10).

PROCEDURE DIVISION.

    PERFORM DELETE-FILE.
    PERFORM NEW-MANIFEST-WRITER.
    PERFORM NEW-MANIFEST-READER.
    PERFORM NEW-FILE-SET.

    PERFORM FAIL-ANY-DELETE-ROUTINE.
    PERFORM FAIL-MISSING-DELETE-PATHS-ROUTINE.

    PERFORM DELETE-BY-ROW-FILTER.
    PERFORM DROP-PARTITION.
    PERFORM DROP-DELETE-FILES-OLDER-THAN.
    PERFORM CASE-SENSITIVE-ROUTINE.

    PERFORM DELETE-FILE-ROUTINE.
    PERFORM DELETE-PATH-ROUTINE.

    PERFORM CONTAINS-DELETES-ROUTINE.
    PERFORM FILTER-MANIFESTS.
    PERFORM BUILD-SUMMARY.
    PERFORM VALIDATE-REQUIRED-DELETES.
    PERFORM CLEAN-UNCOMMITTED.
    PERFORM INVALIDATE-FILTERED-CACHE.

    PERFORM FILTER-MANIFEST.
    PERFORM CAN-CONTAIN-DELETED-FILES.
    PERFORM MANIFEST-HAS-DELETED-FILES.
    PERFORM FILTER-MANIFEST-WITH-DELETED-FILES.

    PERFORM PARTITION-AND-METRICS-EVALUATOR.

DELETE-FILE.
    PERFORM DELETEFILEAT USING LOCATION.

NEW-MANIFEST-WRITER.
    PERFORM NEWMANIFESTWRITER USING SPEC RETURNING WRITER.

NEW-MANIFEST-READER.
    PERFORM NEWMANIFESTREADER USING MANIFEST RETURNING READER.

NEW-FILE-SET.
    PERFORM NEWFILESET RETURNING FILE-SET.

FAIL-ANY-DELETE-ROUTINE.
    MOVE "Y" TO FAIL-ANY-DELETE.

FAIL-MISSING-DELETE-PATHS-ROUTINE.
    MOVE "Y" TO FAIL-MISSING-DELETE-PATHS.

DELETE-BY-ROW-FILTER.
    MOVE EXPR TO DELETE-EXPRESSION.
    MOVE "N" TO ALL-DELETES-REFERENCE-MANIFESTS.

DROP-PARTITION.
    MOVE SPEC-ID TO DROP-PARTITIONS(DROP-PARTITIONS-INDEX).
    MOVE PARTITION TO DROP-PARTITIONS(DROP-PARTITIONS-INDEX + 1).
    MOVE "N" TO ALL-DELETES-REFERENCE-MANIFESTS.

DROP-DELETE-FILES-OLDER-THAN.
    MOVE SEQUENCE-NUMBER TO MIN-SEQUENCE-NUMBER.

CASE-SENSITIVE-ROUTINE.
    MOVE CASE-SENSITIVE-FLAG TO CASE-SENSITIVE.

DELETE-FILE-ROUTINE.
    MOVE FILE TO DELETE-FILES(DELETE-FILES-INDEX).
    MOVE FILE-SPEC-ID TO DELETE-FILE-PARTITIONS(DELETE-FILE-PARTITIONS-INDEX).
    MOVE FILE-PARTITION TO DELETE-FILE-PARTITIONS(DELETE-FILE-PARTITIONS-INDEX + 1).
    PERFORM INVALIDATE-FILTERED-CACHE.

    IF FILE-MANIFEST-LOCATION IS NULL
        MOVE "N" TO ALL-DELETES-REFERENCE-MANIFESTS
    ELSE
        MOVE FILE-MANIFEST-LOCATION TO MANIFESTS-WITH-DELETES(MANIFESTS-WITH-DELETES-INDEX).
    END-IF.

DELETE-PATH-ROUTINE.
    MOVE PATH TO DELETE-PATHS(DELETE-PATHS-INDEX).
    PERFORM INVALIDATE-FILTERED-CACHE.
    MOVE "N" TO ALL-DELETES-REFERENCE-MANIFESTS.

CONTAINS-DELETES-ROUTINE.
    IF DELETE-PATHS IS NOT EMPTY OR
       DELETE-FILES IS NOT EMPTY OR
       DELETE-EXPRESSION IS NOT EQUAL TO EXPRESSIONS-ALWAYS-FALSE OR
       DROP-PARTITIONS IS NOT EMPTY
        RETURN TRUE
    ELSE
        RETURN FALSE
    END-IF.

FILTER-MANIFESTS.
    IF MANIFESTS IS NULL OR MANIFESTS IS EMPTY
        PERFORM VALIDATE-REQUIRED-DELETES
        RETURN EMPTY-LIST
    END-IF.

    MOVE TRUE TO TRUST-MANIFEST-REFERENCES.
    PERFORM VARYING I FROM 1 BY 1 UNTIL I > LENGTH OF MANIFESTS
        PERFORM FILTER-MANIFEST USING SCHEMA, MANIFESTS(I), TRUST-MANIFEST-REFERENCES
            RETURNING FILTERED(I)
    END-PERFORM.

    PERFORM VALIDATE-REQUIRED-DELETES USING FILTERED.
    RETURN FILTERED.

BUILD-SUMMARY.
    PERFORM SUMMARY-BUILDER.

    PERFORM VARYING I FROM 1 BY 1 UNTIL I > LENGTH OF FILTERED
        PERFORM MANIFEST-SPEC USING FILTERED(I) RETURNING SPEC.
        PERFORM FILTERED-MANIFEST-DELETES USING FILTERED(I) RETURNING MANIFEST-DELETES.
        PERFORM VARYING J FROM 1 BY 1 UNTIL J > LENGTH OF MANIFEST-DELETES
            PERFORM SUMMARY-BUILDER-DELETE-FILE USING SPEC, MANIFEST-DELETES(J).
        END-PERFORM.
    END-PERFORM.

    MOVE DUPLICATE-DELETE-COUNT TO SUMMARY-BUILDER-DUPLICATE-DELETES.
    RETURN SUMMARY-BUILDER.

VALIDATE-REQUIRED-DELETES.
    IF FAIL-MISSING-DELETE-PATHS = "Y"
        PERFORM DELETED-FILES USING MANIFESTS RETURNING DELETED-FILES-SET.
        PERFORM VALIDATE-DELETE-FILES USING DELETE-FILES, DELETED-FILES-SET.
        PERFORM VALIDATE-DELETE-PATHS USING DELETE-PATHS, DELETED-FILES-SET.
    END-IF.

CLEAN-UNCOMMITTED.
    PERFORM VARYING ENTRY IN FILTERED-MANIFESTS
        IF COMMITTED DOES NOT CONTAIN FILTERED-MANIFESTS(ENTRY)
            IF FILTERED-MANIFESTS(ENTRY) IS NOT EQUAL TO MANIFESTS(ENTRY)
                PERFORM DELETEFILEAT USING FILTERED-MANIFESTS(ENTRY).
            END-IF.
            REMOVE ENTRY FROM FILTERED-MANIFESTS.
        END-IF.
    END-PERFORM.

INVALIDATE-FILTERED-CACHE.
    PERFORM CLEAN-UNCOMMITTED USING EMPTY-SET.

FILTER-MANIFEST.
    PERFORM LOOKUP-FILTERED-MANIFEST USING MANIFEST RETURNING CACHED-MANIFEST.
    IF CACHED-MANIFEST IS NOT NULL
        RETURN CACHED-MANIFEST
    END-IF.

    PERFORM CAN-CONTAIN-DELETED-FILES USING MANIFEST, TRUST-MANIFEST-REFERENCES
        RETURNING CAN-CONTAIN.
    IF NOT CAN-CONTAIN
        MOVE MANIFEST TO FILTERED-MANIFESTS(FILTERED-MANIFESTS-INDEX).
        RETURN MANIFEST.
    END-IF.

    PERFORM OPEN-MANIFEST-READER USING MANIFEST RETURNING READER.
    PERFORM PARTITION-AND-METRICS-EVALUATOR USING SCHEMA, READER-SPEC, DELETE-EXPRESSION
        RETURNING EVALUATOR.
    PERFORM MANIFEST-HAS-DELETED-FILES USING EVALUATOR, MANIFEST, READER
        RETURNING HAS-DELETES.
    IF HAS-DELETES
        PERFORM FILTER-MANIFEST-WITH-DELETED-FILES USING EVALUATOR, MANIFEST, READER
            RETURNING FILTERED-MANIFEST.
    ELSE
        MOVE MANIFEST TO FILTERED-MANIFESTS(FILTERED-MANIFESTS-INDEX).
        RETURN MANIFEST.
    END-IF.

CAN-CONTAIN-DELETED-FILES.
    PERFORM HAS-NO-LIVE-FILES USING MANIFEST RETURNING NO-LIVE.
    IF NO-LIVE
        RETURN FALSE.
    END-IF.

    IF TRUST-MANIFEST-REFERENCES
        RETURN MANIFESTS-WITH-DELETES CONTAINS MANIFEST-PATH.
    END-IF.

    PERFORM CAN-CONTAIN-DROPPED-FILES USING MANIFEST RETURNING CAN-CONTAIN-DROPPED.
    PERFORM CAN-CONTAIN-EXPRESSION-DELETES USING MANIFEST RETURNING CAN-CONTAIN-EXPR.
    PERFORM CAN-CONTAIN-DROPPED-PARTITIONS USING MANIFEST RETURNING CAN-CONTAIN-PARTITIONS.

    RETURN CAN-CONTAIN-DROPPED OR CAN-CONTAIN-EXPR OR CAN-CONTAIN-PARTITIONS.

MANIFEST-HAS-DELETED-FILES.
    IF MANIFESTS-WITH-DELETES CONTAINS MANIFEST-PATH
        RETURN TRUE.
    END-IF.

    PERFORM IS-DELETE-MANIFEST USING READER RETURNING IS-DELETE.

    PERFORM VARYING ENTRY IN READER-LIVE-ENTRIES
        PERFORM FILE-MARKED-FOR-DELETE USING ENTRY, IS-DELETE RETURNING MARKED-FOR-DELETE.
        IF MARKED-FOR-DELETE OR EVALUATOR-ROWS-MIGHT-MATCH(ENTRY-FILE)
            PERFORM MUST-MATCH-EXPRESSION USING ENTRY, IS-DELETE RETURNING MUST-MATCH.
            IF MUST-MATCH
                RETURN TRUE.
            END-IF.
        END-IF.
    END-PERFORM.

    RETURN FALSE.

FILTER-MANIFEST-WITH-DELETED-FILES.
    PERFORM NEW-MANIFEST-WRITER USING READER-SPEC RETURNING WRITER.

    PERFORM VARYING ENTRY IN READER-LIVE-ENTRIES
        PERFORM FILE-MARKED-FOR-DELETE USING ENTRY, IS-DELETE RETURNING MARKED-FOR-DELETE.
        IF MARKED-FOR-DELETE OR EVALUATOR-ROWS-MIGHT-MATCH(ENTRY-FILE)
            PERFORM MUST-MATCH-EXPRESSION USING ENTRY, IS-DELETE RETURNING MUST-MATCH.
            IF MUST-MATCH
                PERFORM WRITER-DELETE USING ENTRY.
                PERFORM ADD-DELETED-FILE USING ENTRY-FILE.
            ELSE
                PERFORM WRITER-EXISTING USING ENTRY.
            END-IF.
        ELSE
            PERFORM WRITER-EXISTING USING ENTRY.
        END-IF.
    END-PERFORM.

    PERFORM WRITER-CLOSE.
    MOVE WRITER-MANIFEST TO FILTERED-MANIFEST.
    MOVE DELETED-FILES TO FILTERED-MANIFEST-TO-DELETED-FILES(FILTERED-MANIFEST).
    MOVE FILTERED-MANIFEST TO FILTERED-MANIFESTS(FILTERED-MANIFESTS-INDEX).
    RETURN FILTERED-MANIFEST.

PARTITION-AND-METRICS-EVALUATOR.
    MOVE SCHEMA TO TABLE-SCHEMA.
    PERFORM RESIDUAL-EVALUATOR USING SPEC, EXPR, CASE-SENSITIVE RETURNING EVALUATOR.
    PERFORM METRICS-EVALUATORS-MAP-CREATE USING SPEC-PARTITION-TYPE RETURNING EVALUATORS-MAP.

EVALUATOR-ROWS-MIGHT-MATCH.
    PERFORM METRICS-EVALUATORS-GET USING PARTITION RETURNING EVALUATORS.
    PERFORM INCLUSIVE-METRICS-EVALUATOR-EVAL USING FILE, EVALUATORS-FIRST RETURNING MIGHT-MATCH.
    RETURN MIGHT-MATCH.

EVALUATOR-ROWS-MUST-MATCH.
    PERFORM METRICS-EVALUATORS-GET USING PARTITION RETURNING EVALUATORS.
    PERFORM STRICT-METRICS-EVALUATOR-EVAL USING FILE, EVALUATORS-SECOND RETURNING MUST-MATCH.
    RETURN MUST-MATCH.

STOP RUN.
IDENTIFICATION DIVISION.
PROGRAM-ID. SCANSUMMARY.

ENVIRONMENT DIVISION.
DATA DIVISION.
WORKING-STORAGE SECTION.
01 SCAN-SUMMARY-COLUMNS PIC X(44) VALUE "partition record_count file_size_in_bytes".
01 TIMESTAMP-NAMES PIC X(20) VALUE "dateCreated lastUpdated".
01 WS-SNAPSHOT-TIMESTAMPS PIC X(10) VALUE SPACES.
01 WS-SNAPSHOT-ID PIC X(10) VALUE SPACES.
01 WS-TIMESTAMP-MILLIS PIC X(10) VALUE SPACES.
01 WS-TIMESTAMP PIC X(10) VALUE SPACES.
01 WS-PARTITION PIC X(10) VALUE SPACES.
01 WS-RECORD-COUNT PIC X(10) VALUE SPACES.
01 WS-TOTAL-SIZE PIC X(10) VALUE SPACES.
01 WS-DATA-TIMESTAMP-MILLIS PIC X(10) VALUE SPACES.

PROCEDURE DIVISION.

MAIN-PROCEDURE.
    PERFORM BUILD-SCAN-SUMMARY.
    STOP RUN.

BUILD-SCAN-SUMMARY.
    PERFORM GET-SNAPSHOT-TIMESTAMPS.
    PERFORM FILTER-MANIFESTS.
    PERFORM COMPUTE-PARTITION-METRICS.
    PERFORM RETURN-PARTITION-METRICS.

GET-SNAPSHOT-TIMESTAMPS.
    PERFORM VARYING WS-SNAPSHOT-ID FROM 1 BY 1
        UNTIL WS-SNAPSHOT-ID > NUMBER-OF-SNAPSHOTS
        MOVE SNAPSHOT-TIMESTAMP(WS-SNAPSHOT-ID) TO WS-TIMESTAMP-MILLIS
        MOVE WS-SNAPSHOT-ID TO WS-SNAPSHOT-TIMESTAMPS
    END-PERFORM.

FILTER-MANIFESTS.
    MOVE SCAN-FILTER TO WS-FILTER.
    PERFORM REMOVE-TIME-FILTERS.
    PERFORM GET-MANIFEST-FILES.

REMOVE-TIME-FILTERS.
    MOVE SCAN-FILTER TO WS-FILTER.
    PERFORM VARYING I FROM 1 BY 1 UNTIL I > LENGTH OF WS-FILTER
        IF WS-FILTER(I:1) IS TIMESTAMP-NAME
            PERFORM ADD-TIMESTAMP-FILTER
        ELSE
            MOVE WS-FILTER(I:1) TO OUTPUT-FILTER
        END-IF
    END-PERFORM.

ADD-TIMESTAMP-FILTER.
    MOVE TIMESTAMP-MILLIS TO WS-TIMESTAMP.
    PERFORM EVALUATE SCAN-FILTER-OP
        WHEN "LT"
            MOVE WS-TIMESTAMP - 1 TO WS-TIMESTAMP
        WHEN "LT_EQ"
            MOVE WS-TIMESTAMP TO WS-TIMESTAMP
        WHEN "GT"
            MOVE WS-TIMESTAMP + 1 TO WS-TIMESTAMP
        WHEN "GT_EQ"
            MOVE WS-TIMESTAMP TO WS-TIMESTAMP
        WHEN "EQ"
            MOVE WS-TIMESTAMP TO WS-TIMESTAMP
    END-EVALUATE.
    MOVE WS-TIMESTAMP TO WS-TIMESTAMP-FILTERS.

GET-MANIFEST-FILES.
    PERFORM VARY MANIFEST-FILE FROM 1 BY 1 UNTIL END-OF-MANIFESTS
        IF MANIFEST-SNAPSHOT-ID IN TIME-RANGE
            MOVE MANIFEST-PARTITION TO WS-PARTITION
            MOVE MANIFEST-RECORD-COUNT TO WS-RECORD-COUNT
            MOVE MANIFEST-TOTAL-SIZE TO WS-TOTAL-SIZE
            MOVE MANIFEST-TIMESTAMP-MILLIS TO WS-DATA-TIMESTAMP-MILLIS
            PERFORM UPDATE-PARTITION-METRICS
        END-IF
    END-PERFORM.

UPDATE-PARTITION-METRICS.
    MOVE WS-PARTITION TO KEY.
    IF PARTITION-METRICS(KEY) = SPACES
        INITIALIZE PARTITION-METRICS(KEY)
    END-IF.
    PERFORM UPDATE-PARTITION-METRICS-VALUES.

UPDATE-PARTITION-METRICS-VALUES.
    ADD 1 TO PARTITION-METRICS(KEY)-FILE-COUNT.
    ADD WS-RECORD-COUNT TO PARTITION-METRICS(KEY)-RECORD-COUNT.
    ADD WS-TOTAL-SIZE TO PARTITION-METRICS(KEY)-TOTAL-SIZE.
    IF WS-DATA-TIMESTAMP-MILLIS > PARTITION-METRICS(KEY)-DATA-TIMESTAMP-MILLIS OR
       PARTITION-METRICS(KEY)-DATA-TIMESTAMP-MILLIS = SPACES
        MOVE WS-DATA-TIMESTAMP-MILLIS TO PARTITION-METRICS(KEY)-DATA-TIMESTAMP-MILLIS.
    END-IF.

RETURN-PARTITION-METRICS.
    MOVE PARTITION-METRICS TO RESULT.
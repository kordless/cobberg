IDENTIFICATION DIVISION.
PROGRAM-ID. VIEW-METADATA-PROGRAM.

ENVIRONMENT DIVISION.
REPOSITORY.
    COPY "SCHEMA.cpy".
    COPY "VIEW-VERSION.cpy".
    COPY "VIEW-HISTORY-ENTRY.cpy".
    COPY "METADATA-UPDATE.cpy".

DATA DIVISION.
WORKING-STORAGE SECTION.
01 WS-UUID             PIC X(36).
01 WS-FORMAT-VERSION   PIC 9(3).
01 WS-LOCATION         PIC X(1024).
01 WS-SCHEMAS          OCCURS 9999 TIMES.
   05 WS-SCHEMA-ID     PIC 9(3).
   05 WS-SCHEMA        USAGE POINTER.
01 WS-CURRENT-VERSION-ID PIC 9(3).
01 WS-VERSIONS         OCCURS 9999 TIMES.
   05 WS-VERSION-ID    PIC 9(3).
   05 WS-VERSION       USAGE POINTER.
01 WS-HISTORY          OCCURS 9999 TIMES.
   05 WS-HISTORY-ENTRY USAGE POINTER.
01 WS-PROPERTIES       OCCURS 9999 TIMES.
   05 WS-PROPERTY-KEY   PIC X(128).
   05 WS-PROPERTY-VALUE PIC X(1024).
01 WS-CHANGES          OCCURS 9999 TIMES.
   05 WS-CHANGE         USAGE POINTER.
01 WS-METADATA-LOCATION PIC X(1024).

PROCEDURE DIVISION.
    PERFORM BUILD-VIEW-METADATA.
    STOP RUN.

BUILD-VIEW-METADATA.
    MOVE UUID TO WS-UUID.
    MOVE SUPPORTED-VIEW-FORMAT-VERSION TO WS-FORMAT-VERSION.
    MOVE "LOCATION" TO WS-LOCATION.
    PERFORM VARYING I FROM 1 BY 1 UNTIL I > NUM-SCHEMAS
        MOVE SCHEMA-ID(I) TO WS-SCHEMA-ID
        MOVE SCHEMA(I) TO WS-SCHEMA
        ADD 1 TO NUM-SCHEMAS
    END-PERFORM.
    MOVE CURRENT-VERSION-ID TO WS-CURRENT-VERSION-ID.
    PERFORM VARYING I FROM 1 BY 1 UNTIL I > NUM-VERSIONS
        MOVE VERSION-ID(I) TO WS-VERSION-ID
        MOVE VERSION(I) TO WS-VERSION
        ADD 1 TO NUM-VERSIONS
    END-PERFORM.
    PERFORM VARYING I FROM 1 BY 1 UNTIL I > NUM-HISTORY-ENTRIES
        MOVE HISTORY-ENTRY(I) TO WS-HISTORY-ENTRY
        ADD 1 TO NUM-HISTORY-ENTRIES
    END-PERFORM.
    PERFORM VARYING I FROM 1 BY 1 UNTIL I > NUM-PROPERTIES
        MOVE PROPERTY-KEY(I) TO WS-PROPERTY-KEY
        MOVE PROPERTY-VALUE(I) TO WS-PROPERTY-VALUE
        ADD 1 TO NUM-PROPERTIES
    END-PERFORM.
    PERFORM VARYING I FROM 1 BY 1 UNTIL I > NUM-CHANGES
        MOVE CHANGE(I) TO WS-CHANGE
        ADD 1 TO NUM-CHANGES
    END-PERFORM.
    MOVE "METADATA-LOCATION" TO WS-METADATA-LOCATION.
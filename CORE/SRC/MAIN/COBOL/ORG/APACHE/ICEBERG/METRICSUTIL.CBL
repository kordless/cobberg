IDENTIFICATION DIVISION.
PROGRAM-ID. METRICSUTIL.

ENVIRONMENT DIVISION.
REPOSITORY.
    CLASS TYPES.
        COPY "ICEBERG-TYPES" REPLACING ==TYPE== BY ==ICEBERG-TYPE==.
        COPY "ICEBERG-CONTENT-FILE" REPLACING ==CONTENT-FILE== BY ==ICEBERG-CONTENT-FILE==.
        COPY "ICEBERG-SCHEMA" REPLACING ==SCHEMA== BY ==ICEBERG-SCHEMA==.
        COPY "ICEBERG-STRUCT-LIKE" REPLACING ==STRUCT-LIKE== BY ==ICEBERG-STRUCT-LIKE==.

DATA DIVISION.
WORKING-STORAGE SECTION.
01 WS-READABLE-METRIC-COLS.
    02 FILLER OCCURS 6 TIMES.
       03 FILLER.
          05 COL-NAME PIC X(20).
          05 COL-DOC PIC X(50).
          05 COL-ORIGINAL-ID PIC 9(9).
          05 COL-TYPE-FUNC PROCEDURE-POINTER.
          05 COL-METRIC-FUNC PROCEDURE-POINTER.
01 WS-READABLE-METRICS-SCHEMA.
    02 FILLER.
       03 FIELD-ID PIC 9(9).
       03 FIELD-NAME PIC X(30).
       03 FIELD-TYPE PIC X(20).
       03 FIELD-DOC PIC X(100).

PROCEDURE DIVISION.

COPYMETRICS-WITHOUTFIELDCOUNTS.
    MOVE METRICS-RECORD-COUNT TO WS-RECORD-COUNT.
    MOVE METRICS-COLUMN-SIZES TO WS-COLUMN-SIZES.
    PERFORM COPYMAP-WITHOUTKEYS USING METRICS-VALUE-COUNTS, EXCLUDED-FIELD-IDS, WS-VALUE-COUNTS.
    PERFORM COPYMAP-WITHOUTKEYS USING METRICS-NULL-VALUE-COUNTS, EXCLUDED-FIELD-IDS, WS-NULL-VALUE-COUNTS.
    PERFORM COPYMAP-WITHOUTKEYS USING METRICS-NAN-VALUE-COUNTS, EXCLUDED-FIELD-IDS, WS-NAN-VALUE-COUNTS.
    MOVE METRICS-LOWER-BOUNDS TO WS-LOWER-BOUNDS.
    MOVE METRICS-UPPER-BOUNDS TO WS-UPPER-BOUNDS.
    MOVE WS-RECORD-COUNT TO RESULT-RECORD-COUNT.
    MOVE WS-COLUMN-SIZES TO RESULT-COLUMN-SIZES.
    MOVE WS-VALUE-COUNTS TO RESULT-VALUE-COUNTS.
    MOVE WS-NULL-VALUE-COUNTS TO RESULT-NULL-VALUE-COUNTS.
    MOVE WS-NAN-VALUE-COUNTS TO RESULT-NAN-VALUE-COUNTS.
    MOVE WS-LOWER-BOUNDS TO RESULT-LOWER-BOUNDS.
    MOVE WS-UPPER-BOUNDS TO RESULT-UPPER-BOUNDS.

COPYMETRICS-WITHOUTFIELDCOUNTSANDBOUNDS.
    MOVE METRICS-RECORD-COUNT TO WS-RECORD-COUNT.
    MOVE METRICS-COLUMN-SIZES TO WS-COLUMN-SIZES.
    PERFORM COPYMAP-WITHOUTKEYS USING METRICS-VALUE-COUNTS, EXCLUDED-FIELD-IDS, WS-VALUE-COUNTS.
    PERFORM COPYMAP-WITHOUTKEYS USING METRICS-NULL-VALUE-COUNTS, EXCLUDED-FIELD-IDS, WS-NULL-VALUE-COUNTS.
    PERFORM COPYMAP-WITHOUTKEYS USING METRICS-NAN-VALUE-COUNTS, EXCLUDED-FIELD-IDS, WS-NAN-VALUE-COUNTS.
    PERFORM COPYMAP-WITHOUTKEYS USING METRICS-LOWER-BOUNDS, EXCLUDED-FIELD-IDS, WS-LOWER-BOUNDS.
    PERFORM COPYMAP-WITHOUTKEYS USING METRICS-UPPER-BOUNDS, EXCLUDED-FIELD-IDS, WS-UPPER-BOUNDS.
    MOVE WS-RECORD-COUNT TO RESULT-RECORD-COUNT.
    MOVE WS-COLUMN-SIZES TO RESULT-COLUMN-SIZES.
    MOVE WS-VALUE-COUNTS TO RESULT-VALUE-COUNTS.
    MOVE WS-NULL-VALUE-COUNTS TO RESULT-NULL-VALUE-COUNTS.
    MOVE WS-NAN-VALUE-COUNTS TO RESULT-NAN-VALUE-COUNTS.
    MOVE WS-LOWER-BOUNDS TO RESULT-LOWER-BOUNDS.
    MOVE WS-UPPER-BOUNDS TO RESULT-UPPER-BOUNDS.

COPYMAP-WITHOUTKEYS.
    IF INPUT-MAP IS NOT NULL
        MOVE INPUT-MAP TO WS-MAP
        PERFORM VARYING KEY-ID FROM 1 BY 1 UNTIL KEY-ID > EXCLUDED-FIELD-IDS-COUNT
            IF EXCLUDED-FIELD-IDS(KEY-ID) IS PRESENT IN WS-MAP
                DELETE EXCLUDED-FIELD-IDS(KEY-ID) FROM WS-MAP
            END-IF
        END-PERFORM
        IF WS-MAP IS EMPTY
            MOVE NULL TO OUTPUT-MAP
        ELSE
            MOVE WS-MAP TO OUTPUT-MAP
        END-IF
    ELSE
        MOVE NULL TO OUTPUT-MAP
    END-IF.

CREATE-NANVALUECOUNTS.
    IF FIELD-METRICS IS NOT NULL AND INPUT-SCHEMA IS NOT NULL
        INITIALIZE WS-NAN-VALUE-COUNTS
        PERFORM VARYING FIELD-INDEX FROM 1 BY 1 UNTIL FIELD-INDEX > FIELD-METRICS-COUNT
            IF METRICSMODE(INPUT-SCHEMA, METRICS-CONFIG, FIELD-METRICS(FIELD-INDEX).FIELD-ID) NOT = NONE
                MOVE FIELD-METRICS(FIELD-INDEX).NAN-VALUE-COUNT TO WS-NAN-VALUE-COUNTS(FIELD-METRICS(FIELD-INDEX).FIELD-ID)
            END-IF
        END-PERFORM
        MOVE WS-NAN-VALUE-COUNTS TO RESULT-NAN-VALUE-COUNTS
    ELSE
        INITIALIZE RESULT-NAN-VALUE-COUNTS
    END-IF.

METRICSMODE.
    MOVE SCHEMA-FIND-COLUMN-NAME(INPUT-SCHEMA, FIELD-ID) TO WS-COLUMN-NAME.
    MOVE METRICS-CONFIG-COLUMN-MODE(METRICS-CONFIG, WS-COLUMN-NAME) TO RESULT-METRICS-MODE.

READABLEMETRICS-SCHEMA.
    INITIALIZE WS-READABLE-METRICS-SCHEMA
    PERFORM VARYING SCHEMA-FIELD-ID FROM 1 BY 1 UNTIL SCHEMA-FIELD-ID > SCHEMA-FIELD-COUNT
        MOVE SCHEMA-FIND-FIELD(INPUT-SCHEMA, SCHEMA-FIELD-ID) TO WS-FIELD
        IF WS-FIELD-TYPE IS PRIMITIVE-TYPE
            MOVE SCHEMA-FIND-NAME(INPUT-SCHEMA, SCHEMA-FIELD-ID) TO WS-FIELD-NAME
            MOVE SCHEMA-FIELD-ID TO WS-FIELD-ID
            PERFORM VARYING COL-INDEX FROM 1 BY 1 UNTIL COL-INDEX > 6
                MOVE WS-READABLE-METRIC-COLS(COL-INDEX, COL-NAME) TO WS-FIELD-NAME
                MOVE WS-READABLE-METRIC-COLS(COL-INDEX, COL-DOC) TO WS-FIELD-DOC
                MOVE WS-READABLE-METRIC-COLS(COL-INDEX, COL-ORIGINAL-ID) TO WS-FIELD-ORIGINAL-ID
                MOVE WS-READABLE-METRIC-COLS(COL-INDEX, COL-TYPE-FUNC) TO WS-FIELD-TYPE-FUNC
                MOVE WS-READABLE-METRIC-COLS(COL-INDEX, COL-METRIC-FUNC) TO WS-FIELD-METRIC-FUNC
                MOVE WS-FIELD-ID TO WS-READABLE-METRICS-SCHEMA(COL-INDEX, FIELD-ID).
                MOVE WS-FIELD-NAME TO WS-READABLE-METRICS-SCHEMA(COL-INDEX, FIELD-NAME).
                MOVE WS-FIELD-TYPE TO WS-READABLE-METRICS-SCHEMA(COL-INDEX, FIELD-TYPE).
                MOVE WS-FIELD-DOC TO WS-READABLE-METRICS-SCHEMA(COL-INDEX, FIELD-DOC).
            END-PERFORM
        END-IF
    END-PERFORM.
    MOVE WS-READABLE-METRICS-SCHEMA TO RESULT-SCHEMA.

READABLEMETRICS-STRUCT.
    INITIALIZE WS-COL-METRICS
    PERFORM VARYING SCHEMA-FIELD-ID FROM 1 BY 1 UNTIL SCHEMA-FIELD-ID > SCHEMA-FIELD-COUNT
        MOVE SCHEMA-FIND-FIELD(INPUT-SCHEMA, SCHEMA-FIELD-ID) TO WS-FIELD
        MOVE SCHEMA-FIND-NAME(INPUT-SCHEMA, SCHEMA-FIELD-ID) TO WS-FIELD-NAME
        IF WS-FIELD-TYPE IS PRIMITIVE-TYPE
            AND PROJECTED-SCHEMA-FIELD(PROJECTED-SCHEMA, WS-FIELD-NAME) IS PRESENT
            PERFORM VARYING COL-INDEX FROM 1 BY 1 UNTIL COL-INDEX > 6
                MOVE WS-READABLE-METRIC-COLS(COL-INDEX, COL-METRIC-FUNC) TO WS-METRIC-FUNC
                MOVE WS-READABLE-METRIC-COLS(COL-INDEX, COL-TYPE-FUNC) TO WS-TYPE-FUNC
                INVOKE WS-TYPE-FUNC USING WS-FIELD RETURNING WS-METRIC-TYPE
                MOVE WS-FIELD-NAME TO WS-COL-NAME
                INVOKE WS-METRIC-FUNC USING DATAFILE, WS-FIELD RETURNING WS-METRIC-VALUE
                MOVE WS-COL-NAME, WS-FIELD, WS-METRIC-VALUE TO WS-COL-METRICS-STRUCT
                APPEND WS-COL-METRICS-STRUCT TO WS-COL-METRICS
            END-PERFORM
        END-IF
    END-PERFORM.
    SORT WS-COL-METRICS BY WS-COL-NAME.
    MOVE WS-COL-METRICS TO RESULT-READABLE-METRICS.

STRUCTWITHREADABLEMETRICS.
    MOVE STRUCT TO WS-STRUCT.
    MOVE READABLE-METRICS TO WS-READABLE-METRICS.
    MOVE STRUCT-SIZE TO WS-STRUCT-SIZE.
    MOVE METRICS-POSITION TO WS-METRICS-POSITION.
    PERFORM VARYING POS FROM 1 BY 1 UNTIL POS > WS-STRUCT-SIZE
        IF POS < WS-METRICS-POSITION
            MOVE WS-STRUCT(POS) TO RESULT(POS)
        ELSE IF POS = WS-METRICS-POSITION
            MOVE WS-READABLE-METRICS TO RESULT(POS)
        ELSE
            MOVE WS-STRUCT(POS - 1) TO RESULT(POS)
        END-IF
    END-PERFORM.

STOP RUN.
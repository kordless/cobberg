IDENTIFICATION DIVISION.
PROGRAM-ID. MANIFESTWRITER.

ENVIRONMENT DIVISION.
INPUT-OUTPUT SECTION.
FILE-CONTROL.
    SELECT AVRO-FILE ASSIGN TO DYNAMIC AVRO-FILE-NAME
        ORGANIZATION IS SEQUENTIAL
        ACCESS MODE IS SEQUENTIAL.

DATA DIVISION.
FILE SECTION.
FD AVRO-FILE.
01 AVRO-FILE-RECORD.
   COPY AVRO-SCHEMA.

WORKING-STORAGE SECTION.
01 WS-KEY-METADATA-BUFFER PIC X(1024).
01 WS-SPEC-ID PIC 9(9) COMP.
01 WS-SNAPSHOT-ID PIC 9(18) COMP.
01 WS-REUSED-ENTRY.
   COPY MANIFEST-ENTRY-SCHEMA.
01 WS-PARTITION-SUMMARY.
   COPY PARTITION-SUMMARY-SCHEMA.
01 WS-FLAGS.
   03 WS-CLOSED-FLAG PIC X VALUE 'N'.
   03 WS-ADDED-FILES PIC 9(9) COMP VALUE 0.
   03 WS-ADDED-ROWS PIC 9(18) COMP VALUE 0.
   03 WS-EXISTING-FILES PIC 9(9) COMP VALUE 0.
   03 WS-EXISTING-ROWS PIC 9(18) COMP VALUE 0.
   03 WS-DELETED-FILES PIC 9(9) COMP VALUE 0.
   03 WS-DELETED-ROWS PIC 9(18) COMP VALUE 0.
01 WS-MIN-DATA-SEQ-NUM PIC 9(18) COMP VALUE 0.

PROCEDURE DIVISION.
    PERFORM PREPARE-ENTRY
    PERFORM ADD-ENTRY
    PERFORM CLOSE-WRITER
    .

PREPARE-ENTRY.
    MOVE SNAPSHOT-ID TO WS-REUSED-ENTRY-SNAPSHOT-ID
    MOVE DATA-SEQUENCE-NUMBER TO WS-REUSED-ENTRY-DATA-SEQUENCE-NUMBER
    MOVE FILE-SEQUENCE-NUMBER TO WS-REUSED-ENTRY-FILE-SEQUENCE-NUMBER
    MOVE FILE-PARTITION TO WS-REUSED-ENTRY-PARTITION
    MOVE FILE-RECORD-COUNT TO WS-REUSED-ENTRY-RECORD-COUNT
    MOVE FILE-PATH TO WS-REUSED-ENTRY-FILE-PATH
    MOVE FILE-FORMAT TO WS-REUSED-ENTRY-FILE-FORMAT
    MOVE FILE-SPLIT-OFFSETS TO WS-REUSED-ENTRY-SPLIT-OFFSETS
    MOVE FILE-RESIDUAL-OFFSETS TO WS-REUSED-ENTRY-RESIDUAL-OFFSETS
    MOVE FILE-LENGTH TO WS-REUSED-ENTRY-FILE-LENGTH
    MOVE FILE-COLUMN-SIZES TO WS-REUSED-ENTRY-COLUMN-SIZES
    MOVE FILE-VALUE-COUNTS TO WS-REUSED-ENTRY-VALUE-COUNTS
    MOVE FILE-NULL-VALUE-COUNTS TO WS-REUSED-ENTRY-NULL-VALUE-COUNTS
    MOVE FILE-LOWER-BOUNDS TO WS-REUSED-ENTRY-LOWER-BOUNDS
    MOVE FILE-UPPER-BOUNDS TO WS-REUSED-ENTRY-UPPER-BOUNDS
    .

ADD-ENTRY.
    EVALUATE ENTRY-STATUS
        WHEN 'ADDED'
            ADD 1 TO WS-ADDED-FILES
            ADD FILE-RECORD-COUNT TO WS-ADDED-ROWS
        WHEN 'EXISTING'
            ADD 1 TO WS-EXISTING-FILES
            ADD FILE-RECORD-COUNT TO WS-EXISTING-ROWS
        WHEN 'DELETED'
            ADD 1 TO WS-DELETED-FILES
            ADD FILE-RECORD-COUNT TO WS-DELETED-ROWS
    END-EVALUATE

    PERFORM UPDATE-PARTITION-SUMMARY

    IF ENTRY-IS-LIVE AND DATA-SEQUENCE-NUMBER IS NOT NULL
        AND (WS-MIN-DATA-SEQ-NUM = 0 OR DATA-SEQUENCE-NUMBER < WS-MIN-DATA-SEQ-NUM)
        MOVE DATA-SEQUENCE-NUMBER TO WS-MIN-DATA-SEQ-NUM
    END-IF

    WRITE AVRO-FILE-RECORD FROM WS-REUSED-ENTRY
    .

UPDATE-PARTITION-SUMMARY.
    PERFORM VARYING I FROM 1 BY 1 UNTIL I > 10
        MOVE FILE-PARTITION(I) TO WS-PARTITION-SUMMARY-PARTITION(I)
        ADD FILE-RECORD-COUNT TO WS-PARTITION-SUMMARY-RECORD-COUNT(I)
    END-PERFORM
    .

CLOSE-WRITER.
    MOVE 'Y' TO WS-CLOSED-FLAG
    CLOSE AVRO-FILE
    .

GENERATE-MANIFEST-FILE.
    MOVE AVRO-FILE-NAME TO WS-MANIFEST-FILE-LOCATION
    MOVE AVRO-FILE-LENGTH TO WS-MANIFEST-FILE-LENGTH
    MOVE WS-SPEC-ID TO WS-MANIFEST-FILE-SPEC-ID
    MOVE 'DATA' TO WS-MANIFEST-FILE-CONTENT
    MOVE -1 TO WS-MANIFEST-FILE-SEQUENCE-NUMBER
    MOVE WS-MIN-DATA-SEQ-NUM TO WS-MANIFEST-FILE-MIN-SEQ-NUMBER
    MOVE WS-SNAPSHOT-ID TO WS-MANIFEST-FILE-SNAPSHOT-ID
    MOVE WS-ADDED-FILES TO WS-MANIFEST-FILE-ADDED-FILES
    MOVE WS-ADDED-ROWS TO WS-MANIFEST-FILE-ADDED-ROWS
    MOVE WS-EXISTING-FILES TO WS-MANIFEST-FILE-EXISTING-FILES
    MOVE WS-EXISTING-ROWS TO WS-MANIFEST-FILE-EXISTING-ROWS
    MOVE WS-DELETED-FILES TO WS-MANIFEST-FILE-DELETED-FILES
    MOVE WS-DELETED-ROWS TO WS-MANIFEST-FILE-DELETED-ROWS
    MOVE WS-PARTITION-SUMMARY TO WS-MANIFEST-FILE-PARTITION-SUMMARIES
    MOVE WS-KEY-METADATA-BUFFER TO WS-MANIFEST-FILE-KEY-METADATA
    .
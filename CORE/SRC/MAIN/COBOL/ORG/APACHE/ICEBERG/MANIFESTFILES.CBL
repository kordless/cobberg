IDENTIFICATION DIVISION.
PROGRAM-ID. MANIFEST-FILES.

ENVIRONMENT DIVISION.
INPUT-OUTPUT SECTION.
FILE-CONTROL.
    SELECT MANIFEST-FILE ASSIGN TO EXTERNAL-FILE.

DATA DIVISION.
FILE SECTION.
FD MANIFEST-FILE.
01 MANIFEST-FILE-RECORD.
   05 MANIFEST-CONTENT PIC X.
   05 PARTITION-SPEC-ID PIC 9(9) COMP.
   05 SNAPSHOT-ID PIC 9(18) COMP.
   05 FILE-PATH PIC X(256).
   05 PARTITION-SUMMARY.
      10 LOWER-BOUND OCCURS 0 TO 100 DEPENDING ON PARTITION-SUMMARY-LENGTH PIC X(256).
      10 UPPER-BOUND OCCURS 0 TO 100 DEPENDING ON PARTITION-SUMMARY-LENGTH PIC X(256).
      10 PARTITION-SUMMARY-LENGTH PIC 9(3) COMP.
   05 FILE-TYPE PIC X.

WORKING-STORAGE SECTION.
01 MANIFEST-AVRO-SCHEMA.
   05 MANIFEST-FILE-SCHEMA.
      10 MANIFEST-CONTENT PIC X.
      10 PARTITION-SPEC-ID PIC 9(9) COMP.
      10 SNAPSHOT-ID PIC 9(18) COMP.
      10 FILE-PATH PIC X(256).
      10 PARTITION-SUMMARY.
         15 LOWER-BOUND OCCURS 0 TO 100 DEPENDING ON PARTITION-SUMMARY-LENGTH PIC X(256).
         15 UPPER-BOUND OCCURS 0 TO 100 DEPENDING ON PARTITION-SUMMARY-LENGTH PIC X(256).
         15 PARTITION-SUMMARY-LENGTH PIC 9(3) COMP.
      10 FILE-TYPE PIC X.
01 CACHE-ENTRY.
   05 CONTENT-CACHE.
      10 CACHE-DURATION-MS PIC 9(18) COMP.
      10 CACHE-TOTAL-BYTES PIC 9(18) COMP.
      10 CACHE-MAX-CONTENT-LENGTH PIC 9(18) COMP.
01 CACHE-TABLE.
   05 CACHE-KEY PIC X(256).
   05 CACHE-VALUE PIC X(1024).

PROCEDURE DIVISION.
MAIN-PROCEDURE.
    OPEN INPUT MANIFEST-FILE.
    READ MANIFEST-FILE.
    PERFORM MANIFEST-READER-PROCESSING.
    CLOSE MANIFEST-FILE.
    STOP RUN.

MANIFEST-READER-PROCESSING.
    PERFORM COPY-MANIFEST-INTERNAL.
    PERFORM WRITE-MANIFEST.

COPY-MANIFEST-INTERNAL.
    IF MANIFEST-CONTENT = 'D'
        PERFORM COPY-DELETE-MANIFEST
    ELSE
        PERFORM COPY-DATA-MANIFEST.

COPY-DATA-MANIFEST.
    PERFORM VARYING I FROM 1 BY 1 UNTIL I > PARTITION-SUMMARY-LENGTH
        MOVE LOWER-BOUND(I) TO SUMMARY-LOWER-BOUND(I)
        MOVE UPPER-BOUND(I) TO SUMMARY-UPPER-BOUND(I)
    END-PERFORM.
    PERFORM WRITE-MANIFEST-ENTRY.

COPY-DELETE-MANIFEST.
    PERFORM VARYING I FROM 1 BY 1 UNTIL I > PARTITION-SUMMARY-LENGTH
        MOVE LOWER-BOUND(I) TO SUMMARY-LOWER-BOUND(I)
        MOVE UPPER-BOUND(I) TO SUMMARY-UPPER-BOUND(I)
    END-PERFORM.
    PERFORM WRITE-DELETE-MANIFEST-ENTRY.

WRITE-MANIFEST.
    OPEN OUTPUT MANIFEST-FILE.
    WRITE MANIFEST-FILE-RECORD.
    CLOSE MANIFEST-FILE.

WRITE-MANIFEST-ENTRY.
    MOVE 'A' TO MANIFEST-ENTRY-STATUS.
    WRITE MANIFEST-FILE-RECORD.

WRITE-DELETE-MANIFEST-ENTRY.
    MOVE 'D' TO MANIFEST-ENTRY-STATUS.
    WRITE MANIFEST-FILE-RECORD.
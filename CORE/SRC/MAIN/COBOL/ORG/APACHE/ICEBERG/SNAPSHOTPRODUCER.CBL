IDENTIFICATION DIVISION.
PROGRAM-ID. SNAPSHOTPRODUCER.

ENVIRONMENT DIVISION.
INPUT-OUTPUT SECTION.
FILE-CONTROL.
    SELECT MANIFESTLIST-FILE
        ASSIGN TO MANIFESTLIST-LOCATION
        ORGANIZATION IS SEQUENTIAL
        ACCESS MODE IS SEQUENTIAL.

DATA DIVISION.
FILE SECTION.
FD MANIFESTLIST-FILE.
   01 MANIFESTLIST-RECORD PIC X(1024).

WORKING-STORAGE SECTION.
01 WS-COMMIT-UUID PIC X(36) VALUE X'00000000-0000-0000-0000-000000000000'.
01 WS-MANIFEST-COUNT PIC 9(10) VALUE 0.
01 WS-ATTEMPT PIC 9(10) VALUE 0.
01 WS-MANIFEST-LISTS PIC X(1024) OCCURS 1 TIMES.
01 WS-TARGET-MANIFEST-SIZE-BYTES PIC 9(18) VALUE 0.
01 WS-SNAPSHOT-ID PIC 9(18) VALUE 0.
01 WS-BASE-TABLE-METADATA PIC X(1024).
01 WS-STAGE-ONLY PIC X(1) VALUE 'N'.
01 WS-DELETE-FUNC PIC X(1) VALUE 'D'.
01 WS-WORKER-POOL PIC X(1024).
01 WS-TARGET-BRANCH PIC X(64) VALUE 'MAIN'.
01 WS-COMMIT-METRICS PIC X(1024).

PROCEDURE DIVISION.
MAIN-PROCEDURE.
    PERFORM REFRESH-PROCEDURE.
    PERFORM VALIDATE-PROCEDURE.
    PERFORM APPLY-PROCEDURE.
    PERFORM COMMIT-PROCEDURE.
    PERFORM NOTIFY-LISTENERS-PROCEDURE.
    STOP RUN.

REFRESH-PROCEDURE.
    MOVE CURRENT-TABLE-METADATA TO WS-BASE-TABLE-METADATA.

VALIDATE-PROCEDURE.
    PERFORM VALIDATE-METADATA VARYING CURRENT-METADATA, ENDING-SNAPSHOT.

APPLY-PROCEDURE.
    MOVE NEXT-SEQUENCE-NUMBER TO WS-SNAPSHOT-ID.
    PERFORM CREATE-MANIFEST-LIST.
    MOVE CALCULATED-ADDED-ROWS TO WS-ADDED-ROWS.
    MOVE CALCULATED-LAST-ROW-ID TO WS-LAST-ROW-ID.
    MOVE CREATED-SNAPSHOT TO WS-NEW-SNAPSHOT.

COMMIT-PROCEDURE.
    PERFORM RETRY-COMMIT.
    PERFORM CLEANUP-PROCEDURE.

NOTIFY-LISTENERS-PROCEDURE.
    PERFORM NOTIFY-LISTENERS.

RETRY-COMMIT.
    PERFORM VARYING OPS FROM 1 BY 1 UNTIL OPS > BASE-PROPERTY-AS-INT(COMMIT-NUM-RETRIES, COMMIT-NUM-RETRIES-DEFAULT)
        PERFORM TASK-COMMIT
    END-PERFORM.

TASK-COMMIT.
    PERFORM APPLY-PROCEDURE.
    PERFORM UPDATE-TABLE-METADATA.
    PERFORM OPS-COMMIT.

UPDATE-TABLE-METADATA.
    IF BASE-SNAPSHOT(WS-NEW-SNAPSHOT-ID) IS NOT NULL
        MOVE WS-NEW-SNAPSHOT-ID TO BASE-BRANCH-SNAPSHOT(WS-TARGET-BRANCH)
    ELSE IF WS-STAGE-ONLY = 'Y'
        ADD WS-NEW-SNAPSHOT TO BASE-TABLE-METADATA
    ELSE
        MOVE WS-NEW-SNAPSHOT TO BASE-BRANCH-SNAPSHOT(WS-TARGET-BRANCH)
    END-IF.

CREATE-MANIFEST-LIST.
    MOVE MANIFESTLIST-LOCATION TO WS-MANIFESTLIST-FILE.
    OPEN OUTPUT MANIFESTLIST-FILE.
    PERFORM VARYING MANIFEST-FILE FROM 1 BY 1 UNTIL MANIFEST-FILE > COUNT(MANIFESTS)
        MOVE MANIFESTS(MANIFEST-FILE) TO MANIFESTLIST-RECORD
        WRITE MANIFESTLIST-RECORD
    END-PERFORM.
    CLOSE MANIFESTLIST-FILE.
    MOVE MANIFESTLIST-LOCATION TO WS-MANIFEST-LISTS(WS-MANIFEST-LISTS-COUNT).

CLEANUP-PROCEDURE.
    PERFORM VARYING MANIFESTLIST FROM 1 BY 1 UNTIL MANIFESTLIST > COUNT(WS-MANIFEST-LISTS)
        IF WS-MANIFEST-LISTS(MANIFESTLIST) <> WS-NEW-SNAPSHOT-LOCATION
            PERFORM DELETE-FILE(WS-MANIFEST-LISTS(MANIFESTLIST))
        END-IF
    END-PERFORM.
    PERFORM CLEAN-UNCOMMITTED(WS-COMMITTED-MANIFESTS).

NOTIFY-LISTENERS.
    PERFORM NOTIFY-CREATE-SNAPSHOT-EVENT.
    PERFORM NOTIFY-COMMIT-REPORT.

NOTIFY-CREATE-SNAPSHOT-EVENT.
    MOVE WS-NEW-SNAPSHOT-ID TO WS-CREATE-SNAPSHOT-EVENT-SNAPSHOT-ID.
    MOVE WS-OPERATION TO WS-CREATE-SNAPSHOT-EVENT-OPERATION.
    MOVE WS-NEW-SNAPSHOT-SEQUENCE-NUMBER TO WS-CREATE-SNAPSHOT-EVENT-SEQUENCE-NUMBER.
    MOVE WS-TABLE-NAME TO WS-CREATE-SNAPSHOT-EVENT-TABLE-NAME.
    MOVE WS-ENVIRONMENT-CONTEXT TO WS-CREATE-SNAPSHOT-EVENT-METADATA.
    CALL "NOTIFY-ALL" USING WS-CREATE-SNAPSHOT-EVENT.

NOTIFY-COMMIT-REPORT.
    MOVE WS-TABLE-NAME TO WS-COMMIT-REPORT-TABLE-NAME.
    MOVE WS-NEW-SNAPSHOT-ID TO WS-COMMIT-REPORT-SNAPSHOT-ID.
    MOVE WS-OPERATION TO WS-COMMIT-REPORT-OPERATION.
    MOVE WS-NEW-SNAPSHOT-SEQUENCE-NUMBER TO WS-COMMIT-REPORT-SEQUENCE-NUMBER.
    MOVE WS-ENVIRONMENT-CONTEXT TO WS-COMMIT-REPORT-METADATA.
    MOVE WS-COMMIT-METRICS TO WS-COMMIT-REPORT-COMMIT-METRICS.
    CALL "REPORT" USING WS-COMMIT-REPORT.

WRITE-DATA-MANIFESTS.
    PERFORM VARYING DATA-FILE FROM 1 BY 1 UNTIL DATA-FILE > COUNT(DATA-FILES)
        PERFORM WRITE-DATA-FILE-GROUP
    END-PERFORM.

WRITE-DATA-FILE-GROUP.
    OPEN OUTPUT MANIFEST-FILE.
    PERFORM VARYING DATA-FILE FROM 1 BY 1 UNTIL DATA-FILE > COUNT(DATA-FILES-IN-GROUP)
        WRITE DATA-FILES-IN-GROUP(DATA-FILE) TO MANIFEST-FILE
    END-PERFORM.
    CLOSE MANIFEST-FILE.
    MOVE MANIFEST-FILE-LOCATION TO WS-WRITTEN-MANIFESTS.

WRITE-DELETE-MANIFESTS.
    PERFORM VARYING DELETE-FILE FROM 1 BY 1 UNTIL DELETE-FILE > COUNT(DELETE-FILES)
        PERFORM WRITE-DELETE-FILE-GROUP
    END-PERFORM.

WRITE-DELETE-FILE-GROUP.
    OPEN OUTPUT DELETE-MANIFEST-FILE.
    PERFORM VARYING DELETE-FILE FROM 1 BY 1 UNTIL DELETE-FILE > COUNT(DELETE-FILES-IN-GROUP)
        WRITE DELETE-FILES-IN-GROUP(DELETE-FILE) TO DELETE-MANIFEST-FILE
    END-PERFORM.
    CLOSE DELETE-MANIFEST-FILE.
    MOVE DELETE-MANIFEST-FILE-LOCATION TO WS-WRITTEN-MANIFESTS.

DELETE-FILE.
    CALL "DELETE-FILE" USING FILE-PATH.

IDENTIFICATION DIVISION.
PROGRAM-ID. SNAPSHOTPRODUCERDELEGATE.

PROCEDURE DIVISION.
MAIN-PROCEDURE.
    PERFORM CLEANUP-UNCOMMITTED.
    PERFORM CLEANUP-MANIFEST-LISTS.

CLEANUP-UNCOMMITTED.
    CALL "CLEAN-UNCOMMITTED" USING WS-UNCOMMITTED-MANIFESTS.

CLEANUP-MANIFEST-LISTS.
    PERFORM VARYING MANIFESTLIST FROM 1 BY 1 UNTIL MANIFESTLIST > COUNT(WS-MANIFEST-LISTS)
        PERFORM DELETE-FILE(WS-MANIFEST-LISTS(MANIFESTLIST))
    END-PERFORM.
    MOVE 0 TO WS-MANIFEST-LISTS-COUNT.
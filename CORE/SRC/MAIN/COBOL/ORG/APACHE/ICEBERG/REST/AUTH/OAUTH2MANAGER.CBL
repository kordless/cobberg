IDENTIFICATION DIVISION.
PROGRAM-ID. OAUTH2-MANAGER.

ENVIRONMENT DIVISION.
SPECIAL-NAMES.
    FUNCTION REST-CLIENT IS "org.apache.iceberg.rest.RESTClient"
    FUNCTION OAUTH2-UTIL IS "org.apache.iceberg.rest.auth.OAuth2Util"
    FUNCTION PROPERTY-UTIL IS "org.apache.iceberg.util.PropertyUtil"
    FUNCTION MAPS IS "org.apache.iceberg.relocated.com.google.common.collect.Maps".

DATA DIVISION.
WORKING-STORAGE SECTION.
01 WS-NAME PIC X(32) VALUE "OAUTH2-MANAGER".
01 WS-TOKEN-PREFERENCE-ORDER PIC X(128) VALUE "ID-TOKEN-TYPE,ACCESS-TOKEN-TYPE,JWT-TOKEN-TYPE,SAML2-TOKEN-TYPE,SAML1-TOKEN-TYPE".
01 WS-TABLE-SESSION-ALLOW-LIST PIC X(64) VALUE "TOKEN,ID-TOKEN-TYPE,ACCESS-TOKEN-TYPE,JWT-TOKEN-TYPE,SAML2-TOKEN-TYPE,SAML1-TOKEN-TYPE".
01 WS-CLIENT PIC X(32) VALUE SPACES.
01 WS-START-TIME-MILLIS PIC 9(18) VALUE 0.
01 WS-AUTH-RESPONSE PIC X(128) VALUE SPACES.
01 WS-SESSION-CACHE PIC X(32) VALUE SPACES.

PROCEDURE DIVISION.

INIT-SESSION.
    PERFORM WARN-IF-DEPRECATED-TOKEN-ENDPOINT-USED
    MOVE FUNCTION AUTH-CONFIG-FROM-PROPERTIES(WS-PROPERTIES) TO WS-CONFIG
    MOVE FUNCTION OAUTH2-UTIL-AUTH-HEADERS(WS-CONFIG-TOKEN) TO WS-HEADERS
    MOVE FUNCTION OAUTH2-UTIL-AUTH-SESSION(WS-HEADERS, WS-CONFIG) TO WS-SESSION
    IF WS-CONFIG-CREDENTIAL NOT EQUAL SPACES AND WS-CONFIG-CREDENTIAL NOT EQUAL SPACES
        MOVE FUNCTION SYSTEM-MILLISECONDS TO WS-START-TIME-MILLIS
        MOVE FUNCTION OAUTH2-UTIL-FETCH-TOKEN(WS-INIT-CLIENT, WS-HEADERS, WS-CONFIG-CREDENTIAL, WS-CONFIG-SCOPE, WS-CONFIG-OAUTH2-SERVER-URI, WS-CONFIG-OPTIONAL-OAUTH-PARAMS) TO WS-AUTH-RESPONSE
        MOVE FUNCTION OAUTH2-UTIL-AUTH-SESSION-FROM-TOKEN-RESPONSE(WS-INIT-CLIENT, NULL, WS-AUTH-RESPONSE, WS-START-TIME-MILLIS, WS-SESSION) TO WS-SESSION
    ELSE IF WS-CONFIG-TOKEN NOT EQUAL SPACES
        MOVE FUNCTION OAUTH2-UTIL-AUTH-SESSION-FROM-ACCESS-TOKEN(WS-INIT-CLIENT, NULL, WS-CONFIG-TOKEN, NULL, WS-SESSION) TO WS-SESSION
    END-IF
    RETURN WS-SESSION.

CATALOG-SESSION.
    MOVE WS-SHARED-CLIENT TO WS-CLIENT
    MOVE FUNCTION NEW-SESSION-CACHE(WS-NAME, WS-PROPERTIES) TO WS-SESSION-CACHE
    MOVE FUNCTION AUTH-CONFIG-FROM-PROPERTIES(WS-PROPERTIES) TO WS-CONFIG
    MOVE FUNCTION OAUTH2-UTIL-AUTH-HEADERS(WS-CONFIG-TOKEN) TO WS-HEADERS
    MOVE FUNCTION OAUTH2-UTIL-AUTH-SESSION(WS-HEADERS, WS-CONFIG) TO WS-SESSION
    PERFORM KEEP-REFRESHED
    IF WS-AUTH-RESPONSE NOT EQUAL SPACES
        MOVE FUNCTION OAUTH2-UTIL-AUTH-SESSION-FROM-TOKEN-RESPONSE(WS-CLIENT, FUNCTION REFRESH-EXECUTOR, WS-AUTH-RESPONSE, WS-START-TIME-MILLIS, WS-SESSION) TO WS-SESSION
    ELSE IF WS-CONFIG-CREDENTIAL NOT EQUAL SPACES AND WS-CONFIG-CREDENTIAL NOT EQUAL SPACES
        MOVE FUNCTION OAUTH2-UTIL-FETCH-TOKEN(WS-SHARED-CLIENT, WS-HEADERS, WS-CONFIG-CREDENTIAL, WS-CONFIG-SCOPE, WS-CONFIG-OAUTH2-SERVER-URI, WS-CONFIG-OPTIONAL-OAUTH-PARAMS) TO WS-AUTH-RESPONSE
        MOVE FUNCTION OAUTH2-UTIL-AUTH-SESSION-FROM-TOKEN-RESPONSE(WS-SHARED-CLIENT, FUNCTION REFRESH-EXECUTOR, WS-AUTH-RESPONSE, FUNCTION SYSTEM-MILLISECONDS, WS-SESSION) TO WS-SESSION
    ELSE IF WS-CONFIG-TOKEN NOT EQUAL SPACES
        MOVE FUNCTION OAUTH2-UTIL-AUTH-SESSION-FROM-ACCESS-TOKEN(WS-CLIENT, FUNCTION REFRESH-EXECUTOR, WS-CONFIG-TOKEN, WS-CONFIG-EXPIRES-AT-MILLIS, WS-SESSION) TO WS-SESSION
    END-IF
    RETURN WS-SESSION.

CONTEXTUAL-SESSION.
    PERFORM MAYBE-CREATE-CHILD-SESSION
        USING WS-CONTEXT-CREDENTIALS
        USING WS-CONTEXT-PROPERTIES
        USING FUNCTION SESSION-ID-FROM-CONTEXT
        USING WS-PARENT-SESSION
    .

TABLE-SESSION.
    PERFORM MAYBE-CREATE-CHILD-SESSION
        USING FUNCTION MAPS-FILTER-KEYS(WS-PROPERTIES, FUNCTION SPLIT(WS-TABLE-SESSION-ALLOW-LIST, ','))
        USING WS-PROPERTIES
        USING FUNCTION PROPERTIES-GET
        USING WS-PARENT-SESSION
    .

CLOSE.
    PERFORM SUPER-CLOSE
    IF WS-SESSION-CACHE NOT EQUAL SPACES
        PERFORM WS-SESSION-CACHE-CLOSE
        MOVE SPACES TO WS-SESSION-CACHE
    END-IF.

NEW-SESSION-CACHE.
    MOVE FUNCTION NEW-AUTH-SESSION-CACHE(WS-NAME, FUNCTION SESSION-TIMEOUT(WS-PROPERTIES)) TO RETURN-VALUE.

MAYBE-CREATE-CHILD-SESSION.
    IF WS-CREDENTIALS NOT EQUAL SPACES
        IF WS-CREDENTIALS-CONTAINS(OAUTH2-PROPERTIES-TOKEN)
            MOVE WS-CREDENTIALS-GET(OAUTH2-PROPERTIES-TOKEN) TO WS-TOKEN
            MOVE FUNCTION WS-SESSION-CACHE-CACHED-SESSION(FUNCTION CACHE-KEY-FROM-CREDENTIAL(OAUTH2-PROPERTIES-TOKEN), FUNCTION NEW-SESSION-FROM-ACCESS-TOKEN(WS-TOKEN, WS-PROPERTIES, WS-PARENT-SESSION)) TO RETURN-VALUE
        ELSE IF WS-CREDENTIALS-CONTAINS(OAUTH2-PROPERTIES-CREDENTIAL)
            MOVE WS-CREDENTIALS-GET(OAUTH2-PROPERTIES-CREDENTIAL) TO WS-CREDENTIAL
            MOVE FUNCTION WS-SESSION-CACHE-CACHED-SESSION(FUNCTION CACHE-KEY-FROM-CREDENTIAL(OAUTH2-PROPERTIES-CREDENTIAL), FUNCTION NEW-SESSION-FROM-CREDENTIAL(WS-CREDENTIAL, WS-PARENT-SESSION)) TO RETURN-VALUE
        ELSE
            PERFORM VARYING WS-TOKEN-TYPE FROM WS-TOKEN-PREFERENCE-ORDER
                WHEN WS-CREDENTIALS-CONTAINS(WS-TOKEN-TYPE)
                    MOVE WS-CREDENTIALS-GET(WS-TOKEN-TYPE) TO WS-TOKEN
                    MOVE FUNCTION WS-SESSION-CACHE-CACHED-SESSION(FUNCTION CACHE-KEY-FROM-CREDENTIAL(WS-TOKEN-TYPE), FUNCTION NEW-SESSION-FROM-TOKEN-EXCHANGE(WS-TOKEN, WS-TOKEN-TYPE, WS-PARENT-SESSION)) TO RETURN-VALUE
                    EXIT PERFORM
                END-WHEN
            END-PERFORM
        END-IF
    ELSE
        MOVE WS-PARENT-SESSION TO RETURN-VALUE
    END-IF.

NEW-SESSION-FROM-ACCESS-TOKEN.
    MOVE FUNCTION AUTH-CONFIG-FROM-PROPERTIES(WS-PROPERTIES)-EXPIRES-AT-MILLIS TO WS-EXPIRES-AT-MILLIS
    MOVE FUNCTION OAUTH2-UTIL-AUTH-SESSION-FROM-ACCESS-TOKEN(WS-CLIENT, FUNCTION REFRESH-EXECUTOR, WS-TOKEN, WS-EXPIRES-AT-MILLIS, WS-PARENT-SESSION) TO RETURN-VALUE.

NEW-SESSION-FROM-CREDENTIAL.
    MOVE FUNCTION OAUTH2-UTIL-AUTH-SESSION-FROM-CREDENTIAL(WS-CLIENT, FUNCTION REFRESH-EXECUTOR, WS-CREDENTIAL, WS-PARENT-SESSION) TO RETURN-VALUE.

NEW-SESSION-FROM-TOKEN-EXCHANGE.
    MOVE FUNCTION OAUTH2-UTIL-AUTH-SESSION-FROM-TOKEN-EXCHANGE(WS-CLIENT, FUNCTION REFRESH-EXECUTOR, WS-TOKEN, WS-TOKEN-TYPE, WS-PARENT-SESSION) TO RETURN-VALUE.

WARN-IF-DEPRECATED-TOKEN-ENDPOINT-USED.
    IF FUNCTION USES-DEPRECATED-TOKEN-ENDPOINT(WS-PROPERTIES)
        MOVE FUNCTION CATALOG-PROPERTIES-URI(WS-PROPERTIES) TO WS-CATALOG-URI
        MOVE FUNCTION RESOURCE-PATHS-TOKENS TO WS-TOKEN-PATH
        MOVE FUNCTION OAUTH2-PROPERTIES-OAUTH2-SERVER-URI TO WS-OAUTH2-SERVER-URI-PROP
        IF FUNCTION PROPERTIES-CONTAINS(WS-PROPERTIES, OAUTH2-PROPERTIES-CREDENTIAL) OR FUNCTION PROPERTIES-CONTAINS(WS-PROPERTIES, OAUTH2-PROPERTIES-TOKEN)
            DISPLAY "Iceberg REST client is missing the OAuth2 server URI configuration and defaults to " WS-CATALOG-URI "/" WS-TOKEN-PATH ". This automatic fallback will be removed in a future Iceberg release. It is recommended to configure the OAuth2 endpoint using the '" WS-OAUTH2-SERVER-URI-PROP "' property to be prepared. This warning will disappear if the OAuth2 endpoint is explicitly configured. See https://github.com/apache/iceberg/issues/10537"
        END-IF
    END-IF.

USES-DEPRECATED-TOKEN-ENDPOINT.
    IF FUNCTION PROPERTIES-CONTAINS(WS-PROPERTIES, OAUTH2-PROPERTIES-OAUTH2-SERVER-URI)
        MOVE FUNCTION PROPERTIES-GET(WS-PROPERTIES, OAUTH2-PROPERTIES-OAUTH2-SERVER-URI) TO WS-OAUTH2-SERVER-URI
        IF FUNCTION STARTS-WITH(WS-OAUTH2-SERVER-URI, 'http') THEN
            RETURN FALSE
        ELSE IF FUNCTION STARTS-WITH(WS-OAUTH2-SERVER-URI, FUNCTION CATALOG-PROPERTIES-URI(WS-PROPERTIES))
            RETURN TRUE
        ELSE
            RETURN TRUE
        END-IF
    ELSE
        RETURN TRUE
    END-IF.

SESSION-TIMEOUT.
    MOVE FUNCTION PROPERTY-UTIL-PROPERTY-AS-LONG(WS-PROPERTIES, CATALOG-PROPERTIES-AUTH-SESSION-TIMEOUT-MS, CATALOG-PROPERTIES-AUTH-SESSION-TIMEOUT-MS-DEFAULT) TO RETURN-VALUE.

KEEP-REFRESHED.
    PERFORM FUNCTION KEEP-REFRESHED(WS-CONFIG-KEEP-REFRESHED).

END PROGRAM OAUTH2-MANAGER.
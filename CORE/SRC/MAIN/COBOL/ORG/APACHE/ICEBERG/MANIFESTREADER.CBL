IDENTIFICATION DIVISION.
PROGRAM-ID. MANIFESTREADER.

ENVIRONMENT DIVISION.
INPUT-OUTPUT SECTION.
FILE-CONTROL.
    SELECT INPUTFILE ASSIGN TO DYNAMIC FILE-ID.

DATA DIVISION.
FILE SECTION.
FD  INPUTFILE.
    01  FILE-RECORD        PIC X(32767).

WORKING-STORAGE SECTION.
01  FILE-TYPE.
    88  DATA-FILES             VALUE 1.
    88  DELETE-FILES           VALUE 2.
01  STRUCT-LIKE             PIC X(256).
01  PARTITION-SPEC.
    05  SPEC-ID                PIC 9(9).
    05  PARTITION-TYPE         PIC X(128).
01  FILE-SCHEMA.
    05  SCHEMA-FIELDS          OCCURS 32767 TIMES.
        10  FIELD-NAME         PIC X(128).
        10  FIELD-TYPE         PIC X(128).
01  PARTITION-SET            PIC X(32767).
01  PART-FILTER              PIC X(32767).
01  ROW-FILTER               PIC X(32767).
01  PROJ-SCHEMA              PIC X(32767).
01  COLUMNS                  PIC X(32767).
01  CASE-SENSITIVE           PIC 9.
01  SCAN-METRICS             PIC X(32767).
01  LAZY-EVALUATOR           PIC X(32767).
01  LAZY-METRICS-EVALUATOR   PIC X(32767).
01  MANIFEST-ENTRY.
    05  ENTRY-FILE            PIC X(32767).
    05  ENTRY-STATUS          PIC X.

PROCEDURE DIVISION.
MAIN-PROCEDURE.
    PERFORM INIT-READER.
    PERFORM OPEN-READER.
    PERFORM PROCESS-ENTRIES.
    PERFORM CLOSE-READER.
    STOP RUN.

INIT-READER.
    MOVE INPUT-FILE TO FILE-ID.
    MOVE SPEC-ID TO SPEC-ID.
    MOVE PARTITION-TYPE TO PARTITION-TYPE.
    MOVE METADATA TO INHERITABLE-METADATA.
    IF DATA-FILES
        MOVE GENERICDATAFILE TO STRUCT-LIKE
    ELSE
        MOVE GENERICDELETEFILE TO STRUCT-LIKE.
    MOVE SCHEMA-FIELDS TO FILE-SCHEMA.

OPEN-READER.
    OPEN INPUT INPUTFILE.
    PERFORM READ-METADATA.

PROCESS-ENTRIES.
    IF HAS-ROW-FILTER OR HAS-PART-FILTER OR PARTITION-SET NOT NULL
        PERFORM PROCESS-FILTERED-ENTRIES
    ELSE
        PERFORM PROCESS-ALL-ENTRIES.

PROCESS-FILTERED-ENTRIES.
    PERFORM EVALUATE-ENTRIES.
    PERFORM FILTER-LIVE-ENTRIES.

PROCESS-ALL-ENTRIES.
    PERFORM OPEN-ENTRIES.
    PERFORM FILTER-LIVE-ENTRIES.

EVALUATE-ENTRIES.
    PERFORM EVALUATOR.
    PERFORM METRICS-EVALUATOR.

FILTER-LIVE-ENTRIES.
    PERFORM CHECK-LIVE-ENTRY.

CLOSE-READER.
    CLOSE INPUTFILE.

READ-METADATA.
    READ INPUTFILE
        INTO METADATA
        AT END
            MOVE SPACES TO METADATA.

EVALUATOR.
    IF LAZY-EVALUATOR IS NULL
        PERFORM BUILD-EVALUATOR.

METRICS-EVALUATOR.
    IF LAZY-METRICS-EVALUATOR IS NULL
        PERFORM BUILD-METRICS-EVALUATOR.

BUILD-EVALUATOR.
    MOVE PROJECTED-FILTER TO PART-FILTER.
    MOVE EVALUATOR-TYPE TO LAZY-EVALUATOR.

BUILD-METRICS-EVALUATOR.
    MOVE ROW-FILTER TO LAZY-METRICS-EVALUATOR.

CHECK-LIVE-ENTRY.
    IF MANIFEST-ENTRY-STATUS NOT = "DELETED"
        MOVE MANIFEST-ENTRY-FILE TO ENTRY-FILE.

OPEN-ENTRIES.
    PERFORM OPEN-MANIFEST-ENTRIES.
    PERFORM APPLY-INHERITABLE-METADATA.

OPEN-MANIFEST-ENTRIES.
    OPEN INPUT INPUTFILE
        USING MANIFEST-ENTRY-SCHEMA
        REUSING-CONTAINERS
        CUSTOM-TYPE MANIFEST-ENTRY-DATA-FILE-ID, STRUCT-LIKE
        CUSTOM-TYPE MANIFEST-ENTRY-PARTITION-ID, PARTITION-DATA.

APPLY-INHERITABLE-METADATA.
    PERFORM VARYING MANIFEST-ENTRY IN MANIFEST-ENTRIES
        MOVE INHERITABLE-METADATA TO MANIFEST-ENTRY.
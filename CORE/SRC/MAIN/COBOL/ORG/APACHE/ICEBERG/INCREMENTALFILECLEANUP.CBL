IDENTIFICATION DIVISION.
PROGRAM-ID. IncrementalFileCleanup.

ENVIRONMENT DIVISION.
REPOSITORY.
    CLASS FileIO IS "org.apache.iceberg.io.FileIO".
    CLASS ExecutorService IS "java.util.concurrent.ExecutorService".
    CLASS Consumer IS "java.util.function.Consumer".
    CLASS RuntimeIOException IS "org.apache.iceberg.exceptions.RuntimeIOException".
    CLASS CloseableIterable IS "org.apache.iceberg.io.CloseableIterable".
    CLASS ManifestFile IS "org.apache.iceberg.ManifestFile".
    CLASS ManifestReader IS "org.apache.iceberg.ManifestReader".
    CLASS ManifestEntry IS "org.apache.iceberg.ManifestEntry".
    CLASS PropertyUtil IS "org.apache.iceberg.util.PropertyUtil".
    CLASS SnapshotSummary IS "org.apache.iceberg.SnapshotSummary".
    CLASS SnapshotUtil IS "org.apache.iceberg.util.SnapshotUtil".
    CLASS Tasks IS "org.apache.iceberg.util.Tasks".
    CLASS Logger IS "org.slf4j.Logger".
    CLASS LoggerFactory IS "org.slf4j.LoggerFactory".

DATA DIVISION.
WORKING-STORAGE SECTION.
    01 WS-VALID-IDS PIC 9(18) OCCURS 99 TIMES.
    01 WS-EXPIRED-IDS PIC 9(18) OCCURS 99 TIMES.
    01 WS-ANCESTOR-IDS PIC 9(18) OCCURS 99 TIMES.
    01 WS-PICKED-ANCESTOR-SNAPSHOT-IDS PIC 9(18) OCCURS 99 TIMES.
    01 WS-VALID-MANIFESTS PIC X(256) OCCURS 99 TIMES.
    01 WS-MANIFESTS-TO-SCAN OCCURS 99 TIMES.
        05 WS-MANIFEST-PATH PIC X(256).
        05 WS-MANIFEST-SNAPSHOT-ID PIC 9(18).
        05 WS-MANIFEST-HAS-DELETED-FILES PIC X.
    01 WS-MANIFEST-LISTS-TO-DELETE PIC X(256) OCCURS 99 TIMES.
    01 WS-MANIFESTS-TO-DELETE PIC X(256) OCCURS 99 TIMES.
    01 WS-MANIFESTS-TO-REVERT OCCURS 99 TIMES.
        05 WS-REVERT-MANIFEST-PATH PIC X(256).
        05 WS-REVERT-MANIFEST-SNAPSHOT-ID PIC 9(18).
        05 WS-REVERT-MANIFEST-HAS-ADDED-FILES PIC X.
    01 WS-FILES-TO-DELETE PIC X(256) OCCURS 99 TIMES.
    01 WS-STATISTICS-FILES-TO-DELETE PIC X(256) OCCURS 99 TIMES.

PROCEDURE DIVISION.
    MAIN-PROCEDURE.
        PERFORM CLEAN-FILES.
        STOP RUN.

    CLEAN-FILES.
        PERFORM CLEAN-EXPIRED-SNAPSHOTS.
        PERFORM DELETE-FILES.
        PERFORM DELETE-STATISTICS-FILES.

    CLEAN-EXPIRED-SNAPSHOTS.
        * Code to clean up expired snapshots
        MOVE 0 TO WS-VALID-IDS-IX.
        MOVE 0 TO WS-EXPIRED-IDS-IX.
        MOVE 0 TO WS-ANCESTOR-IDS-IX.
        MOVE 0 TO WS-PICKED-ANCESTOR-SNAPSHOT-IDS-IX.
        MOVE 0 TO WS-VALID-MANIFESTS-IX.
        MOVE 0 TO WS-MANIFESTS-TO-SCAN-IX.
        MOVE 0 TO WS-MANIFEST-LISTS-TO-DELETE-IX.
        MOVE 0 TO WS-MANIFESTS-TO-DELETE-IX.
        MOVE 0 TO WS-MANIFESTS-TO-REVERT-IX.
        MOVE 0 TO WS-FILES-TO-DELETE-IX.
        MOVE 0 TO WS-STATISTICS-FILES-TO-DELETE-IX.

    DELETE-FILES.
        * Code to delete files
        PERFORM VARYING WS-FILES-TO-DELETE-IX FROM 1 BY 1 UNTIL WS-FILES-TO-DELETE-IX > WS-FILES-TO-DELETE-IX
            DISPLAY "Deleting data file: " WS-FILES-TO-DELETE(WS-FILES-TO-DELETE-IX)
        END-PERFORM.

        PERFORM VARYING WS-MANIFESTS-TO-DELETE-IX FROM 1 BY 1 UNTIL WS-MANIFESTS-TO-DELETE-IX > WS-MANIFESTS-TO-DELETE-IX
            DISPLAY "Deleting manifest file: " WS-MANIFESTS-TO-DELETE(WS-MANIFESTS-TO-DELETE-IX)
        END-PERFORM.

        PERFORM VARYING WS-MANIFEST-LISTS-TO-DELETE-IX FROM 1 BY 1 UNTIL WS-MANIFEST-LISTS-TO-DELETE-IX > WS-MANIFEST-LISTS-TO-DELETE-IX
            DISPLAY "Deleting manifest list: " WS-MANIFEST-LISTS-TO-DELETE(WS-MANIFEST-LISTS-TO-DELETE-IX)
        END-PERFORM.

    DELETE-STATISTICS-FILES.
        * Code to delete statistics files
        PERFORM VARYING WS-STATISTICS-FILES-TO-DELETE-IX FROM 1 BY 1 UNTIL WS-STATISTICS-FILES-TO-DELETE-IX > WS-STATISTICS-FILES-TO-DELETE-IX
            DISPLAY "Deleting statistics file: " WS-STATISTICS-FILES-TO-DELETE(WS-STATISTICS-FILES-TO-DELETE-IX)
        END-PERFORM.
IDENTIFICATION DIVISION.
PROGRAM-ID. JCBCCATALOG.

ENVIRONMENT DIVISION.
SPECIAL-NAMES.
  DECIMAL-POINT IS COMMA.

DATA DIVISION.
WORKING-STORAGE SECTION.
01 CATALOG-NAME PIC X(32) VALUE "jdbc".
01 WAREHOUSE-LOCATION PIC X(256).
01 CONF PIC X(1) VALUE SPACE.
01 CONNECTIONS PIC X(1) VALUE SPACE.
01 CATALOG-PROPERTIES PIC X(1) VALUE SPACE.
01 IO-BUILDER PIC X(1) VALUE SPACE.
01 CLIENT-POOL-BUILDER PIC X(1) VALUE SPACE.
01 INITIALIZE-CATALOG-TABLES PIC 9 VALUE 0.
01 CLOSEABLE-GROUP PIC X(1) VALUE SPACE.
01 SCHEMA-VERSION PIC 9 VALUE 0.

01 OPTION-STASH.
  05 OPTION-PREFIX PIC X(5) VALUE "jdbc.".
  05 NAMESPACE-EXISTS-PROPERTY PIC X(12) VALUE "exists".
  05 VIEW-WARNING-LOG-MESSAGE PIC X(160) 
    VALUE "JDBC catalog is initialized without view support. To auto-migrate the database's schema and enable view support, set jdbc.schema-version=V1".

01 CONSTANTS.
  05 SLASH PIC X(1) VALUE "/".

PROCEDURE DIVISION.

INITIALIZE-CATALOG.
  MOVE FUNCTION CONCATENATE("org.apache.iceberg.hadoop.HadoopFileIO") TO IO-IMPL.
  MOVE FUNCTION CONCATENATE("org.apache.iceberg.jdbc.JdbcClientPool") TO CLIENT-POOL-BUILDER.
  CALL "INITIALIZE" USING CATALOG-NAME, CATALOG-PROPERTIES.

INITIALIZE-CATALOG-TABLES.
  PERFORM UNTIL TABLE-CREATED
    CALL "CREATE-CATALOG-TABLE" USING JdbcUtil.CATALOG_TABLE_VIEW_NAME
    CALL "CREATE-NAMESPACE-PROPERTIES-TABLE" USING JdbcUtil.NAMESPACE_PROPERTIES_TABLE_NAME
  END-PERFORM.

UPDATE-SCHEMA-IF-REQUIRED.
  CALL "UPDATE-SCHEMA" USING SCHEMA-VERSION.

CLOSE-RESOURCES.
  CALL "CLOSE" USING CLOSEABLE-GROUP.

PROCEDURES.

CREATE-CATALOG-TABLE.
  CALL "EXECUTE-SQL" USING JdbcUtil.V0_CREATE_CATALOG_SQL.

CREATE-NAMESPACE-PROPERTIES-TABLE. 
  CALL "EXECUTE-SQL" USING JdbcUtil.CREATE_NAMESPACE_PROPERTIES_TABLE_SQL.

UPDATE-SCHEMA.
  PERFORM UNTIL SCHEMA-UPDATED
    CALL "CHECK-AND-UPDATE-SCHEMA" USING SCHEMA-VERSION
  END-PERFORM.

CHECK-AND-UPDATE-SCHEMA.
  CALL "EXECUTE-SQL" USING JdbcUtil.V1_UPDATE_CATALOG_SQL.
  IF SCHEMA-VERSION = JdbcUtil.SchemaVersion.V1 THEN
    SET SCHEMA-VERSION TO JdbcUtil.SchemaVersion.V1
  ELSE
    DISPLAY VIEW-WARNING-LOG-MESSAGE
  END-IF.

EXECUTE-SQL.
  CALL "RUN-SQL" USING SQL-STATEMENT, RETURN-CODE.
  IF RETURN-CODE NOT = 0 THEN
    CALL "HANDLE-SQL-ERROR" USING SQL-STATEMENT, RETURN-CODE
  END-IF.

RUN-SQL.
  PERFORM WITH TEST AFTER UNTIL SQLCODE = 0
    CALL "RUN-SQL-INTERNAL" USING SQL-STATEMENT, RETURN-CODE
    IF SQLCODE NOT = 0 THEN
      CALL "HANDLE-SQL-TIMEOUT-ERROR" USING SQL-STATEMENT, RETURN-CODE
      CALL "HANDLE-SQL-CONNECTION-ERROR" USING SQL-STATEMENT, RETURN-CODE
    END-IF
  END-PERFORM.

RUN-SQL-INTERNAL.
  OPEN DATABASE CONNECTION.
  PREPARE SQL-STATEMENT.
  EXECUTE SQL-STATEMENT.
  CLOSE DATABASE CONNECTION.
  MOVE SQLCODE TO RETURN-CODE.

HANDLE-SQL-TIMEOUT-ERROR.
  CALL "THROW-SQL-EXCEPTION" USING "Cannot initialize JDBC catalog: Query timed out".

HANDLE-SQL-CONNECTION-ERROR.
  CALL "THROW-SQL-EXCEPTION" USING "Cannot initialize JDBC catalog: Connection failed".

HANDLE-SQL-ERROR.
  CALL "THROW-SQL-EXCEPTION" USING "Cannot initialize JDBC catalog".

THROW-SQL-EXCEPTION.
  RAISE EXCEPTION 'SQLERROR' USING ERROR-MESSAGE.

PROCEDURE DIVISION.

MAIN-PROCEDURE.
  PERFORM INITIALIZE-CATALOG.
  PERFORM INITIALIZE-CATALOG-TABLES.
  PERFORM UPDATE-SCHEMA-IF-REQUIRED.
  PERFORM CLOSE-RESOURCES.
  STOP RUN.

END PROGRAM JCBCCATALOG.
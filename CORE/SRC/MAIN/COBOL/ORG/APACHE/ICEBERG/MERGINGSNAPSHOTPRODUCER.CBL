IDENTIFICATION DIVISION.
PROGRAM-ID. MERGING-SNAPSHOT-PRODUCER.

ENVIRONMENT DIVISION.
SPECIAL-NAMES.
    FUNCTION ORG-APACHE-ICEBERG IS
        "org.apache.iceberg".

DATA DIVISION.
WORKING-STORAGE SECTION.
01 TABLE-NAME PIC X(256) VALUE "org.apache.iceberg".
01 SNAPSHOT-SUMMARY-BUILDER.
    02 BUILDER-OBJECT PIC X(256) VALUE "SnapshotSummary.builder()".
01 MANIFEST-MERGE-MANAGER-DATA PIC X(256) VALUE "DataFileMergeManager".
01 MANIFEST-FILTER-MANAGER-DATA PIC X(256) VALUE "DataFileFilterManager".
01 MANIFEST-MERGE-MANAGER-DELETE PIC X(256) VALUE "DeleteFileMergeManager".
01 MANIFEST-FILTER-MANAGER-DELETE PIC X(256) VALUE "DeleteFileFilterManager".
01 VALIDATE-ADDED-FILES-OPERATIONS.
    02 ELEMENT PIC X(256) VALUE "org.apache.iceberg.DataOperations.APPEND".
    02 ELEMENT PIC X(256) VALUE "org.apache.iceberg.DataOperations.OVERWRITE".
01 VALIDATE-DATA-FILES-EXIST-OPERATIONS.
    02 ELEMENT PIC X(256) VALUE "org.apache.iceberg.DataOperations.OVERWRITE".
    02 ELEMENT PIC X(256) VALUE "org.apache.iceberg.DataOperations.REPLACE".
    02 ELEMENT PIC X(256) VALUE "org.apache.iceberg.DataOperations.DELETE".
01 VALIDATE-DATA-FILES-EXIST-SKIP-DELETE-OPERATIONS.
    02 ELEMENT PIC X(256) VALUE "org.apache.iceberg.DataOperations.OVERWRITE".
    02 ELEMENT PIC X(256) VALUE "org.apache.iceberg.DataOperations.REPLACE".
01 VALIDATE-ADDED-DELETE-FILES-OPERATIONS.
    02 ELEMENT PIC X(256) VALUE "org.apache.iceberg.DataOperations.OVERWRITE".
    02 ELEMENT PIC X(256) VALUE "org.apache.iceberg.DataOperations.DELETE".
01 VALIDATE-ADDED-DVS-OPERATIONS.
    02 ELEMENT PIC X(256) VALUE "org.apache.iceberg.DataOperations.OVERWRITE".
    02 ELEMENT PIC X(256) VALUE "org.apache.iceberg.DataOperations.DELETE".
    02 ELEMENT PIC X(256) VALUE "org.apache.iceberg.DataOperations.REPLACE".

PROCEDURE DIVISION.
    PERFORM MERGE-SNAPSHOT-PRODUCER-MAIN.

MERGE-SNAPSHOT-PRODUCER-MAIN.
    MOVE TABLE-NAME TO PROGRAM-ID.
    PERFORM INITIALIZE-MEMBERS.
    PERFORM APPLY.
    PERFORM CLEAN-UNCOMMITTED.
    MOVE SNAPSHOT-SUMMARY-BUILDER TO UPDATE-EVENT.

INITIALIZE-MEMBERS.
    MOVE "DataFileMergeManager" TO MANIFEST-MERGE-MANAGER-DATA.
    MOVE "DataFileFilterManager" TO MANIFEST-FILTER-MANAGER-DATA.
    MOVE "DeleteFileMergeManager" TO MANIFEST-MERGE-MANAGER-DELETE.
    MOVE "DeleteFileFilterManager" TO MANIFEST-FILTER-MANAGER-DELETE.
    MOVE ORG-APACHE-ICEBERG"MANIFEST_MIN_MERGE_COUNT" TO PROPERTY-NAME.
    MOVE ORG-APACHE-ICEBERG"MANIFEST_MIN_MERGE_COUNT_DEFAULT" TO PROPERTY-VALUE.
    MOVE ORG-APACHE-ICEBERG"MANIFEST_TARGET_SIZE_BYTES" TO PROPERTY-NAME.
    MOVE ORG-APACHE-ICEBERG"MANIFEST_TARGET_SIZE_BYTES_DEFAULT" TO PROPERTY-VALUE.
    MOVE ORG-APACHE-ICEBERG"MANIFEST_MERGE_ENABLED" TO PROPERTY-NAME.
    MOVE ORG-APACHE-ICEBERG"MANIFEST_MERGE_ENABLED_DEFAULT" TO PROPERTY-VALUE.
    PERFORM INITIALIZE-MERGE-MANAGER.
    PERFORM INITIALIZE-FILTER-MANAGER.
    PERFORM INITIALIZE-DELETE-MERGE-MANAGER.
    PERFORM INITIALIZE-DELETE-FILTER-MANAGER.

INITIALIZE-MERGE-MANAGER.
    PERFORM CREATE-OBJECT USING MANIFEST-MERGE-MANAGER-DATA.

INITIALIZE-FILTER-MANAGER.
    PERFORM CREATE-OBJECT USING MANIFEST-FILTER-MANAGER-DATA.

INITIALIZE-DELETE-MERGE-MANAGER.
    PERFORM CREATE-OBJECT USING MANIFEST-MERGE-MANAGER-DELETE.

INITIALIZE-DELETE-FILTER-MANAGER.
    PERFORM CREATE-OBJECT USING MANIFEST-FILTER-MANAGER-DELETE.

APPLY.
    PERFORM FILTER-EXISTING-MANIFESTS.
    PERFORM PREPARE-NEW-DATA-MANIFESTS.
    PERFORM PREPARE-DELETE-MANIFESTS.
    PERFORM UPDATE-SNAPSHOT-SUMMARY.
    PERFORM MERGE-MANIFESTS.

FILTER-EXISTING-MANIFESTS.
    PERFORM FILTER-DATA-MANIFESTS.
    PERFORM FILTER-DELETE-MANIFESTS.

FILTER-DATA-MANIFESTS.
    PERFORM CALL-FILTER-MANAGER USING MANIFEST-FILTER-MANAGER-DATA.

FILTER-DELETE-MANIFESTS.
    PERFORM CALL-FILTER-MANAGER USING MANIFEST-FILTER-MANAGER-DELETE.

PREPARE-NEW-DATA-MANIFESTS.
    PERFORM WRITE-NEW-DATA-MANIFESTS.
    PERFORM WRITE-APPEND-MANIFESTS.
    PERFORM WRITE-REWRITTEN-APPEND-MANIFESTS.

WRITE-NEW-DATA-MANIFESTS.
    PERFORM WRITE-DATA-MANIFESTS.

WRITE-APPEND-MANIFESTS.
    PERFORM WRITE-MANIFESTS USING APPEND-MANIFESTS.

WRITE-REWRITTEN-APPEND-MANIFESTS.
    PERFORM WRITE-MANIFESTS USING REWRITTEN-APPEND-MANIFESTS.

PREPARE-DELETE-MANIFESTS.
    PERFORM WRITE-NEW-DELETE-MANIFESTS.

WRITE-NEW-DELETE-MANIFESTS.
    PERFORM WRITE-DELETE-MANIFESTS.

UPDATE-SNAPSHOT-SUMMARY.
    PERFORM CLEAR-SUMMARY-BUILDER.
    PERFORM MERGE-ADDED-FILES-SUMMARY.
    PERFORM MERGE-APPENDED-MANIFESTS-SUMMARY.
    PERFORM MERGE-FILTER-MANAGER-SUMMARY USING MANIFEST-FILTER-MANAGER-DATA.
    PERFORM MERGE-FILTER-MANAGER-SUMMARY USING MANIFEST-FILTER-MANAGER-DELETE.

MERGE-ADDED-FILES-SUMMARY.
    MOVE ADDED-FILES-SUMMARY TO SNAPSHOT-SUMMARY-BUILDER.

MERGE-APPENDED-MANIFESTS-SUMMARY.
    MOVE APPENDED-MANIFESTS-SUMMARY TO SNAPSHOT-SUMMARY-BUILDER.

MERGE-FILTER-MANAGER-SUMMARY.
    MOVE FILTER-MANAGER-SUMMARY TO SNAPSHOT-SUMMARY-BUILDER.

MERGE-MANIFESTS.
    PERFORM MERGE-DATA-MANIFESTS.
    PERFORM MERGE-DELETE-MANIFESTS.

MERGE-DATA-MANIFESTS.
    PERFORM CALL-MERGE-MANAGER USING MANIFEST-MERGE-MANAGER-DATA.

MERGE-DELETE-MANIFESTS.
    PERFORM CALL-MERGE-MANAGER USING MANIFEST-MERGE-MANAGER-DELETE.

CALL-FILTER-MANAGER.
    PERFORM CREATE-OBJECT USING ARGUMENT.
    CALL FILTER-MANAGER-OBJECT.

CALL-MERGE-MANAGER.
    PERFORM CREATE-OBJECT USING ARGUMENT.
    CALL MERGE-MANAGER-OBJECT.

CLEAN-UNCOMMITTED.
    PERFORM CLEAN-UNCOMMITTED-APPENDS.
    PERFORM CALL-CLEAN-UNCOMMITTED USING MANIFEST-MERGE-MANAGER-DATA.
    PERFORM CALL-CLEAN-UNCOMMITTED USING MANIFEST-FILTER-MANAGER-DATA.
    PERFORM CALL-CLEAN-UNCOMMITTED USING MANIFEST-MERGE-MANAGER-DELETE.
    PERFORM CALL-CLEAN-UNCOMMITTED USING MANIFEST-FILTER-MANAGER-DELETE.

CLEAN-UNCOMMITTED-APPENDS.
    PERFORM CLEAN-CACHED-NEW-DATA-MANIFESTS.
    PERFORM CLEAN-CACHED-NEW-DELETE-MANIFESTS.
    PERFORM CLEAN-REWRITTEN-APPEND-MANIFESTS.
    PERFORM CLEAN-APPEND-MANIFESTS.

CLEAN-CACHED-NEW-DATA-MANIFESTS.
    PERFORM DELETE-CACHED-NEW-DATA-MANIFESTS.
    MOVE EMPTY TO CACHED-NEW-DATA-MANIFESTS.

CLEAN-CACHED-NEW-DELETE-MANIFESTS.
    PERFORM DELETE-CACHED-NEW-DELETE-MANIFESTS.
    MOVE EMPTY TO CACHED-NEW-DELETE-MANIFESTS.

CLEAN-REWRITTEN-APPEND-MANIFESTS.
    PERFORM DELETE-REWRITTEN-APPEND-MANIFESTS.

CLEAN-APPEND-MANIFESTS.
    PERFORM DELETE-APPEND-MANIFESTS.

DELETE-CACHED-NEW-DATA-MANIFESTS.
    PERFORM ITERATE THROUGH CACHED-NEW-DATA-MANIFESTS
        PERFORM DELETE-FILE USING MANIFEST-LOCATION.

DELETE-CACHED-NEW-DELETE-MANIFESTS.
    PERFORM ITERATE THROUGH CACHED-NEW-DELETE-MANIFESTS
        PERFORM DELETE-FILE USING MANIFEST-LOCATION.

DELETE-REWRITTEN-APPEND-MANIFESTS.
    PERFORM ITERATE THROUGH REWRITTEN-APPEND-MANIFESTS
        PERFORM DELETE-FILE USING MANIFEST-LOCATION.

DELETE-APPEND-MANIFESTS.
    PERFORM ITERATE THROUGH APPEND-MANIFESTS
        PERFORM DELETE-FILE USING MANIFEST-LOCATION.

CALL-CLEAN-UNCOMMITTED.
    PERFORM CREATE-OBJECT USING ARGUMENT.
    CALL CLEAN-UNCOMMITTED-OBJECT.

CREATE-OBJECT.
    PERFORM BASED ON ARGUMENT
        WHEN MANIFEST-MERGE-MANAGER-DATA PERFORM CREATE-MERGE-MANAGER-DATA
        WHEN MANIFEST-FILTER-MANAGER-DATA PERFORM CREATE-FILTER-MANAGER-DATA
        WHEN MANIFEST-MERGE-MANAGER-DELETE PERFORM CREATE-MERGE-MANAGER-DELETE
        WHEN MANIFEST-FILTER-MANAGER-DELETE PERFORM CREATE-FILTER-MANAGER-DELETE.

CREATE-MERGE-MANAGER-DATA.
    MOVE MANIFEST-MERGE-MANAGER-DATA TO MERGE-MANAGER-OBJECT.

CREATE-FILTER-MANAGER-DATA.
    MOVE MANIFEST-FILTER-MANAGER-DATA TO FILTER-MANAGER-OBJECT.

CREATE-MERGE-MANAGER-DELETE.
    MOVE MANIFEST-MERGE-MANAGER-DELETE TO MERGE-MANAGER-OBJECT.

CREATE-FILTER-MANAGER-DELETE.
    MOVE MANIFEST-FILTER-MANAGER-DELETE TO FILTER-MANAGER-OBJECT.

DELETE-FILE.
    PERFORM DELETE USING ARGUMENT.

UPDATE-EVENT.
    MOVE SNAPSHOT-SUMMARY-BUILDER TO RETURN-VALUE.
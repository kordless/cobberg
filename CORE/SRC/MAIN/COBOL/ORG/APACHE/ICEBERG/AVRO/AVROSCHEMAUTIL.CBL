IDENTIFICATION DIVISION.
PROGRAM-ID. AVRO-SCHEMA-UTIL.

ENVIRONMENT DIVISION.

DATA DIVISION.
    COPY "AVRO-SCHEMA-COPY.cpy".

PROCEDURE DIVISION.

    CONVERT-SCHEMA.
        MOVE FUNCTION CONVERT(ICEBERG-SCHEMA, TABLE-NAME) TO AVRO-SCHEMA.
        MOVE FUNCTION CONVERT(ICEBERG-SCHEMA, MAP-OF-STRUCT-TYPES) TO AVRO-SCHEMA.
        MOVE FUNCTION CONVERT(ICEBERG-TYPE) TO AVRO-SCHEMA.
        MOVE FUNCTION CONVERT(STRUCT-TYPE, NAME) TO AVRO-SCHEMA.
        MOVE FUNCTION CONVERT(ICEBERG-TYPE, MAP-OF-STRUCT-TYPES) TO AVRO-SCHEMA.
        MOVE FUNCTION CONVERT(ICEBERG-TYPE, NAMES-FUNCTION) TO AVRO-SCHEMA.

    CONVERT-TO-ICEBERG.
        MOVE FUNCTION CONVERT(AVRO-SCHEMA) TO ICEBERG-TYPE.
        MOVE FUNCTION TO-ICEBERG(AVRO-SCHEMA) TO ICEBERG-SCHEMA.

    CHECK-IDS.
        MOVE FUNCTION HAS-IDS(AVRO-SCHEMA) TO HAS-IDS-FLAG.
        MOVE FUNCTION MISSING-IDS(AVRO-SCHEMA) TO MISSING-IDS-FLAG.

    CONVERT-TYPES.
        MOVE FUNCTION CONVERT-TYPES(STRUCT-TYPE, NAME) TO MAP-OF-TYPES-TO-SCHEMAS.

    PRUNE-COLUMNS.
        MOVE FUNCTION PRUNE-COLUMNS(AVRO-SCHEMA, SET-OF-IDS) TO PRUNED-SCHEMA.
        MOVE FUNCTION PRUNE-COLUMNS(AVRO-SCHEMA, SET-OF-IDS, NAME-MAPPING) TO PRUNED-SCHEMA.

    BUILD-AVRO-PROJECTION.
        MOVE FUNCTION BUILD-AVRO-PROJECTION(AVRO-SCHEMA, ICEBERG-SCHEMA, MAP-OF-RENAMES) TO PROJECTED-SCHEMA.

    APPLY-NAME-MAPPING.
        MOVE FUNCTION APPLY-NAME-MAPPING(FILE-SCHEMA, NAME-MAPPING) TO MAPPED-SCHEMA.

    CHECK-TYPES.
        MOVE FUNCTION IS-TIMESTAMPTZ(AVRO-SCHEMA) TO IS-TIMESTAMPTZ-FLAG.
        MOVE FUNCTION IS-OPTION-SCHEMA(AVRO-SCHEMA) TO IS-OPTION-SCHEMA-FLAG.

    HANDLE-OPTIONS.
        MOVE FUNCTION TO-OPTION(AVRO-SCHEMA) TO OPTION-SCHEMA.
        MOVE FUNCTION FROM-OPTION(AVRO-SCHEMA) TO SCHEMA-WITHOUT-OPTION.
        MOVE FUNCTION FROM-OPTIONS(LIST-OF-OPTIONS) TO SCHEMA-WITHOUT-OPTION.

    CHECK-MAP.
        MOVE FUNCTION IS-KEY-VALUE-SCHEMA(AVRO-SCHEMA) TO IS-KEY-VALUE-SCHEMA-FLAG.

    CREATE-MAP.
        MOVE FUNCTION CREATE-MAP(KEY-ID, KEY-SCHEMA, VALUE-ID, VALUE-SCHEMA) TO MAP-SCHEMA.
        MOVE FUNCTION CREATE-PROJECTION-MAP(
            RECORD-NAME, KEY-ID, KEY-NAME, KEY-SCHEMA, VALUE-ID, VALUE-NAME, VALUE-SCHEMA) TO MAP-SCHEMA.

    GET-IDS.
        MOVE FUNCTION GET-KEY-ID(AVRO-SCHEMA) TO KEY-ID.
        MOVE FUNCTION GET-VALUE-ID(AVRO-SCHEMA) TO VALUE-ID.
        MOVE FUNCTION GET-ELEMENT-ID(AVRO-SCHEMA) TO ELEMENT-ID.
        MOVE FUNCTION GET-FIELD-ID(AVRO-FIELD) TO FIELD-ID.
        MOVE FUNCTION HAS-FIELD-ID(AVRO-FIELD) TO HAS-FIELD-ID-FLAG.

    COPY-SCHEMA.
        MOVE FUNCTION COPY-RECORD(RECORD-SCHEMA, LIST-OF-FIELDS, NEW-NAME) TO COPIED-SCHEMA.
        MOVE FUNCTION COPY-FIELD(AVRO-FIELD, NEW-SCHEMA, NEW-NAME) TO COPIED-FIELD.
        MOVE FUNCTION REPLACE-ELEMENT(ARRAY-SCHEMA, NEW-ELEMENT-SCHEMA) TO COPIED-SCHEMA.
        MOVE FUNCTION REPLACE-VALUE(MAP-SCHEMA, NEW-VALUE-SCHEMA) TO COPIED-SCHEMA.

    NAME-HANDLING.
        MOVE FUNCTION MAKE-COMPATIBLE-NAME(NAME) TO COMPATIBLE-NAME.
        MOVE FUNCTION VALID-AVRO-NAME(NAME) TO IS-VALID-AVRO-NAME-FLAG.
        MOVE FUNCTION SANITIZE(NAME) TO SANITIZED-NAME.

STOP RUN.
IDENTIFICATION DIVISION.
PROGRAM-ID. AVRO.

ENVIRONMENT DIVISION.
SPECIAL-NAMES.
    LOGICAL-MAP IS LogicalMap.

DATA DIVISION.
WORKING-STORAGE SECTION.
01 ZSTD-COMPRESSION-LEVEL-DEFAULT PIC 9(9) VALUE 1.
01 GZIP-COMPRESSION-LEVEL-DEFAULT PIC 9(9) VALUE 9.
01 DEFAULT-MODEL USAGE POINTER.

PROCEDURE DIVISION.

MAIN-PROCEDURE.
    SET LogicalTypes TO LogicalMap.
    SET DEFAULT-MODEL TO SpecificData.
    CALL "ADD-LOGICAL-TYPE-CONVERSION" USING DEFAULT-MODEL, DECIMAL-CONVERSION.
    CALL "ADD-LOGICAL-TYPE-CONVERSION" USING DEFAULT-MODEL, UUID-CONVERSION.

    CALL "WRITE" USING OUTPUT-FILE RETURNING WRITE-BUILDER.
    CALL "WRITE" USING ENCRYPTED-OUTPUT-FILE RETURNING WRITE-BUILDER.

    CALL "WRITE-DATA" USING OUTPUT-FILE RETURNING DATA-WRITE-BUILDER.
    CALL "WRITE-DATA" USING ENCRYPTED-OUTPUT-FILE RETURNING DATA-WRITE-BUILDER.

    CALL "WRITE-DELETES" USING OUTPUT-FILE RETURNING DELETE-WRITE-BUILDER.
    CALL "WRITE-DELETES" USING ENCRYPTED-OUTPUT-FILE RETURNING DELETE-WRITE-BUILDER.

    CALL "READ" USING INPUT-FILE RETURNING READ-BUILDER.

    CALL "ROW-COUNT" USING INPUT-FILE RETURNING ROW-COUNT.

    STOP RUN.

COPY "COMMON-STRUCTURES.cpy".

IDENTIFICATION DIVISION.
PROGRAM-ID. WRITE-BUILDER.

ENVIRONMENT DIVISION.
SPECIAL-NAMES.
    LOGICAL-MAP IS LogicalMap.

DATA DIVISION.
WORKING-STORAGE SECTION.
01 CONFIG PIC X(32500) VALUE SPACE.
01 METADATA PIC X(32500) VALUE SPACE.
01 SCHEMA PIC X(32767) VALUE SPACE.
01 NAME PIC X(256) VALUE SPACE.
01 CREATE-WRITER-FUNC USAGE PROCEDURE-POINTER.
01 OVERWRITE PIC 9 VALUE 0.
01 METRICS-CONFIG USAGE POINTER.
01 CREATE-CONTEXT-FUNC USAGE PROCEDURE-POINTER.

PROCEDURE DIVISION USING OUTPUT-FILE.
    MOVE OUTPUT-FILE TO FILE.
    
    PERFORM WRITE-BUILDER-METHODS.

    CALL "BUILD" RETURNING FILE-APPENDER.
    EXIT PROGRAM.

WRITE-BUILDER-METHODS.
    CALL "SCHEMA" USING SCHEMA RETURNING WRITE-BUILDER.
    CALL "NAMED" USING NAME RETURNING WRITE-BUILDER.
    CALL "CREATE-WRITER-FUNC" USING CREATE-WRITER-FUNC RETURNING WRITE-BUILDER.
    CALL "SET" USING PROPERTY, VALUE RETURNING WRITE-BUILDER.
    CALL "SET-ALL" USING CONFIG RETURNING WRITE-BUILDER.
    CALL "META" USING PROPERTY, VALUE RETURNING WRITE-BUILDER.
    CALL "META" USING METADATA RETURNING WRITE-BUILDER.
    CALL "METRICS-CONFIG" USING METRICS-CONFIG RETURNING WRITE-BUILDER.
    CALL "OVERWRITE" RETURNING WRITE-BUILDER.
    CALL "OVERWRITE" USING OVERWRITE RETURNING WRITE-BUILDER.
    CALL "CREATE-CONTEXT-FUNC" USING CREATE-CONTEXT-FUNC RETURNING WRITE-BUILDER.

IDENTIFICATION DIVISION.
PROGRAM-ID. DATA-WRITE-BUILDER.

ENVIRONMENT DIVISION.
SPECIAL-NAMES.
    LOGICAL-MAP IS LogicalMap.

DATA DIVISION.
WORKING-STORAGE SECTION.
01 APPENDER-BUILDER USAGE POINTER.
01 LOCATION PIC X(1024) VALUE SPACE.
01 SPEC USAGE POINTER.
01 PARTITION USAGE POINTER.
01 KEY-METADATA USAGE POINTER.
01 SORT-ORDER USAGE POINTER.

PROCEDURE DIVISION USING OUTPUT-FILE.
    MOVE OUTPUT-FILE TO FILE.
    CALL "WRITE" USING FILE RETURNING APPENDER-BUILDER.
    MOVE FILE-LOCATION TO LOCATION.
    
    PERFORM DATA-WRITE-BUILDER-METHODS.

    CALL "BUILD" RETURNING DATA-WRITER.
    EXIT PROGRAM.

DATA-WRITE-BUILDER-METHODS.
    CALL "FOR-TABLE" USING TABLE RETURNING DATA-WRITE-BUILDER.
    CALL "SCHEMA" USING SCHEMA RETURNING DATA-WRITE-BUILDER.
    CALL "SET" USING PROPERTY, VALUE RETURNING DATA-WRITE-BUILDER.
    CALL "SET-ALL" USING CONFIG RETURNING DATA-WRITE-BUILDER.
    CALL "META" USING PROPERTY, VALUE RETURNING DATA-WRITE-BUILDER.
    CALL "OVERWRITE" RETURNING DATA-WRITE-BUILDER.
    CALL "OVERWRITE" USING OVERWRITE RETURNING DATA-WRITE-BUILDER.
    CALL "METRICS-CONFIG" USING METRICS-CONFIG RETURNING DATA-WRITE-BUILDER.
    CALL "CREATE-WRITER-FUNC" USING CREATE-WRITER-FUNC RETURNING DATA-WRITE-BUILDER.
    CALL "WITH-SPEC" USING SPEC RETURNING DATA-WRITE-BUILDER.
    CALL "WITH-PARTITION" USING PARTITION RETURNING DATA-WRITE-BUILDER.
    CALL "WITH-KEY-METADATA" USING KEY-METADATA RETURNING DATA-WRITE-BUILDER.
    CALL "WITH-SORT-ORDER" USING SORT-ORDER RETURNING DATA-WRITE-BUILDER.

IDENTIFICATION DIVISION.
PROGRAM-ID. DELETE-WRITE-BUILDER.

ENVIRONMENT DIVISION.
SPECIAL-NAMES.
    LOGICAL-MAP IS LogicalMap.

DATA DIVISION.
WORKING-STORAGE SECTION.
01 APPENDER-BUILDER USAGE POINTER.
01 LOCATION PIC X(1024) VALUE SPACE.
01 CREATE-WRITER-FUNC USAGE PROCEDURE-POINTER.
01 ROW-SCHEMA PIC X(32767) VALUE SPACE.
01 SPEC USAGE POINTER.
01 PARTITION USAGE POINTER.
01 KEY-METADATA USAGE POINTER.
01 EQUALITY-FIELD-IDS PIC X(256) VALUE SPACE.
01 SORT-ORDER USAGE POINTER.

PROCEDURE DIVISION USING OUTPUT-FILE.
    MOVE OUTPUT-FILE TO FILE.
    CALL "WRITE" USING FILE RETURNING APPENDER-BUILDER.
    MOVE FILE-LOCATION TO LOCATION.
    
    PERFORM DELETE-WRITE-BUILDER-METHODS.

    CALL "BUILD-EQUALITY-WRITER" RETURNING EQUALITY-DELETE-WRITER.
    CALL "BUILD-POSITION-WRITER" RETURNING POSITION-DELETE-WRITER.
    EXIT PROGRAM.

DELETE-WRITE-BUILDER-METHODS.
    CALL "FOR-TABLE" USING TABLE RETURNING DELETE-WRITE-BUILDER.
    CALL "SET" USING PROPERTY, VALUE RETURNING DELETE-WRITE-BUILDER.
    CALL "SET-ALL" USING CONFIG RETURNING DELETE-WRITE-BUILDER.
    CALL "META" USING PROPERTY, VALUE RETURNING DELETE-WRITE-BUILDER.
    CALL "META" USING METADATA RETURNING DELETE-WRITE-BUILDER.
    CALL "OVERWRITE" RETURNING DELETE-WRITE-BUILDER.
    CALL "OVERWRITE" USING OVERWRITE RETURNING DELETE-WRITE-BUILDER.
    CALL "METRICS-CONFIG" USING METRICS-CONFIG RETURNING DELETE-WRITE-BUILDER.
    CALL "CREATE-WRITER-FUNC" USING CREATE-WRITER-FUNC RETURNING DELETE-WRITE-BUILDER.
    CALL "ROW-SCHEMA" USING ROW-SCHEMA RETURNING DELETE-WRITE-BUILDER.
    CALL "WITH-SPEC" USING SPEC RETURNING DELETE-WRITE-BUILDER.
    CALL "WITH-PARTITION" USING PARTITION RETURNING DELETE-WRITE-BUILDER.
    CALL "WITH-KEY-METADATA" USING KEY-METADATA RETURNING DELETE-WRITE-BUILDER.
    CALL "EQUALITY-FIELD-IDS" USING EQUALITY-FIELD-IDS RETURNING DELETE-WRITE-BUILDER.
    CALL "WITH-SORT-ORDER" USING SORT-ORDER RETURNING DELETE-WRITE-BUILDER.

IDENTIFICATION DIVISION.
PROGRAM-ID. READ-BUILDER.

ENVIRONMENT DIVISION.
SPECIAL-NAMES.
    LOGICAL-MAP IS LogicalMap.

DATA DIVISION.
WORKING-STORAGE SECTION.
01 RENAMES PIC X(32500) VALUE SPACE.
01 TYPE-MAP PIC X(1024) VALUE SPACE.
01 ROOT-TYPE PIC X(256) VALUE SPACE.
01 LOADER USAGE POINTER.
01 NAME-MAPPING USAGE POINTER.
01 REUSE-CONTAINERS PIC 9 VALUE 0.
01 SCHEMA PIC X(32767) VALUE SPACE.
01 CREATE-READER-FUNC USAGE PROCEDURE-POINTER.
01 CREATE-READER-BI-FUNC USAGE PROCEDURE-POINTER.
01 CREATE-RESOLVING-READER-FUNC USAGE PROCEDURE-POINTER.
01 START-POS PIC 9(18) VALUE 0.
01 LENGTH PIC 9(18) VALUE 0.

PROCEDURE DIVISION USING INPUT-FILE.
    MOVE INPUT-FILE TO FILE.
    
    PERFORM READ-BUILDER-METHODS.

    CALL "BUILD" RETURNING AVRO-ITERABLE.
    EXIT PROGRAM.

READ-BUILDER-METHODS.
    CALL "CREATE-RESOLVING-READER" USING CREATE-RESOLVING-READER-FUNC RETURNING READ-BUILDER.
    CALL "CREATE-READER-FUNC" USING CREATE-READER-FUNC RETURNING READ-BUILDER.
    CALL "CREATE-READER-FUNC" USING CREATE-READER-BI-FUNC RETURNING READ-BUILDER.
    CALL "SPLIT" USING START-POS, LENGTH RETURNING READ-BUILDER.
    CALL "PROJECT" USING SCHEMA RETURNING READ-BUILDER.
    CALL "REUSE-CONTAINERS" RETURNING READ-BUILDER.
    CALL "REUSE-CONTAINERS" USING REUSE-CONTAINERS RETURNING READ-BUILDER.
    CALL "RENAME" USING FULL-NAME, NEW-NAME RETURNING READ-BUILDER.
    CALL "SET-ROOT-TYPE" USING ROOT-TYPE RETURNING READ-BUILDER.
    CALL "SET-CUSTOM-TYPE" USING FIELD-ID, STRUCT-CLASS RETURNING READ-BUILDER.
    CALL "WITH-NAME-MAPPING" USING NAME-MAPPING RETURNING READ-BUILDER.
    CALL "CLASS-LOADER" USING LOADER RETURNING READ-BUILDER.

IDENTIFICATION DIVISION.
PROGRAM-ID. POSITION-DATUM-WRITER.

ENVIRONMENT DIVISION.
SPECIAL-NAMES.
    LOGICAL-MAP IS LogicalMap.

DATA DIVISION.
WORKING-STORAGE SECTION.
01 PATH-WRITER USAGE POINTER.
01 POS-WRITER USAGE POINTER.

PROCEDURE DIVISION.
    CALL "SET-SCHEMA" USING SCHEMA.
    CALL "WRITE" USING POSITION-DELETE, ENCODER.
    CALL "METRICS" RETURNING FIELD-METRICS-STREAM.
    EXIT PROGRAM.

IDENTIFICATION DIVISION.
PROGRAM-ID. POSITION-AND-ROW-DATUM-WRITER.

ENVIRONMENT DIVISION.
SPECIAL-NAMES.
    LOGICAL-MAP IS LogicalMap.

DATA DIVISION.
WORKING-STORAGE SECTION.
01 PATH-WRITER USAGE POINTER.
01 POS-WRITER USAGE POINTER.
01 ROW-WRITER USAGE POINTER.

PROCEDURE DIVISION USING ROW-WRITER.
    MOVE ROW-WRITER TO ROW-WRITER.
    CALL "SET-SCHEMA" USING SCHEMA.
    CALL "WRITE" USING POSITION-DELETE, ENCODER.
    CALL "METRICS" RETURNING FIELD-METRICS-STREAM.
    EXIT PROGRAM.

IDENTIFICATION DIVISION.
PROGRAM-ID. AVRO-IO.

ENVIRONMENT DIVISION.
SPECIAL-NAMES.
    LOGICAL-MAP IS LogicalMap.

DATA DIVISION.
WORKING-STORAGE SECTION.
01 START-ROW-POS PIC 9(18) VALUE 0.
01 MAX-ROWS PIC 9(18) VALUE 0.

PROCEDURE DIVISION.
    CALL "FIND-STARTING-ROW-POS" USING FILE-STREAM, MAX-ROWS RETURNING START-ROW-POS.
    EXIT PROGRAM.

STOP RUN.
IDENTIFICATION DIVISION.
PROGRAM-ID. ALL-MANIFESTS-TABLE.

ENVIRONMENT DIVISION.
REPOSITORY.
    COPY "ICEBERG-TYPES.cpy".

DATA DIVISION.
WORKING-STORAGE SECTION.
01 MANIFEST-FILE-SCHEMA.
    02 CONTENT PIC 9(9) COMP.
    02 PATH PIC X(32767).
    02 LENGTH PIC 9(18) COMP.
    02 PARTITION-SPEC-ID PIC 9(9) COMP.
    02 ADDED-SNAPSHOT-ID PIC 9(18) COMP.
    02 ADDED-DATA-FILES-COUNT PIC 9(9) COMP.
    02 EXISTING-DATA-FILES-COUNT PIC 9(9) COMP.
    02 DELETED-DATA-FILES-COUNT PIC 9(9) COMP.
    02 ADDED-DELETE-FILES-COUNT PIC 9(9) COMP.
    02 EXISTING-DELETE-FILES-COUNT PIC 9(9) COMP.
    02 DELETED-DELETE-FILES-COUNT PIC 9(9) COMP.
    02 PARTITION-SUMMARIES.
        03 CONTAINS-NULL PIC X.
        03 CONTAINS-NAN PIC X.
        03 LOWER-BOUND PIC X(32767).
        03 UPPER-BOUND PIC X(32767).
    02 REFERENCE-SNAPSHOT-ID PIC 9(18) COMP.

PROCEDURE DIVISION.
ALL-MANIFESTS-TABLE-SECTION.
    PERFORM NEW-SCAN.
    PERFORM SCHEMA.
    PERFORM METADATA-TABLE-TYPE.

NEW-SCAN.
    PERFORM NEW-ALL-MANIFESTS-TABLE-SCAN.

SCHEMA.
    MOVE MANIFEST-FILE-SCHEMA TO RETURN-CODE.

METADATA-TABLE-TYPE.
    MOVE "ALL_MANIFESTS" TO RETURN-CODE.

NEW-ALL-MANIFESTS-TABLE-SCAN.
    PERFORM ALL-MANIFESTS-TABLE-SCAN-CONSTRUCTOR.
    PERFORM PLAN-FILES.

ALL-MANIFESTS-TABLE-SCAN-CONSTRUCTOR.
    MOVE TABLE TO SELF-TABLE.
    MOVE MANIFEST-FILE-SCHEMA TO SELF-SCHEMA.
    MOVE "ALL_MANIFESTS" TO SELF-METADATA-TABLE-TYPE.

PLAN-FILES.
    PERFORM GET-FILE-IO.
    PERFORM GET-SPECS.
    PERFORM GET-DATA-TABLE-SCHEMA.
    PERFORM GET-FILTER.
    PERFORM GET-SNAPSHOT-EVALUATOR.
    PERFORM GET-FILTERED-SNAPSHOTS.
    PERFORM CREATE-MANIFEST-READ-TASKS.

GET-FILE-IO.
    MOVE TABLE-IO TO FILE-IO.

GET-SPECS.
    MOVE TABLE-SPECS TO SPECS.

GET-DATA-TABLE-SCHEMA.
    MOVE TABLE-SCHEMA TO DATA-TABLE-SCHEMA.

GET-FILTER.
    PERFORM SHOULD-IGNORE-RESIDUALS.
    IF SHOULD-IGNORE-RESIDUALS
        MOVE EXPRESSIONS-ALWAYS-TRUE TO FILTER
    ELSE
        MOVE FILTER TO FILTER.

GET-SNAPSHOT-EVALUATOR.
    MOVE MANIFEST-FILE-SCHEMA-STRUCT TO STRUCT-TYPE.
    MOVE TABLE-CASE-SENSITIVE TO CASE-SENSITIVE.
    PERFORM BINDER-BIND.
    MOVE BOUND-EXPR TO SNAPSHOT-EVALUATOR-EXPR.

GET-FILTERED-SNAPSHOTS.
    PERFORM FILTER-SNAPSHOTS.

CREATE-MANIFEST-READ-TASKS.
    PERFORM CREATE-MANIFEST-LIST-READ-TASKS.
    PERFORM CREATE-STATIC-DATA-TASKS.

FILTER-SNAPSHOTS.
    MOVE TABLE-SNAPSHOTS TO FILTERED-SNAPSHOTS.
    PERFORM ITERATE-FILTERED-SNAPSHOTS.

ITERATE-FILTERED-SNAPSHOTS.
    PERFORM MANIFEST-LIST-READ-TASK-CONSTRUCTOR.
    PERFORM STATIC-DATA-TASK-CONSTRUCTOR.

MANIFEST-LIST-READ-TASK-CONSTRUCTOR.
    MOVE DATA-TABLE-SCHEMA TO SELF-DATA-TABLE-SCHEMA.
    MOVE FILE-IO TO SELF-IO.
    MOVE MANIFEST-FILE-SCHEMA TO SELF-SCHEMA.
    MOVE SPECS TO SELF-SPECS.
    MOVE SNAPSHOT-MANIFEST-LIST-LOCATION TO SELF-MANIFEST-LIST-LOCATION.
    MOVE FILTER TO SELF-RESIDUAL.
    MOVE SNAPSHOT-ID TO SELF-REFERENCE-SNAPSHOT-ID.

STATIC-DATA-TASK-CONSTRUCTOR.
    MOVE SPECS-GET-PARTITION-SPEC TO SELF-SPEC.
    MOVE SNAPSHOT-MANIFEST TO SELF-MANIFEST.
    MOVE SNAPSHOT-ID TO SELF-REFERENCE-SNAPSHOT-ID.
    PERFORM MANIFEST-FILE-TO-ROW.

MANIFEST-FILE-TO-ROW.
    MOVE MANIFEST-CONTENT-ID TO CONTENT.
    MOVE MANIFEST-PATH TO PATH.
    MOVE MANIFEST-LENGTH TO LENGTH.
    MOVE MANIFEST-PARTITION-SPEC-ID TO PARTITION-SPEC-ID.
    MOVE MANIFEST-SNAPSHOT-ID TO ADDED-SNAPSHOT-ID.
    IF MANIFEST-CONTENT = DATA
        MOVE MANIFEST-ADDED-FILES-COUNT TO ADDED-DATA-FILES-COUNT
        MOVE MANIFEST-EXISTING-FILES-COUNT TO EXISTING-DATA-FILES-COUNT
        MOVE MANIFEST-DELETED-FILES-COUNT TO DELETED-DATA-FILES-COUNT
    ELSE
        MOVE MANIFEST-ADDED-FILES-COUNT TO ADDED-DELETE-FILES-COUNT
        MOVE MANIFEST-EXISTING-FILES-COUNT TO EXISTING-DELETE-FILES-COUNT
        MOVE MANIFEST-DELETED-FILES-COUNT TO DELETED-DELETE-FILES-COUNT.
    PERFORM PARTITION-SUMMARIES-TO-ROWS.
    MOVE REFERENCE-SNAPSHOT-ID TO REFERENCE-SNAPSHOT-ID.

PARTITION-SUMMARIES-TO-ROWS.
    MOVE MANIFEST-PARTITIONS TO PARTITION-SUMMARIES.

SHOULD-IGNORE-RESIDUALS.
    MOVE TRUE TO RETURN-CODE.

STOP RUN.
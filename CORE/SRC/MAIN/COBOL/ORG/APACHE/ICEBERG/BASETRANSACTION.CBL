IDENTIFICATION DIVISION.
PROGRAM-ID. BASE-TRANSACTION.

ENVIRONMENT DIVISION.
SPECIAL-NAMES.
    QSAM IS STREAM-IO.

DATA DIVISION.
FILE SECTION.

WORKING-STORAGE SECTION.
01 WS-TABLE-NAME PIC X(256).
01 WS-TABLE-OPERATIONS.
   05 WS-OPS PIC X(256).
   05 WS-TRANSACTION-TABLE PIC X(256).
   05 WS-TRANSACTION-OPS PIC X(256).
   05 WS-UPDATES OCCURS 9999 TIMES.
      10 WS-UPDATE PIC X(256).
   05 WS-DELETED-FILES OCCURS 9999 TIMES.
      10 WS-DELETED-FILE PIC X(256).
   05 WS-ENQUEUE-DELETE PIC X(256).
   05 WS-TYPE PIC X(32).
   05 WS-BASE PIC X(256).
   05 WS-CURRENT PIC X(256).
   05 WS-HAS-LAST-OP-COMMITTED PIC X.
   05 WS-REPORTER PIC X(256).

PROCEDURE DIVISION.

MAIN-SECTION.
    MOVE FUNCTION TRIM(TABLENAME) TO WS-TABLE-NAME.
    MOVE FUNCTION TRIM(OPS) TO WS-OPS.
    MOVE FUNCTION TRIM(TYPE) TO WS-TYPE.
    MOVE FUNCTION TRIM(START) TO WS-BASE.
    MOVE FUNCTION TRIM(START) TO WS-CURRENT.
    MOVE FUNCTION TRIM(REPORTER) TO WS-REPORTER.
    PERFORM TRANSACTION-PROCESSING.
    STOP RUN.

TRANSACTION-PROCESSING SECTION.
    PERFORM CHECK-LAST-OPERATION-COMMITTED.
    EVALUATE WS-TYPE
        WHEN "CREATE_TABLE"
            PERFORM COMMIT-CREATE-TRANSACTION
        WHEN "REPLACE_TABLE"
            PERFORM COMMIT-REPLACE-TRANSACTION
        WHEN "CREATE_OR_REPLACE_TABLE"
            PERFORM COMMIT-REPLACE-TRANSACTION
        WHEN "SIMPLE"
            PERFORM COMMIT-SIMPLE-TRANSACTION
    END-EVALUATE.

CHECK-LAST-OPERATION-COMMITTED SECTION.
    IF WS-HAS-LAST-OP-COMMITTED = 'N'
        MOVE 'Y' TO WS-HAS-LAST-OP-COMMITTED
    ELSE
        MOVE 'N' TO WS-HAS-LAST-OP-COMMITTED
        PERFORM ERROR-HANDLING
    END-IF.

COMMIT-CREATE-TRANSACTION SECTION.
    PERFORM COMMIT-OPERATION
    PERFORM CLEAN-UP-DELETED-FILES.

COMMIT-REPLACE-TRANSACTION SECTION.
    PERFORM COMMIT-OPERATION
    PERFORM CLEAN-UP-DELETED-FILES.

COMMIT-SIMPLE-TRANSACTION SECTION.
    IF WS-BASE = WS-CURRENT
        RETURN
    END-IF.
    PERFORM COMMIT-OPERATION
    PERFORM CLEAN-UP-DELETED-FILES.

COMMIT-OPERATION SECTION.
    PERFORM VARYING WS-OPS FROM 1 BY 1 UNTIL WS-OPS > 9999
        PERFORM APPLY-UPDATES
        CALL "COMMIT" USING WS-BASE, WS-CURRENT
    END-PERFORM.

APPLY-UPDATES SECTION.
    PERFORM VARYING WS-UPDATE FROM 1 BY 1 UNTIL WS-UPDATE > 9999
        CALL "COMMIT" USING WS-UPDATE
    END-PERFORM.

CLEAN-UP-DELETED-FILES SECTION.
    PERFORM VARYING WS-DELETED-FILE FROM 1 BY 1 UNTIL WS-DELETED-FILE > 9999
        CALL "DELETE-FILE" USING WS-DELETED-FILE
    END-PERFORM.

ERROR-HANDLING SECTION.
    PERFORM CLEAN-UP-DELETED-FILES
    PERFORM CLEAN-UP-UPDATES
    PERFORM THROW-EXCEPTION.

CLEAN-UP-UPDATES SECTION.
    PERFORM VARYING WS-UPDATE FROM 1 BY 1 UNTIL WS-UPDATE > 9999
        IF WS-UPDATE IS SnapshotProducer
            CALL "CLEAN-ALL" USING WS-UPDATE
        END-IF
    END-PERFORM.

THROW-EXCEPTION SECTION.
    RAISE EXCEPTION.

END PROGRAM BASE-TRANSACTION.
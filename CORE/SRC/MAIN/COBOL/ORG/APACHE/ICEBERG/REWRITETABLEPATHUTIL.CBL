IDENTIFICATION DIVISION.
PROGRAM-ID. REWRITE-TABLE-PATH-UTIL.

ENVIRONMENT DIVISION.
    SPECIAL-NAMES.
        POSIX STANDARD-1 NATIVE.

DATA DIVISION.
    COPY "ICEBERG-DATA-STRUCTURES.cpy".
    COPY "ICEBERG-TYPES.cpy".
    
    01 REWRITE-RESULT.
        02 TO-REWRITE PIC 9(18) USAGE IS COMP-5 OCCURS 0 TO 9999 TIMES DEPENDING ON TO-REWRITE-COUNT.
        02 TO-REWRITE-COUNT PIC 9(18) USAGE IS COMP-5.
        02 COPY-PLAN.
            03 SOURCE-PATH PIC X(256).
            03 TARGET-PATH PIC X(256).
    
    01 PROPERTIES-MAP.
        02 PROPERTY-COUNT PIC 9(18) USAGE IS COMP-5.
        02 PROPERTY-ENTRY OCCURS 0 TO 9999 TIMES DEPENDING ON PROPERTY-COUNT.
            03 PROPERTY-NAME PIC X(128).
            03 PROPERTY-VALUE PIC X(256).
    
    01 STATISTICS-FILES.
        02 FILE-COUNT PIC 9(18) USAGE IS COMP-5.
        02 STATISTICS-FILE OCCURS 0 TO 9999 TIMES DEPENDING ON FILE-COUNT.
            03 SNAPSHOT-ID PIC 9(18) USAGE IS COMP-5.
            03 FILE-PATH PIC X(256).
            03 FILE-SIZE PIC 9(18) USAGE IS COMP-5.
            03 FOOTER-SIZE PIC 9(18) USAGE IS COMP-5.
            03 BLOB-METADATA PIC X(1024).
    
    01 METADATA-LOG-ENTRIES.
        02 ENTRY-COUNT PIC 9(18) USAGE IS COMP-5.
        02 LOG-ENTRY OCCURS 0 TO 9999 TIMES DEPENDING ON ENTRY-COUNT.
            03 TIMESTAMP-MILLIS PIC 9(18) USAGE IS COMP-5.
            03 FILE-PATH PIC X(256).
    
    01 SNAPSHOTS.
        02 SNAPSHOT-COUNT PIC 9(18) USAGE IS COMP-5.
        02 SNAPSHOT OCCURS 0 TO 9999 TIMES DEPENDING ON SNAPSHOT-COUNT.
            03 SEQUENCE-NUMBER PIC 9(18) USAGE IS COMP-5.
            03 SNAPSHOT-ID PIC 9(18) USAGE IS COMP-5.
            03 PARENT-ID PIC 9(18) USAGE IS COMP-5.
            03 TIMESTAMP-MILLIS PIC 9(18) USAGE IS COMP-5.
            03 OPERATION PIC X(128).
            03 SUMMARY PIC X(256).
            03 SCHEMA-ID PIC 9(18) USAGE IS COMP-5.
            03 MANIFEST-LIST-LOCATION PIC X(256).
            03 FIRST-ROW-ID PIC 9(18) USAGE IS COMP-5.
            03 ADDED-ROWS PIC 9(18) USAGE IS COMP-5.
    
    01 MANIFEST-FILES.
        02 MANIFEST-COUNT PIC 9(18) USAGE IS COMP-5.
        02 MANIFEST-FILE OCCURS 0 TO 9999 TIMES DEPENDING ON MANIFEST-COUNT.
            03 PATH PIC X(256).
            03 PARTITION-SPEC-ID PIC 9(18) USAGE IS COMP-5.
            03 SNAPSHOT-ID PIC 9(18) USAGE IS COMP-5.
            03 ADDED-FILES-COUNT PIC 9(18) USAGE IS COMP-5.
            03 EXISTING-FILES-COUNT PIC 9(18) USAGE IS COMP-5.
            03 DELETED-FILES-COUNT PIC 9(18) USAGE IS COMP-5.
            03 ADDED-ROWS-COUNT PIC 9(18) USAGE IS COMP-5.
            03 EXISTING-ROWS-COUNT PIC 9(18) USAGE IS COMP-5.
            03 DELETED-ROWS-COUNT PIC 9(18) USAGE IS COMP-5.
            03 PARTITION-SUMMARY PIC X(256).
    
    01 DATA-FILES.
        02 FILE-COUNT PIC 9(18) USAGE IS COMP-5.
        02 DATA-FILE OCCURS 0 TO 9999 TIMES DEPENDING ON FILE-COUNT.
            03 PATH PIC X(256).
            03 PARTITION-TUPLE PIC X(256).
            03 RECORD-COUNT PIC 9(18) USAGE IS COMP-5.
            03 FILE-SIZE-IN-BYTES PIC 9(18) USAGE IS COMP-5.
            03 COLUMN-SIZES PIC 9(18) USAGE IS COMP-5 OCCURS 0 TO 9999 TIMES DEPENDING ON COLUMN-COUNT.
            03 COLUMN-COUNT PIC 9(18) USAGE IS COMP-5.
            03 ROW-GROUP-COUNT PIC 9(18) USAGE IS COMP-5.
            03 COLUMN-METRICS PIC X(1024) OCCURS 0 TO 9999 TIMES DEPENDING ON COLUMN-COUNT.
            03 KEY-METADATA PIC X(256).
            03 SPEC-ID PIC 9(18) USAGE IS COMP-5.
            03 SPLIT-OFFSETS PIC 9(18) USAGE IS COMP-5 OCCURS 0 TO 9999 TIMES DEPENDING ON SPLIT-OFFSET-COUNT.
            03 SPLIT-OFFSET-COUNT PIC 9(18) USAGE IS COMP-5.
            03 EQUALITY-IDS PIC 9(18) USAGE IS COMP-5 OCCURS 0 TO 9999 TIMES DEPENDING ON EQUALITY-ID-COUNT.
            03 EQUALITY-ID-COUNT PIC 9(18) USAGE IS COMP-5.
            03 PARTITION-ID PIC 9(18) USAGE IS COMP-5.
            03 RESIDUAL-PARTITION-TUPLE PIC X(256).
            
    01 DELETE-FILES.
        02 FILE-COUNT PIC 9(18) USAGE IS COMP-5.
        02 DELETE-FILE OCCURS 0 TO 9999 TIMES DEPENDING ON FILE-COUNT.
            03 PATH PIC X(256).
            03 PARTITION-TUPLE PIC X(256).
            03 RECORD-COUNT PIC 9(18) USAGE IS COMP-5.
            03 FILE-SIZE-IN-BYTES PIC 9(18) USAGE IS COMP-5.
            03 SPLIT-OFFSETS PIC 9(18) USAGE IS COMP-5 OCCURS 0 TO 9999 TIMES DEPENDING ON SPLIT-OFFSET-COUNT.
            03 SPLIT-OFFSET-COUNT PIC 9(18) USAGE IS COMP-5.
            03 EQUALITY-IDS PIC 9(18) USAGE IS COMP-5 OCCURS 0 TO 9999 TIMES DEPENDING ON EQUALITY-ID-COUNT.
            03 EQUALITY-ID-COUNT PIC 9(18) USAGE IS COMP-5.
            03 SPEC-ID PIC 9(18) USAGE IS COMP-5.
            03 CONTENT-TYPE PIC X(1).
            03 SNAPSHOT-ID PIC 9(18) USAGE IS COMP-5.
            03 DATA-SEQUENCE-NUMBER PIC 9(18) USAGE IS COMP-5.
            03 FILE-SEQUENCE-NUMBER PIC 9(18) USAGE IS COMP-5.
            
    01 POSITION-DELETE-RECORD.
        02 FILE-PATH PIC X(256).
        02 POSITION PIC 9(18) USAGE IS COMP-5.
        02 RECORD-DATA PIC X(1024).
        
PROCEDURE DIVISION.
    REPLACE-PATHS.
        MOVE METADATA-LOCATION TO NEW-LOCATION.
        MOVE UPDATED-SNAPSHOTS TO NEW-SNAPSHOTS.
        MOVE UPDATED-METADATA-LOG-ENTRIES TO NEW-METADATA-LOG-ENTRIES.
        MOVE CURRENT-SNAPSHOT-ID TO NEW-SNAPSHOT-ID.
        MOVE UPDATED-PROPERTIES TO NEW-PROPERTIES.
        
        CREATE NEW-TABLE-METADATA USING
            NEW-LOCATION,
            NEW-SNAPSHOTS, 
            NEW-METADATA-LOG-ENTRIES,
            NEW-SNAPSHOT-ID,
            NEW-PROPERTIES.
            
        RETURN NEW-TABLE-METADATA.
        
    REWRITE-MANIFEST-LIST.
        INITIALIZE REWRITE-RESULT.
        OPEN OUTPUT-FILE.
        
        PERFORM VARYING MANIFEST-FILE IN MANIFEST-FILES
            MOVE MANIFEST-FILE-PATH TO NEW-PATH
            WRITE MANIFEST-FILE TO OUTPUT-FILE
            
            IF MANIFEST-FILE-PATH IN MANIFESTS-TO-REWRITE
                ADD MANIFEST-FILE TO REWRITE-RESULT-TO-REWRITE
                ADD MANIFEST-FILE-PATH, NEW-PATH TO REWRITE-RESULT-COPY-PLAN
            END-IF
        END-PERFORM.
        
        CLOSE OUTPUT-FILE.
        RETURN REWRITE-RESULT.
        
    REWRITE-DATA-MANIFEST.
        INITIALIZE REWRITE-RESULT.
        OPEN OUTPUT-FILE.
        
        PERFORM VARYING DATA-FILE IN DATA-FILES
            MOVE DATA-FILE-PATH TO NEW-PATH
            WRITE DATA-FILE TO OUTPUT-FILE
            
            IF DATA-FILE-PATH IN MANIFESTS-TO-REWRITE
                ADD DATA-FILE TO REWRITE-RESULT-TO-REWRITE
                ADD DATA-FILE-PATH, NEW-PATH TO REWRITE-RESULT-COPY-PLAN
            END-IF
        END-PERFORM.
        
        CLOSE OUTPUT-FILE.
        RETURN REWRITE-RESULT.
        
    REWRITE-DELETE-MANIFEST.
        INITIALIZE REWRITE-RESULT.
        OPEN OUTPUT-FILE.
        
        PERFORM VARYING DELETE-FILE IN DELETE-FILES
            EVALUATE DELETE-FILE-CONTENT-TYPE
                WHEN "POSITION_DELETES"
                    MOVE DELETE-FILE-PATH TO NEW-PATH
                    WRITE DELETE-FILE TO OUTPUT-FILE
                    
                    IF DELETE-FILE-PATH IN MANIFESTS-TO-REWRITE
                        ADD DELETE-FILE TO REWRITE-RESULT-TO-REWRITE
                        ADD STAGING-PATH, NEW-PATH TO REWRITE-RESULT-COPY-PLAN
                    END-IF
                    
                WHEN "EQUALITY_DELETES"
                    WRITE NEW-EQUALITY-DELETE-FILE TO OUTPUT-FILE
                    
                    IF DELETE-FILE-PATH IN MANIFESTS-TO-REWRITE
                        ADD DELETE-FILE-PATH, NEW-FILE-PATH TO REWRITE-RESULT-COPY-PLAN
                    END-IF
                    
                WHEN OTHER
                    RAISE UNSUPPORTED-OPERATION-EXCEPTION
            END-EVALUATE
        END-PERFORM.
        
        CLOSE OUTPUT-FILE.
        RETURN REWRITE-RESULT.
        
    REWRITE-POSITION-DELETE-FILE.
        OPEN INPUT-FILE USING DELETE-FILE-PATH.
        OPEN OUTPUT-FILE.
        
        READ INPUT-FILE INTO POSITION-DELETE-RECORD
            MOVE POSITION-DELETE-RECORD-FILE-PATH TO NEW-PATH
            WRITE NEW-POSITION-DELETE-RECORD TO OUTPUT-FILE
        END-READ.
        
        CLOSE INPUT-FILE.
        CLOSE OUTPUT-FILE.
        
    COMBINE-PATHS.
        CONCATENATE TARGET-PREFIX, RELATIVE-PATH INTO NEW-PATH.
        
    RELATIVIZE-PATH.
        MOVE SOURCE-PREFIX TO REMOVE-PREFIX.
        IF PATH NOT STARTS WITH REMOVE-PREFIX
            RAISE ILLEGAL-ARGUMENT-EXCEPTION
        END-IF.
        MOVE PATH (LENGTH OF REMOVE-PREFIX + 1) TO END TO RELATIVE-PATH.
        
    STAGING-PATH.
        CONCATENATE STAGING-DIR, FILE-NAME(ORIGINAL-PATH) INTO STAGING-PATH.

COPY "ICEBERG-COMMON-ROUTINES.cpy".
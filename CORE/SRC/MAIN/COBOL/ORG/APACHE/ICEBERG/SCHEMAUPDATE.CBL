IDENTIFICATION DIVISION.
PROGRAM-ID. SCHEMA-UPDATE.

ENVIRONMENT DIVISION.

DATA DIVISION.
  01 TABLE-OPERATIONS PIC X(30).
  01 TABLE-METADATA PIC X(30).
  01 SCHEMA PIC X(30).
  01 ID-TO-PARENT PIC 9(9) OCCURS 30.
  01 DELETES PIC 9(9) OCCURS 30.
  01 UPDATES.
     02 FIELD-ID PIC 9(9) OCCURS 30.
     02 NESTED-FIELD PIC X(30) OCCURS 30.
  01 PARENT-TO-ADDED-IDS.
     02 PARENT-ID PIC 9(9) OCCURS 30.
     02 ADDED-ID PIC 9(9) OCCURS 30.
  01 ADDED-NAME-TO-ID.
     02 ADDED-NAME PIC X(30) OCCURS 30.
     02 ADDED-ID PIC 9(9) OCCURS 30.
  01 MOVES.
     02 PARENT-ID PIC 9(9) OCCURS 30.
     02 MOVE-TYPE PIC X(10) OCCURS 30.
     02 FIELD-ID PIC 9(9) OCCURS 30.
     02 REFERENCE-FIELD-ID PIC 9(9) OCCURS 30.
  01 LAST-COLUMN-ID PIC 9(9).
  01 ALLOW-INCOMPATIBLE-CHANGES PIC X.
  01 IDENTIFIER-FIELD-NAMES PIC X(30) OCCURS 30.
  01 CASE-SENSITIVE PIC X.

PROCEDURE DIVISION.
  PERFORM INIT-SCHEMA-UPDATE.
  PERFORM APPLY-CHANGES.
  PERFORM COMMIT-CHANGES.
  STOP RUN.

INIT-SCHEMA-UPDATE.
  MOVE FUNCTION WHEN-COMPILED TO LAST-COLUMN-ID.
  MOVE "Y" TO CASE-SENSITIVE.

APPLY-CHANGES.
  PERFORM APPLY-ADDS.
  PERFORM APPLY-DELETES.
  PERFORM APPLY-UPDATES.
  PERFORM APPLY-MOVES.
  PERFORM APPLY-IDENTIFIER-FIELDS.

APPLY-ADDS.
  PERFORM VARYING I FROM 1 BY 1 UNTIL I > 30
    IF PARENT-TO-ADDED-IDS(I, 1) NOT = 0
      PERFORM ADD-COLUMN
        USING PARENT-TO-ADDED-IDS(I, 1),
              ADDED-NAME(I),
              ADDED-ID(I),
              NESTED-FIELD(ADDED-ID(I)),
              LAST-COLUMN-ID
      ADD 1 TO LAST-COLUMN-ID
    END-IF
  END-PERFORM.

ADD-COLUMN.
  PERFORM VALIDATE-ADD-COLUMN
    USING PARENT-ID, ADDED-NAME, ADDED-ID, NESTED-FIELD, ALLOW-INCOMPATIBLE-CHANGES.
  MOVE ADDED-ID TO ID-TO-PARENT(ADDED-ID).
  MOVE ADDED-NAME TO ADDED-NAME-TO-ID(ADDED-ID).
  MOVE NESTED-FIELD TO UPDATES(ADDED-ID).

APPLY-DELETES.
  PERFORM VARYING I FROM 1 BY 1 UNTIL I > 30
    IF DELETES(I) NOT = 0
      PERFORM DELETE-COLUMN USING DELETES(I)
    END-IF
  END-PERFORM.

DELETE-COLUMN.
  PERFORM VALIDATE-DELETE-COLUMN USING FIELD-ID.
  MOVE FIELD-ID TO DELETES(DELETES-IDX).
  ADD 1 TO DELETES-IDX.

APPLY-UPDATES.
  PERFORM VARYING I FROM 1 BY 1 UNTIL I > 30
    IF FIELD-ID(I) NOT = 0
      PERFORM UPDATE-COLUMN USING FIELD-ID(I), NESTED-FIELD(I)
    END-IF
  END-PERFORM.

UPDATE-COLUMN.
  PERFORM VALIDATE-UPDATE-COLUMN USING FIELD-ID, NESTED-FIELD.
  MOVE NESTED-FIELD TO UPDATES(FIELD-ID).

APPLY-MOVES.
  PERFORM VARYING I FROM 1 BY 1 UNTIL I > 30
    IF PARENT-ID(I) NOT = 0
      PERFORM MOVE-COLUMN USING PARENT-ID(I), MOVE-TYPE(I), FIELD-ID(I), REFERENCE-FIELD-ID(I)
    END-IF
  END-PERFORM.

MOVE-COLUMN.
  PERFORM VALIDATE-MOVE-COLUMN USING PARENT-ID, MOVE-TYPE, FIELD-ID, REFERENCE-FIELD-ID.
  MOVE FIELD-ID TO MOVES(PARENT-ID, 1, FIELD-ID).
  MOVE MOVE-TYPE TO MOVES(PARENT-ID, 2, FIELD-ID).
  MOVE REFERENCE-FIELD-ID TO MOVES(PARENT-ID, 3, FIELD-ID).

APPLY-IDENTIFIER-FIELDS.
  PERFORM VARYING I FROM 1 BY 1 UNTIL I > 30
    IF IDENTIFIER-FIELD-NAMES(I) NOT = SPACES
      PERFORM VALIDATE-IDENTIFIER-FIELD USING IDENTIFIER-FIELD-NAMES(I)
    END-IF
  END-PERFORM.

VALIDATE-ADD-COLUMN.
  PERFORM CHECK-PARENT-FIELD USING PARENT-ID, ADDED-NAME, NESTED-FIELD, ALLOW-INCOMPATIBLE-CHANGES.
  PERFORM CHECK-DUPLICATE-NAME USING PARENT-ID, ADDED-NAME.

VALIDATE-DELETE-COLUMN.
  PERFORM CHECK-ADDED-COLUMNS USING FIELD-ID.
  PERFORM CHECK-UPDATED-COLUMNS USING FIELD-ID.

VALIDATE-UPDATE-COLUMN.
  PERFORM CHECK-DELETED-COLUMN USING FIELD-ID.
  PERFORM CHECK-TYPE-PROMOTION USING FIELD-ID, NESTED-FIELD.

VALIDATE-MOVE-COLUMN.
  PERFORM CHECK-PARENT-STRUCT USING PARENT-ID, FIELD-ID, REFERENCE-FIELD-ID, MOVE-TYPE.
  PERFORM CHECK-DELETED-COLUMN USING FIELD-ID.

VALIDATE-IDENTIFIER-FIELD.
  PERFORM CHECK-IDENTIFIER-FIELD-EXISTS USING IDENTIFIER-FIELD-NAMES.
  PERFORM CHECK-IDENTIFIER-FIELD-DELETIONS USING IDENTIFIER-FIELD-NAMES, DELETES.

COMMIT-CHANGES.
  PERFORM UPDATE-TABLE-METADATA USING TABLE-OPERATIONS, TABLE-METADATA, SCHEMA, LAST-COLUMN-ID.

STOP RUN.
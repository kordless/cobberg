IDENTIFICATION DIVISION.
PROGRAM-ID. BASE-SNAPSHOT.

ENVIRONMENT DIVISION.
INPUT-OUTPUT SECTION.
FILE-CONTROL.
    SELECT MANIFEST-FILE
        ASSIGN TO DISPLAY.
    SELECT MANIFEST-LIST
        ASSIGN TO DISPLAY.

DATA DIVISION.
FILE SECTION.
FD MANIFEST-FILE.
01 MANIFEST-FILE-RECORD PIC X(1024).

FD MANIFEST-LIST.
01 MANIFEST-LIST-RECORD PIC X(1024).

WORKING-STORAGE SECTION.
01 SNAPSHOT-RECORD.
    05 SEQUENCE-NUMBER PIC 9(18).
    05 SNAPSHOT-ID PIC 9(18).
    05 PARENT-ID PIC 9(18).
    05 TIMESTAMP-MILLIS PIC 9(18).
    05 OPERATION PIC X(256).
    05 SUMMARY PIC X(1024).
    05 SCHEMA-ID PIC 9(5).
    05 MANIFEST-LIST-LOCATION PIC X(256).
    05 V1-MANIFEST-LOCATIONS OCCURS 20 TIMES PIC X(256).
    05 FIRST-ROW-ID PIC 9(18).
    05 ADDED-ROWS PIC 9(18).

01 ALL-MANIFESTS PIC X(1024) OCCURS 20 TIMES.
01 DATA-MANIFESTS PIC X(1024) OCCURS 20 TIMES.
01 DELETE-MANIFESTS PIC X(1024) OCCURS 20 TIMES.
01 ADDED-DATA-FILES PIC X(1024) OCCURS 20 TIMES.
01 REMOVED-DATA-FILES PIC X(1024) OCCURS 20 TIMES.
01 ADDED-DELETE-FILES PIC X(1024) OCCURS 20 TIMES.
01 REMOVED-DELETE-FILES PIC X(1024) OCCURS 20 TIMES.

PROCEDURE DIVISION.
MAIN-PROCEDURE.
    PERFORM CACHE-MANIFESTS.
    PERFORM CACHE-DATA-FILE-CHANGES.
    PERFORM CACHE-DELETE-FILE-CHANGES.

    STOP RUN.

CACHE-MANIFESTS.
    MOVE MANIFEST-LIST-LOCATION TO MANIFEST-LIST-RECORD.
    OPEN INPUT MANIFEST-LIST.
    READ MANIFEST-LIST INTO ALL-MANIFESTS.
    CLOSE MANIFEST-LIST.

    PERFORM VARYING I FROM 1 BY 1 UNTIL I > 20
        EVALUATE ALL-MANIFESTS(I)
            WHEN CONTENT = 'DATA'
                MOVE ALL-MANIFESTS(I) TO DATA-MANIFESTS(I)
            WHEN CONTENT = 'DELETES'
                MOVE ALL-MANIFESTS(I) TO DELETE-MANIFESTS(I)
        END-EVALUATE
    END-PERFORM.

CACHE-DATA-FILE-CHANGES.
    PERFORM VARYING I FROM 1 BY 1 UNTIL I > 20
        MOVE DATA-MANIFESTS(I) TO MANIFEST-FILE-RECORD
        OPEN INPUT MANIFEST-FILE
        READ MANIFEST-FILE INTO ADDED-DATA-FILES(I)
            AT END EXIT PERFORM
        END-READ
        CLOSE MANIFEST-FILE
    END-PERFORM.

CACHE-DELETE-FILE-CHANGES.
    PERFORM VARYING I FROM 1 BY 1 UNTIL I > 20
        MOVE DELETE-MANIFESTS(I) TO MANIFEST-FILE-RECORD
        OPEN INPUT MANIFEST-FILE
        READ MANIFEST-FILE INTO ADDED-DELETE-FILES(I)
            AT END EXIT PERFORM
        END-READ
        CLOSE MANIFEST-FILE
    END-PERFORM.
IDENTIFICATION DIVISION.
PROGRAM-ID. DYNFIELDS.

ENVIRONMENT DIVISION.
INPUT-OUTPUT SECTION.

DATA DIVISION.
WORKING-STORAGE SECTION.
01 WS-FIELD-CLASS-NAME PIC X(256).
01 WS-FIELD-NAME PIC X(256).
01 WS-CANDIDATES PIC X(256) OCCURS 1 TO 999 DEPENDING ON WS-CANDIDATES-COUNT.
01 WS-CANDIDATES-COUNT PIC 9(3) VALUE 0.
01 WS-ALWAYS-NULL-FLAG PIC X VALUE 'N'.

01 WS-UNBOUNDFIELD.
   05 WS-FIELD PIC X(8) VALUE SPACES.
   05 WS-FIELD-NAME PIC X(256) VALUE SPACES.

01 WS-BOUNDFIELD.
   05 WS-UNBOUND-FIELD PIC X(8) VALUE SPACES.
   05 WS-TARGET PIC X(8) VALUE SPACES.

01 WS-STATICFIELD.
   05 WS-UNBOUND-FIELD PIC X(8) VALUE SPACES.

PROCEDURE DIVISION.

DYNFIELDS-MAIN.
    PERFORM DYNFIELDS-NEW.

DYNFIELDS-NEW.
    MOVE FUNCTION THREAD-ID TO WS-FIELD.
    MOVE "AlwaysNull" TO WS-FIELD-NAME.
    MOVE "Y" TO WS-ALWAYS-NULL-FLAG.

DYNFIELDS-BUILD-CHECKED.
    IF WS-ALWAYS-NULL-FLAG = 'Y'
        MOVE WS-FIELD TO WS-UNBOUNDFIELD
        MOVE WS-FIELD-NAME TO WS-UNBOUNDFIELD-NAME
    ELSE
        PERFORM VARYING I FROM 1 BY 1 UNTIL I > WS-CANDIDATES-COUNT
            MOVE WS-CANDIDATES(I) TO WS-FIELD-CLASS-NAME
            PERFORM DYNFIELDS-IMPL
        END-PERFORM
        IF WS-FIELD IS NOT EQUAL TO SPACES
            MOVE WS-FIELD TO WS-UNBOUNDFIELD
            MOVE WS-FIELD-NAME TO WS-UNBOUNDFIELD-NAME
        ELSE
            MOVE WS-FIELD TO WS-UNBOUNDFIELD
            MOVE "AlwaysNull" TO WS-UNBOUNDFIELD-NAME
            MOVE "Y" TO WS-ALWAYS-NULL-FLAG
        END-IF
    END-IF.

DYNFIELDS-IMPL.
    PERFORM VARY I FROM 1 BY 1 UNTIL I > LENGTH OF WS-FIELD-CLASS-NAME
        IF WS-FIELD-CLASS-NAME(I:1) = '.'
            MOVE WS-FIELD-CLASS-NAME(1:I-1) TO WS-FIELD-CLASS-NAME
            MOVE WS-FIELD-CLASS-NAME(I+1:) TO WS-FIELD-NAME
            PERFORM DYNFIELDS-IMPL-CLASS
            GOTO DYNFIELDS-IMPL-EXIT
        END-IF
    END-PERFORM.
    MOVE WS-FIELD-CLASS-NAME TO WS-FIELD-CLASS-NAME
    MOVE SPACES TO WS-FIELD-NAME.
    PERFORM DYNFIELDS-IMPL-CLASS.

DYNFIELDS-IMPL-CLASS.
    PERFORM DYNFIELDS-HIDDEN-IMPL.
    IF WS-FIELD IS EQUAL TO SPACES
        ADD 1 TO WS-CANDIDATES-COUNT
        MOVE WS-FIELD-CLASS-NAME TO WS-CANDIDATES(WS-CANDIDATES-COUNT)
        MOVE WS-FIELD-NAME TO WS-CANDIDATES(WS-CANDIDATES-COUNT)
    END-IF.

DYNFIELDS-HIDDEN-IMPL.
    MOVE WS-FIELD-CLASS-NAME TO WS-CLASS-NAME.
    MOVE WS-FIELD-NAME TO WS-FIELD-NAME.
    CALL "GETFIELDACCESSIBLE" USING WS-CLASS-NAME, WS-FIELD-NAME, WS-FIELD, WS-FIELD-NAME.

DYNFIELDS-IMPL-EXIT.
    EXIT.

DYNFIELDS-BUILD.
    PERFORM DYNFIELDS-BUILD-CHECKED.
    IF WS-ALWAYS-NULL-FLAG = 'Y'
        MOVE WS-UNBOUNDFIELD TO WS-UNBOUND-FIELD
        MOVE WS-UNBOUNDFIELD-NAME TO WS-UNBOUND-FIELD-NAME
    ELSE
        MOVE WS-UNBOUNDFIELD TO WS-UNBOUND-FIELD
        MOVE WS-UNBOUNDFIELD-NAME TO WS-UNBOUND-FIELD-NAME
    END-IF.

DYNFIELDS-BUILD-BOUND.
    MOVE FUNCTION THREAD-ID TO WS-TARGET.
    MOVE WS-UNBOUND-FIELD TO WS-BOUND-FIELD.
    MOVE WS-TARGET TO WS-BOUND-FIELD-TARGET.

DYNFIELDS-BUILD-STATIC.
    MOVE WS-UNBOUND-FIELD TO WS-STATIC-FIELD.

STOP RUN.